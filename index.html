<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Styling untuk Kolom Kiri */
    #sidebar-image {
        /* Anda bisa ganti 'dajal.jpeg' dengan gambar latar belakang lain */
        background-image: url('dajal.jpeg'); 
        background-size: cover; 
        background-position: center;
        background-repeat: no-repeat;
    }
    /* Untuk memastikan form container memiliki padding dan background */
    .form-container {
        background-color: white;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen p-4">
  
  <div class="flex w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden min-h-[500px]">
    
    <div id="sidebar-image" class="hidden md:block md:w-8/12 p-8 relative">
        <div class="absolute inset-0 bg-blue-900 bg-opacity-70 flex flex-col justify-center items-center p-8">
            <h1 class="text-4xl font-extrabold text-white mb-4 text-center">Selamat Datang di Portal Akademik FT</h1>
            <p class="text-white text-lg text-center">Sistem manajemen jadwal kuliah terintegrasi dan modern.</p>
        </div>
    </div>

    <div class="w-full md:w-4/12 p-10 flex flex-col justify-center form-container">
      <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center" id="form-title">Login Admin</h2>
      
      <form id="auth-form" class="space-y-4">
        
        <div id="username-field" class="space-y-1">
            <label for="username" class="text-sm font-medium text-gray-700">Username</label>
            <input type="text" id="username" placeholder="Masukkan username Anda" required 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="space-y-1">
            <label for="password" class="text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="password" placeholder="********" required 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
        
        <button type="submit" id="main-btn" onclick="login(event)" 
                class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">
          Login
        </button>
      </form>

      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Belum punya akun? 
          <a href="#" id="toggle-auth" onclick="toggleAuth()" class="text-blue-600 font-semibold hover:text-blue-700">
            Daftar
          </a>
        </p>
      </div>

    </div>
  </div>

<script>
    // --- Inisialisasi Supabase (PASTIKAN KEY INI SAMA DENGAN FILE LAIN) ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o"; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isLoginMode = true;

    function toggleAuth() {
        isLoginMode = !isLoginMode;
        const formTitle = document.getElementById('form-title');
        const mainBtn = document.getElementById('main-btn');
        const toggleAuthLink = document.getElementById('toggle-auth');
        const usernameField = document.getElementById('username-field');

        if (isLoginMode) {
            formTitle.textContent = 'Login Admin';
            mainBtn.textContent = 'Login';
            mainBtn.setAttribute('onclick', 'login(event)');
            toggleAuthLink.textContent = 'Daftar';
        } else {
            formTitle.textContent = 'Registrasi Admin Baru';
            mainBtn.textContent = 'Daftar Sekarang';
            mainBtn.setAttribute('onclick', 'register(event)');
            toggleAuthLink.textContent = 'Login';
        }
    }

    // --- FUNGSI LOGIN ---
    async function login(event) {
        event.preventDefault(); 
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !password) {
            alert("Harap isi semua kolom.");
            return;
        }

        // Supabase Auth menggunakan format email: username@akademikft.com
        const authEmail = `${username}@akademikft.com`;

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                email: authEmail, 
                password 
            });

            if (error) {
                alert("❌ Login gagal: " + error.message);
                console.error(error);
                return;
            }

            alert("✅ Login Berhasil!");
            // Redirect ke DASHBOARD.HTML
            window.location.href = "dashboard.html";
            
        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan koneksi.");
        }
    }

    // --- FUNGSI REGISTER ---
    async function register(event) {
        event.preventDefault(); 
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !password) {
            alert("Harap isi semua kolom.");
            return;
        }

        if (username.length < 3 || password.length < 6) {
            alert("Username minimal 3 karakter dan Password minimal 6 karakter.");
            return;
        }

        // 1. Buat email dummy yang unik
        const authEmail = `${username}@akademikft.com`;


        try {
            // 2. Daftar di Supabase Auth menggunakan email dummy yang unik
            const { data, error } = await supabaseClient.auth.signUp(
              { email: authEmail, password }
            );

            if (error) {
                alert("❌ Gagal membuat akun: " + error.message);
                console.error(error);
                return;
            }
            
            // 3. Simpan username ke tabel 'users_metadata'
            if (data.user) {
                const emailToSave = authEmail; 

                const { error: metadataError } = await supabaseClient
                    .from('users_metadata')
                    .insert([{ user_id: data.user.id, email: emailToSave, username: username }]);
                
                if (metadataError) {
                    console.error("Gagal menyimpan metadata:", metadataError);
                }
            }


            alert("✅ Akun berhasil dibuat! Anda akan langsung masuk ke sistem.");
            // Redirect ke DASHBOARD.HTML
            window.location.href = "dashboard.html";
        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan koneksi ke Supabase.");
        }
    }

    // --- CEK LOGIN SAAT MASUK HALAMAN ---
    window.onload = async () => {
      const { data } = await supabaseClient.auth.getUser();
      if (data?.user) {
        // Redirect ke DASHBOARD.HTML jika sudah login
        window.location.href = "dashboard.html";
      }
    };

</script>
</body>
</html>
