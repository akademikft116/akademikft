<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Styling untuk Kolom Kiri */
    #sidebar-image {
        background-image: url('dajal.jpeg'); */
        background-color: #1e3a8a; /* Default: Warna Biru Tua Solid */
        background-size: cover; 
        background-position: center;
        background-repeat: no-repeat;
    }
    
    /* Untuk memastikan form container memiliki padding dan background */
    .form-container {
        background-color: white;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen p-4">
  
  <div class="flex w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden min-h-[500px]">
    
    <div id="sidebar-image" class="hidden md:block md:w-8/12 p-8 relative">
        <div class="absolute inset-0 bg-blue-900 bg-opacity-70 flex flex-col justify-center items-center p-8">
            <h1 class="text-4xl font-extrabold text-white text-center mb-4">FAKULTAS TEKNIK</h1>
            <p class="text-xl text-white text-center font-light">Sistem Informasi Jadwal Kuliah</p>
        </div>
    </div>

    <div class="w-full md:w-4/12 p-8 md:p-10 form-container flex flex-col justify-center">

        <h1 id="form-title" class="text-2xl font-bold text-center mb-6 text-blue-600">MASUK</h1>

        <div id="loginForm">
            <div class="mb-4">
                <label for="loginCredential" class="block text-sm font-medium text-gray-700">Email atau Username</label>
                <input id="loginCredential" type="text" placeholder="Masukkan email atau username" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="mb-6 relative">
                <label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input id="loginPassword" type="password" placeholder="Masukkan password" class="mt-1 w-full border border-gray-300 p-2 rounded-lg pr-10 focus:ring-blue-500 focus:border-blue-500">
                <button type="button" onclick="togglePasswordVisibility('loginPassword')" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                    <svg id="eyeIconLogin" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/></svg>
                </button>
            </div>

            <button onclick="login()" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition duration-150">
                Masuk
            </button>
            
            <p class="text-center text-sm mt-4">
                Belum punya akun? <a href="#" onclick="showRegister()" class="text-blue-600 hover:text-blue-800 font-medium">Daftar sekarang</a>
            </p>
        </div>

        <div id="registerForm" class="hidden">
            <div class="mb-4">
                <label for="registerUsername" class="block text-sm font-medium text-gray-700">Username</label>
                <input id="registerUsername" type="text" placeholder="Buat username unik" class="mt-1 w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <div class="mb-4">
                <label for="registerPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input id="registerPassword" type="password" placeholder="Buat password" class="mt-1 w-full border border-gray-300 p-2 rounded-lg pr-10 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <button onclick="register()" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition duration-150">
                Daftar
            </button>

            <p class="text-center text-sm mt-4">
                Sudah punya akun? <a href="#" onclick="showLogin()" class="text-blue-600 hover:text-blue-800 font-medium">Masuk</a>
            </p>
        </div>

    </div>
  </div>

<script>
    // --- Inisialisasi Supabase ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // --- Fungsi Utilitas UI ---
    function showLogin() {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        document.getElementById('form-title').textContent = 'MASUK';
    }

    function showRegister() {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
        document.getElementById('form-title').textContent = 'DAFTAR';
    }

    function togglePasswordVisibility(inputFieldId) {
        const passwordField = document.getElementById(inputFieldId);
        const eyeIcon = document.getElementById('eyeIcon' + (inputFieldId === 'loginPassword' ? 'Login' : 'Register'));

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            // Ubah ikon di sini jika perlu
        } else {
            passwordField.type = 'password';
            // Ubah ikon di sini jika perlu
        }
    }


    // --- Login (Menangani Email/Username) ---
    async function login() {
        const credential = document.getElementById("loginCredential").value.trim();
        const password = document.getElementById("loginPassword").value;
        
        if (!credential || !password) {
            alert("❌ Harap isi Email/Username dan Password.");
            return;
        }

        let authEmail = credential;

        if (!credential.includes('@')) {
            // Jika input dianggap username, cari email Supabase-nya
            const { data: userData, error: userError } = await supabaseClient
                .from('users_metadata')
                .select('email')
                .eq('username', credential)
                .single();

            if (userError || !userData) {
                alert("❌ Login gagal: Username atau Password salah.");
                return;
            }
            authEmail = userData.email;
        }
        
        // Coba login dengan email (asli atau dari metadata)
        const { error: loginError } = await supabaseClient.auth.signInWithPassword({ 
            email: authEmail, 
            password: password 
        });

        if (loginError) {
            alert("❌ Login gagal: Email/Username atau Password salah.");
            console.error(loginError);
        } else {
            window.location.href = "main.html";
        }
    }


    // --- Registrasi (Menggunakan Username dan Email Dummy) ---
    async function register() {
        const username = document.getElementById("registerUsername").value.trim();
        const password = document.getElementById("registerPassword").value;
        
        if (!username || !password) {
            alert("❌ Harap isi Username dan Password.");
            return;
        }
        
        if (password.length < 6) {
            alert("❌ Password minimal 6 karakter.");
            return;
        }
        
        // 1. Cek apakah username sudah ada di tabel users_metadata
        const { data: existingUser, error: checkError } = await supabaseClient
          .from('users_metadata')
          .select('username')
          .eq('username', username);

        if (checkError) {
            console.error("Error cek username:", checkError);
            alert("❌ Terjadi kesalahan saat memverifikasi username.");
            return;
        }

        if (existingUser && existingUser.length > 0) {
            alert("❌ Username ini sudah digunakan. Silakan pilih username lain.");
            return;
        }
        
        // 2. Buat email dummy yang unik
        const authEmail = `${username}@akademikft.com`;


        try {
            // 3. Daftar di Supabase Auth menggunakan email dummy yang unik
            const { data, error } = await supabaseClient.auth.signUp(
              { email: authEmail, password }
            );

            if (error) {
                alert("❌ Gagal membuat akun: " + error.message);
                console.error(error);
                return;
            }
            
            // 4. Simpan username ke tabel 'users_metadata'
            if (data.user) {
                const emailToSave = authEmail; 

                const { error: metadataError } = await supabaseClient
                    .from('users_metadata')
                    .insert([{ user_id: data.user.id, email: emailToSave, username: username }]);
                
                if (metadataError) {
                    console.error("Gagal menyimpan metadata:", metadataError);
                }
            }


            alert("✅ Akun berhasil dibuat! Anda akan langsung masuk ke sistem.");
            window.location.href = "main.html";
        } catch (err) {
            console.error(err);
            alert("Terjadi kesalahan koneksi ke Supabase.");
        }
    }

    // --- CEK LOGIN SAAT MASUK HALAMAN ---
    window.onload = async () => {
      const { data } = await supabaseClient.auth.getUser();
      if (data?.user) {
        window.location.href = "main.html";
      }
    };

</script>
</body>
</html>
