<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white shadow-lg rounded-xl p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-6">üìö Manajemen Jadwal Kuliah</h1>

    <div id="loginForm">
      <h2 class="text-lg font-semibold mb-2">Masuk</h2>
      <input id="loginCredential" type="text" placeholder="Email atau Username" class="w-full border p-2 rounded mb-2">
      
      <div class="relative mb-4">
        <input id="loginPassword" type="password" placeholder="Password" class="w-full border p-2 rounded pr-10">
        <button type="button" onclick="togglePasswordVisibility('loginPassword')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
          <svg id="eyeIconLogin" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.879 16.121A4.965 4.965 0 0112 15c1.482 0 2.903.486 4.075 1.325m-6.198 2.504A12.062 12.062 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .385-.027.765-.08 1.14"></path>
          </svg>
        </button>
      </div>

      <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
      <p class="text-sm mt-3 text-center">
        Belum punya akun? <a href="#" onclick="showRegister()" class="text-blue-600 font-semibold">Daftar</a>
      </p>
    </div>

    <div id="registerForm" class="hidden">
      <h2 class="text-lg font-semibold mb-2">Daftar Akun Baru</h2>
      
      <input id="regEmail" type="email" placeholder="Email (Opsional)" class="w-full border p-2 rounded mb-2">
      <input id="regUsername" type="text" placeholder="Username (Wajib Diisi)" class="w-full border p-2 rounded mb-2">
      
      <div class="relative mb-4">
        <input id="regPassword" type="password" placeholder="Password (min 6 karakter, Wajib Diisi)" class="w-full border p-2 rounded pr-10">
        <button type="button" onclick="togglePasswordVisibility('regPassword')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
          <svg id="eyeIconRegister" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.879 16.121A4.965 4.965 0 0112 15c1.482 0 2.903.486 4.075 1.325m-6.198 2.504A12.062 12.062 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .385-.027.765-.08 1.14"></path>
          </svg>
        </button>
      </div>
      
      <button onclick="registerUser()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Daftar</button>
      <p class="text-sm mt-3 text-center">
        Sudah punya akun? <a href="#" onclick="showLogin()" class="text-blue-600 font-semibold">Login</a>
      </p>
    </div>
  </div>

  <script>
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- FORM GANTI LOGIN/REGISTER ---
    function showRegister() {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("registerForm").classList.remove("hidden");
    }
    function showLogin() {
      document.getElementById("registerForm").classList.add("hidden");
      document.getElementById("loginForm").classList.remove("hidden");
    }

    // --- FITUR LIHAT KATA SANDI ---
    function togglePasswordVisibility(id) {
        const passwordInput = document.getElementById(id);
        const eyeIcon = id === 'loginPassword' ? document.getElementById('eyeIconLogin') : document.getElementById('eyeIconRegister');

        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            // Ganti ikon menjadi mata terbuka
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>';
        } else {
            passwordInput.type = "password";
            // Ganti ikon menjadi mata tertutup
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.879 16.121A4.965 4.965 0 0112 15c1.482 0 2.903.486 4.075 1.325m-6.198 2.504A12.062 12.062 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .385-.027.765-.08 1.14"></path>';
        }
    }

    // --- LOGIN (Mendukung Email atau Username) ---
    async function login() {
      const credential = document.getElementById("loginCredential").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      if (!credential || !password) {
        alert("Email/Username dan password wajib diisi!");
        return;
      }
      
      let emailToLogin = credential;
      
      // Jika kredensial terlihat seperti username (tidak ada '@')
      if (!credential.includes('@')) {
          // 1. Cari email di tabel metadata berdasarkan username
          const { data: userData, error: metadataError } = await supabaseClient
              .from('users_metadata')
              .select('email')
              .eq('username', credential)
              .single();
              
          if (metadataError || !userData) {
              alert("‚ùå Login gagal: Username tidak ditemukan atau terjadi kesalahan.");
              console.error(metadataError);
              return;
          }
          
          // 2. Gunakan email yang tersimpan (asli atau dummy)
          emailToLogin = userData.email;

          // Pengecekan keamanan untuk akun lama:
          if (!emailToLogin) {
              alert("‚ùå Login gagal: Data akun Anda tidak lengkap (email kosong). Silakan daftar ulang menggunakan username yang sama atau hubungi admin.");
              return;
          }
      }

      // Lakukan proses login menggunakan email yang sudah ditentukan (asli, atau email dari users_metadata)
      const { error } = await supabaseClient.auth.signInWithPassword({ email: emailToLogin, password });

      if (error) {
        alert("‚ùå Login gagal: Password atau kredensial salah.");
        console.error(error);
      } else {
        alert("‚úÖ Login berhasil!");
        window.location.href = "main.html";
      }
    }

    // --- REGISTER (Email Tidak Wajib Diisi) ---
    async function registerUser() {
      const originalEmail = document.getElementById("regEmail").value.trim();
      const username = document.getElementById("regUsername").value.trim();
      const password = document.getElementById("regPassword").value.trim();

      if (!username || !password) {
        alert("Username dan password wajib diisi!");
        return;
      }
      if (password.length < 6) {
        alert("Password minimal 6 karakter!");
        return;
      }
      
      // 1. Tentukan email yang akan digunakan untuk Supabase Auth (wajib ada)
      let authEmail = originalEmail;
      
      if (!originalEmail) {
          // Jika email kosong, buat email dummy yang unik untuk Supabase Auth
          const cleanUsername = username.toLowerCase().replace(/[^a-z0-9]/g, '');
          authEmail = `${cleanUsername}-${Date.now()}@tempuser.id`; 
      }
      
      // 2. Cek apakah username sudah ada di tabel metadata
      const { data: existingUser, error: checkError } = await supabaseClient
          .from('users_metadata')
          .select('id')
          .eq('username', username);
          
      if (checkError) {
          console.error(checkError);
          alert("Gagal cek username.");
          return;
      }
      if (existingUser && existingUser.length > 0) {
          alert("‚ùå Username ini sudah digunakan. Silakan pilih username lain.");
          return;
      }


      try {
        // 3. Daftar di Supabase Auth menggunakan email (asli atau dummy)
        const { data, error } = await supabaseClient.auth.signUp(
          { email: authEmail, password }
        );

        if (error) {
          alert("‚ùå Gagal membuat akun: " + error.message);
          console.error(error);
          return;
        }
        
        // 4. Simpan username ke tabel 'users_metadata' (SEKARANG SELALU SIMPAN EMAIL AUTH)
        if (data.user) {
            const emailToSave = authEmail; // Simpan email AUTH (asli atau dummy)

            const { error: metadataError } = await supabaseClient
                .from('users_metadata')
                .insert([{ user_id: data.user.id, email: emailToSave, username: username }]);
            
            if (metadataError) {
                console.error("Gagal menyimpan metadata:", metadataError);
            }
        }


        alert("‚úÖ Akun berhasil dibuat! Anda akan langsung masuk ke sistem.");
        window.location.href = "main.html";
      } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan koneksi ke Supabase.");
      }
    }

    // --- CEK LOGIN SAAT MASUK HALAMAN ---
    window.onload = async () => {
      const { data } = await supabaseClient.auth.getUser();
      if (data?.user) {
        window.location.href = "main.html";
      }
    };
  </script>
</body>
</html>
