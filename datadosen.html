<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodata & Pencarian Dosen - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* STYLE UNTUK MEMASTIKAN LAYOUT FULL-SCREEN SEPERTI DASHBOARD */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    .main-content {
        height: calc(100vh - 4rem); /* 100vh minus tinggi header/navbar */
    }
    .container {
        max-width: 1300px;
        margin: auto;
    }
    /* Style untuk Tom Select agar sesuai dengan input Tailwind */
    .ts-wrapper.form-control, .ts-control {
        border-radius: 0.25rem !important;
        border: 1px solid #d1d5db !important;
    }
    .modal {
        transition: opacity 0.3s ease-out;
    }
    .modal-active {
        opacity: 1;
    }
    /* Tambahkan style untuk menyembunyikan form saat tidak dibutuhkan */
    #dosen-container.hidden {
        display: none;
    }
    #dosen-list-container.hidden {
        display: none;
    }
    /* Styling khusus untuk tombol tab */
    .tab-button {
        transition: all 0.15s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
        <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
        <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
    </div>
    <div class="flex items-center space-x-4">
        <span id="userNameNav" class="text-white text-sm">Halo, Pengguna</span>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-150">
            <i class="fas fa-sign-out-alt mr-1"></i> Ganti Akun
        </button>
    </div>
</nav>

<div class="flex pt-16 main-content">

    <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 z-0 shadow-xl">
        <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
            <a href="dashboard.html" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                <i class="fas fa-tachometer-alt w-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="main.html" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                <i class="fas fa-calendar-alt w-5"></i>
                <span>Penjadwalan</span>
            </a>
            
            <a href="mahasiswa.html" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                <i class="fas fa-address-card w-5"></i>
                <span>Biodata Mahasiswa</span>
            </a>
            
            <a href="dosen.html" class="active-link w-full text-left flex items-center space-x-3 p-3 rounded-lg transition duration-150">
                <i class="fas fa-user-tie w-5"></i>
                <span>Data Dosen</span>
            </a>
            <a href="dashboard.html#matkul" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                <i class="fas fa-book w-5"></i>
                <span>Data Mata Kuliah</span>
            </a>
            <a href="dashboard.html#pengaturan" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                <i class="fas fa-cog w-5"></i>
                <span>Pengaturan</span>
            </a>
        </nav>

        <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
            <p>&copy; 2024 Akademik FT</p>
            <p>Designed by Rifqi & Alfi</p>
        </div>
    </aside>


    <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100 h-full">
        <div class="container mx-auto p-0">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Manajemen Biodata & Pencarian Dosen</h1>

            <div id="dosen-container" class="bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="formTitle">Tambah Data Dosen Baru</h2>
                <form id="dosenForm" onsubmit="event.preventDefault(); saveDosen();">
                    
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button type="button" id="tab-akademik" onclick="switchTab('akademik')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                                <i class="fas fa-user-graduate mr-2"></i> Data Akademik & Identitas
                            </button>
                            <button type="button" id="tab-personal" onclick="switchTab('personal')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-id-card mr-2"></i> Data Personal & Keluarga
                            </button>
                        </nav>
                    </div>

                    <div id="content-akademik" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="nidn" class="block text-sm font-medium text-gray-700">NIDN/NIP <span class="text-red-500">*</span></label>
                                <input type="text" id="nidn" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap & Gelar <span class="text-red-500">*</span></label>
                                <input type="text" id="nama" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="jabatan" class="block text-sm font-medium text-gray-700">Jabatan Fungsional <span class="text-red-500">*</span></label>
                                <select id="jabatan" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="">Pilih Jabatan</option>
                                    <option value="Asisten Ahli">Asisten Ahli</option>
                                    <option value="Lektor">Lektor</option>
                                    <option value="Lektor Kepala">Lektor Kepala</option>
                                    <option value="Guru Besar">Guru Besar</option>
                                    <option value="Tenaga Pengajar">Tenaga Pengajar</option>
                                </select>
                            </div>
        
                            <div>
                                <label for="unitKerja" class="block text-sm font-medium text-gray-700">Unit Kerja/Prodi</label>
                                <select id="unitKerja" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="">Pilih Unit Kerja</option>
                                    <option value="Industri">Teknik Industri</option>
                                    <option value="Sipil">Teknik Sipil</option>
                                    <option value="Informatika">Teknik Informatika</option>
                                    <option value="Arsitektur">Arsitektur</option>
                                    <option value="Umum">Umum/Fakultas</option>
                                </select>
                            </div>
                            <div>
                                <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin <span class="text-red-500">*</span></label>
                                <select id="jenisKelamin" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="">Pilih J. Kelamin</option>
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label for="tahunMasuk" class="block text-sm font-medium text-gray-700">Tahun Mulai Mengajar <span class="text-red-500">*</span></label>
                                <select id="tahunMasuk" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="">Pilih Tahun</option>
                                </select>
                            </div>

                            <div>
                                <label for="nik" class="block text-sm font-medium text-gray-700">NIK Dosen</label>
                                <input type="text" id="nik" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="nohp" class="block text-sm font-medium text-gray-700">No. HP/Kontak</label>
                                <input type="text" id="nohp" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-700">Status Dosen <span class="text-red-500">*</span></label>
                                <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="Aktif">Aktif</option>
                                    <option value="Cuti">Cuti</option>
                                    <option value="Nonaktif">Nonaktif</option>
                                    <option value="Pensiun">Pensiun</option>
                                    <option value="Meninggal">Meninggal Dunia</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="pendidikanTerakhir" class="block text-sm font-medium text-gray-700">Pendidikan Terakhir</label>
                                <input type="text" id="pendidikanTerakhir" placeholder="Contoh: S3 Teknik Sipil" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div></div> 
                            <div></div> 

                        </div>
                        
                        <div class="mt-4">
                            <label for="bidangKeahlian" class="block text-sm font-medium text-gray-700">Bidang Keahlian/Fokus (Opsional)</label>
                            <input type="text" id="bidangKeahlian" placeholder="Contoh: Struktur Beton Bertulang" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                    </div>

                    <div id="content-personal" class="tab-content hidden">
                        <p class="text-sm text-gray-600 mb-4">Lengkapi data personal dan keluarga (dapat dikosongkan).</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="namaPasangan" class="block text-sm font-medium text-gray-700">Nama Pasangan</label>
                                <input type="text" id="namaPasangan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="jumlahAnak" class="block text-sm font-medium text-gray-700">Jumlah Anak</label>
                                <input type="number" id="jumlahAnak" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="ttl" class="block text-sm font-medium text-gray-700">TTL</label>
                                <input type="text" id="ttl" placeholder="Contoh: Jakarta, 01-01-1980" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>

                            <div>
                                <label for="kelurahan" class="block text-sm font-medium text-gray-700">Kelurahan</label>
                                <input type="text" id="kelurahan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="kecamatan" class="block text-sm font-medium text-gray-700">Kecamatan</label>
                                <input type="text" id="kecamatan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div></div>
                        </div>

                        <div class="mt-4">
                            <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat Lengkap (Jalan, RT/RW)</label>
                            <textarea id="alamat" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                        </div>
                    </div>


                    <input type="hidden" id="dosenId" value="">
                    <div class="mt-6 pt-4 border-t flex space-x-3 justify-end">
                        <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-save mr-2"></i> Simpan Data
                        </button>
                        <button type="button" onclick="resetForm()" id="reset-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-times mr-2"></i> Batalkan & Tutup
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="dosen-list-container" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Daftar Dosen</h2>
                
                <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                    <h3 class="text-lg font-medium mb-3 text-gray-700"><i class="fas fa-filter mr-2"></i> Filter Pencarian</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="searchNama" class="block text-sm font-medium text-gray-700">Nama</label>
                            <input type="text" id="searchNama" placeholder="Ketik Nama Dosen" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="searchNidn" class="block text-sm font-medium text-gray-700">NIDN/NIP</label>
                            <input type="text" id="searchNidn" placeholder="Ketik NIDN/NIP" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="searchTahun" class="block text-sm font-medium text-gray-700">Tahun Mulai Mengajar</label>
                            <select id="searchTahun" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Semua Tahun</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="performSearch()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 flex-grow">
                                <i class="fas fa-search mr-1"></i> Cari
                            </button>
                            <button onclick="resetSearch()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <button onclick="downloadTemplate()"
                           class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 cursor-pointer text-sm">
                           <i class="fas fa-download mr-2"></i> Download Template
                        </button>
                        
                        <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
                        <label for="excelFileInput" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 cursor-pointer text-sm">
                            <i class="fas fa-file-excel mr-2"></i> Import File
                        </label>
                        <span id="importStatus" class="text-sm text-gray-600"></span>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                        <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-file-pdf mr-2"></i> Export PDF
                        </button>
                        <button onclick="showForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-plus-circle mr-2"></i> Tambah Data Dosen
                        </button>
                    </div>
                </div>


                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIDN/NIP</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama & Gelar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Kerja</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun Mulai</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="dosen-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

</div>


<div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">Detail Biodata Dosen</h3>
        <div id="modalContent" class="text-sm space-y-2">
            </div>
        <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Tutup</button>
    </div>
</div>


<script>
    // Konfigurasi Supabase
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // NAMA TABEL UNTUK DOSEN
    const DOSEN_TABLE_NAME = 'dosen'; 

    let isEditMode = false;
    let currentDosenId = null;
    let currentDosenData = []; // Global variable for current table data
    
    let jabatanSelect;
    let unitKerjaSelect;
    let tahunMasukSelect;
    let searchTahunSelect; 
    let statusSelect; 

    document.addEventListener('DOMContentLoaded', () => {
        // Inisialisasi Tom Select untuk Form Tambah/Edit
        jabatanSelect = new TomSelect("#jabatan", { create: false });
        unitKerjaSelect = new TomSelect("#unitKerja", { create: false });
        tahunMasukSelect = new TomSelect("#tahunMasuk", { create: false });
        statusSelect = new TomSelect("#status", { create: false }); 
        
        // Memuat tahun dari 1980 sampai tahun sekarang
        populateYearSelect(tahunMasukSelect); 
        
        // Inisialisasi Tom Select untuk Pencarian
        searchTahunSelect = new TomSelect("#searchTahun", { 
            create: false,
            placeholder: "Pilih Tahun",
        });
        populateYearSelect(searchTahunSelect, true); 
    });

    // --- FUNGSI BANTUAN TAMPILAN ---

    function hideForm() {
        document.getElementById('dosen-container').classList.add('hidden');
    }

    function showList() {
        document.getElementById('dosen-list-container').classList.remove('hidden');
    }
    
    function hideList() {
        document.getElementById('dosen-list-container').classList.add('hidden');
    }


    // Fungsi untuk menampilkan form Tambah/Edit dan melakukan reset
    function showForm() {
        resetForm(); 
        hideList(); 
        document.getElementById('dosen-container').classList.remove('hidden');
        document.getElementById('dosen-container').scrollIntoView({ behavior: 'smooth' });
        switchTab('akademik');
    }

    // Fungsi untuk menyembunyikan form (Dipanggil saat Batal atau Selesai Simpan)
    function hideFormAndShowList() {
        document.getElementById('dosen-container').classList.add('hidden');
        showList(); 
        document.getElementById('dosen-list-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Fungsi Reset Form
    function resetForm() {
        document.getElementById('dosenForm').reset();
        jabatanSelect.clear();
        unitKerjaSelect.clear();
        tahunMasukSelect.clear();
        document.getElementById('jenisKelamin').value = ''; 
        statusSelect.setValue('Aktif'); 
        isEditMode = false;
        currentDosenId = null;
        document.getElementById('formTitle').textContent = 'Tambah Data Dosen Baru';
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i> Simpan Data';
        document.getElementById('dosenId').value = '';
        
        hideFormAndShowList(); 
    }


    // --- FUNGSI BANTUAN DATA ---

    function populateYearSelect(selectInstance, includeAllOption = false) {
        selectInstance.clear(true); 

        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i >= 1980; i--) { // Mulai dari 1980 untuk dosen
            selectInstance.addOption({ value: i, text: i });
        }
        
        if(includeAllOption) {
            selectInstance.addOption({ value: '', text: 'Semua Tahun' });
        }
        
        selectInstance.refreshOptions(false);
        if(includeAllOption) {
             selectInstance.setValue('');
        } else if (selectInstance.options.length > 0) {
            selectInstance.setValue(currentYear);
        }
    }
    
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }
    
    // Fungsi untuk mengelola perpindahan tab di formulir
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('text-blue-600', 'border-blue-600');
            button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });

        document.getElementById(`content-${tabName}`).classList.remove('hidden');

        const activeBtn = document.getElementById(`tab-${tabName}`);
        activeBtn.classList.add('text-blue-600', 'border-blue-600');
        activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    }


    // --- FUNGSI PENCARIAN ---
    function performSearch() {
        const searchNama = document.getElementById('searchNama').value.trim();
        const searchNidn = document.getElementById('searchNidn').value.trim();
        const searchTahun = searchTahunSelect.getValue(); 

        loadDosenData({ nama: searchNama, nidn: searchNidn, tahun: searchTahun });
    }

    function resetSearch() {
        document.getElementById('searchNama').value = '';
        document.getElementById('searchNidn').value = '';
        searchTahunSelect.setValue(''); 
        loadDosenData(); 
    }

    // --- FUNGSI DOWNLOAD TEMPLATE EXCEL ---
    function downloadTemplate() {
        // Kolom sesuai data Dosen
        const headers = [
            "NIDN_NIP", "NAMA_GELAR", "NIK", "TTL", "NO_HP", "ALAMAT", 
            "KELURAHAN", "KECAMATAN", "NAMA_PASANGAN", "JUMLAH_ANAK", 
            "PENDIDIKAN_TERAKHIR", "BIDANG_KEAHLIAN",
            // Kolom wajib di database:
            "JABATAN_FUNGSIONAL", "UNIT_KERJA", "JENIS_KELAMIN", "TAHUN_MULAI", "STATUS" 
        ];
        
        const wsData = [
            headers,
            // Baris contoh untuk panduan (pastikan kolom wajib terisi)
            ["1234567890123456", "Dr. Contoh Dosen, S.T., M.T.", "3210123456789012", "Bandung, 01-01-1980", "081234567890", "Jl. Contoh No. 1", "Kelurahan Contoh", "Kecamatan Contoh", "Nama Pasangan", "2", "S3 Teknik Mesin", "Termodinamika", "Lektor", "Industri", "Laki-laki", 2005, "Aktif"]
        ];

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // Sesuaikan lebar kolom
        ws['!cols'] = [
            { wch: 20 }, { wch: 40 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, 
            { wch: 40 }, { wch: 20 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, 
            { wch: 25 }, { wch: 40 }, 
            { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 10 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, "BiodataDosen");
        XLSX.writeFile(wb, "dosen_template_ft.xlsx");
    }

    // --- FUNGSI IMPORT EXCEL ---
    async function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const importStatus = document.getElementById('importStatus');
        importStatus.textContent = 'Membaca file...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                let excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (excelData.length < 2) {
                    importStatus.textContent = '❌ File Excel kosong atau hanya berisi header.';
                    return;
                }

                const headers = excelData[0].map(h => String(h).trim().toUpperCase().replace(/[\s\W]+/g, '_').replace(/^_|_$/g, ''));
                const rawData = excelData.slice(1);
                
                // Peta kolom Supabase untuk Dosen (Perlu disesuaikan dengan skema tabel 'dosen' Anda)
                const columnMapping = {
                    'NIDN_NIP': 'nidn_nip',
                    'NAMA_GELAR': 'nama',
                    'JABATAN_FUNGSIONAL': 'jabatan_fungsional',
                    'UNIT_KERJA': 'unit_kerja',
                    'JENIS_KELAMIN': 'jenis_kelamin', 
                    'TAHUN_MULAI': 'tahun_mulai',
                    'STATUS': 'status',
                    'NIK': 'nik_dosen', 
                    'NO_HP': 'no_hp',
                    'PENDIDIKAN_TERAKHIR': 'pendidikan_terakhir', 
                    'BIDANG_KEAHLIAN': 'bidang_keahlian',
                    'NAMA_PASANGAN': 'nama_pasangan',
                    'JUMLAH_ANAK': 'jumlah_anak',
                    'TTL': 'ttl',
                    'ALAMAT': 'alamat',
                    'KELURAHAN': 'kelurahan',
                    'KECAMATAN': 'kecamatan',
                };

                const dosenToInsert = [];
                
                for (const row of rawData) {
                    let dosen = {};
                    let isValidRow = true;
                    
                    for (let i = 0; i < headers.length; i++) {
                        const excelHeader = headers[i];
                        const supabaseColumn = columnMapping[excelHeader];
                        
                        if (supabaseColumn) {
                             let value = row[i] === undefined ? null : row[i];
                             
                             if (supabaseColumn === 'tahun_mulai' || supabaseColumn === 'jumlah_anak') {
                                 if (typeof value === 'number') {
                                     value = Math.floor(value);
                                 } else {
                                     value = parseInt(String(value).trim()) || null;
                                 }
                             } else if (value !== null) {
                                 value = String(value).trim() || null;
                             }
                             
                             dosen[supabaseColumn] = value;
                        }
                    }
                    
                    // Validasi minimal (kolom wajib)
                    if (!dosen.nidn_nip || !dosen.nama || !dosen.jabatan_fungsional || !dosen.unit_kerja || !dosen.jenis_kelamin || !dosen.tahun_mulai) {
                         console.warn('Baris diabaikan karena data wajib tidak lengkap (NIDN/NIP, Nama, Jabatan, Unit Kerja, Jenis Kelamin, Tahun Mulai):', dosen);
                         isValidRow = false; 
                    }
                    
                    // Set default jika kosong
                    dosen.status = dosen.status || 'Aktif'; 


                    if (isValidRow) {
                        dosenToInsert.push(dosen);
                    }
                }
                
                if (dosenToInsert.length === 0) {
                    importStatus.textContent = '❌ Tidak ada data dosen valid yang ditemukan untuk diimpor. Pastikan kolom wajib terisi.';
                    return;
                }

                importStatus.textContent = `Menemukan ${dosenToInsert.length} data valid. Menyimpan ke database...`;

                const { error: insertError } = await supabaseClient
                    .from(DOSEN_TABLE_NAME)
                    .upsert(dosenToInsert, { onConflict: 'nidn_nip' }); // Asumsi 'nidn_nip' adalah unique key

                if (insertError) {
                    alert('❌ Gagal mengimpor data. Pesan: ' + insertError.message);
                    importStatus.textContent = '❌ Import Gagal. Cek Konsol untuk detail error.';
                    console.error(insertError);
                } else {
                    alert(`✅ Import Sukses! ${dosenToInsert.length} data dosen berhasil disimpan/diperbarui.`);
                    importStatus.textContent = `✅ Import Sukses. ${dosenToInsert.length} data disimpan/diperbarui.`;
                    loadDosenData(); 
                }


            } catch (err) {
                console.error('Error saat memproses file Excel:', err);
                importStatus.textContent = '❌ Terjadi kesalahan saat memproses file. Pastikan format file .xlsx/.xls benar.';
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }


    // --- FUNGSI EXPORT DATA ---
    
    // 1. Export ke Excel
    function exportToExcel() {
        if (currentDosenData.length === 0) {
            alert('❌ Tidak ada data dosen yang tersedia untuk diekspor. Silakan cari data terlebih dahulu.');
            return;
        }

        // Kolom sesuai urutan template dosen
        const headers = [
            "NIDN/NIP", "NAMA & GELAR", "NIK", "TTL", "NO. HP", "ALAMAT", 
            "KELURAHAN", "KECAMATAN", "NAMA PASANGAN", "JUMLAH ANAK", 
            "PENDIDIKAN TERAKHIR", "BIDANG KEAHLIAN",
            // Kolom Tambahan/Wajib Database
            "JABATAN FUNGSIONAL", "UNIT KERJA", "JENIS KELAMIN", "TAHUN MULAI", "STATUS"
        ];
        
        const dataForExport = currentDosenData.map(dosen => [
            // 12 KOLOM TEMPLATE UTAMA
            dosen.nidn_nip,
            dosen.nama,
            dosen.nik_dosen || '-', 
            dosen.ttl || '-', 
            dosen.no_hp || '-', 
            dosen.alamat || '-', 
            dosen.kelurahan || '-', 
            dosen.kecamatan || '-', 
            dosen.nama_pasangan || '-', 
            dosen.jumlah_anak || 0, 
            dosen.pendidikan_terakhir || '-', 
            dosen.bidang_keahlian || '-', 
            // KOLOM TAMBAHAN/WAJIB DATABASE
            dosen.jabatan_fungsional,
            dosen.unit_kerja,
            dosen.jenis_kelamin || '-',
            dosen.tahun_mulai,
            dosen.status
        ]);

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(dataForExport, { header: headers, skipHeader: true }); 

        const title = ["DATA BIODATA DOSEN FAKULTAS TEKNIK"];
        
        XLSX.utils.sheet_add_aoa(ws, [title], { origin: "A1" });
        XLSX.utils.sheet_add_aoa(ws, [headers], { origin: "A2" }); 
        XLSX.utils.sheet_add_aoa(ws, dataForExport, { origin: "A3" });

        if (ws['A1']) {
            const range = XLSX.utils.decode_range(ws['!ref']);
            range.e.c = headers.length - 1; 
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];
            ws['A1'].s = { 
                font: { bold: true, sz: 14 },
                alignment: { horizontal: 'center' }
            };
        }

        XLSX.utils.book_append_sheet(wb, ws, "DataDosenFT");
        XLSX.writeFile(wb, "data_dosen_ft.xlsx");
    }
    
    // 2. Export ke PDF
    function exportToPDF() {
        if (currentDosenData.length === 0) {
            alert('❌ Tidak ada data dosen yang tersedia untuk diekspor. Silakan cari data terlebih dahulu.');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape'); 

        // Header Tabel PDF (Menggunakan 12 kolom template utama)
        const head = [[
            'NIDN/NIP', 'NAMA & GELAR', 'NIK', 'TTL', 'NO. HP', 'ALAMAT', 
            'KELURAHAN', 'KECAMATAN', 'NAMA PASANGAN', 'JML ANAK', 
            'PEND. TERAKHIR', 'BIDANG KEAHLIAN'
        ]];
        
        // Body Tabel PDF (Mengikuti urutan header)
        const body = currentDosenData.map(dosen => [
            dosen.nidn_nip,
            dosen.nama,
            dosen.nik_dosen || '-',
            dosen.ttl || '-',
            dosen.no_hp || '-',
            dosen.alamat || '-',
            dosen.kelurahan || '-',
            dosen.kecamatan || '-',
            dosen.nama_pasangan || '-',
            dosen.jumlah_anak || 0,
            dosen.pendidikan_terakhir || '-',
            dosen.bidang_keahlian || '-'
        ]);
        
        const date = new Date().toLocaleDateString('id-ID');
        
        doc.setFontSize(14);
        doc.text("Data Dosen Fakultas Teknik (Export PDF)", 14, 15);
        doc.setFontSize(10);
        doc.text(`Tanggal Export: ${date}`, 14, 20);

        doc.autoTable({
            head: head,
            body: body,
            startY: 25,
            theme: 'grid',
            styles: { fontSize: 7, cellPadding: 1, halign: 'center' }, 
            columnStyles: {
                0: { cellWidth: 15 }, // NIDN/NIP
                1: { halign: 'left', cellWidth: 35 }, // NAMA
                2: { cellWidth: 15 }, // NIK
                3: { cellWidth: 20 }, // TTL
                4: { cellWidth: 15 }, // NO_HP
                5: { halign: 'left', cellWidth: 30
