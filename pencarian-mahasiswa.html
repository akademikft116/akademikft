<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pencarian Mahasiswa - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Styling untuk menandai menu aktif di sidebar (DISALIN DARI dashboard.html) */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    .header-style {
        background-color: #1e3a8a; 
    }
    .main-content {
        padding-top: 5rem; 
        min-height: 100vh;
        background-color: #f3f4f6;
    }
    .container {
        max-width: 1300px;
        margin: auto;
    }
    /* Style untuk Tom Select agar sesuai dengan input Tailwind */
    .ts-wrapper.form-control, .ts-control {
        border-radius: 0.25rem !important;
        border: 1px solid #d1d5db !important;
    }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
        <img src="logo.jpeg" alt="Logo" class="h-10 w-10">
        <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
    </div>
    <div class="flex items-center space-x-4">
        <span id="userNameNav" class="text-white text-sm">Halo, Pengguna</span>
        <button onclick="logout()" class="text-white hover:text-red-300 transition duration-150">
            <i class="fas fa-sign-out-alt mr-1"></i> Logout
        </button>
    </div>
</nav>

<aside class="w-64 fixed top-16 left-0 h-[calc(100vh-4rem)] bg-gray-900 text-white z-20 overflow-y-auto">
    <nav class="flex flex-col p-4 space-y-2">
        <a href="dashboard.html" class="flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
        </a>
        <a href="main.html" class="flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-calendar-alt w-6"></i><span class="ml-3">Penjadwalan</span>
        </a>
        
        <a href="mahasiswa.html" class="flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-user-graduate w-6"></i><span class="ml-3">Biodata Mahasiswa</span>
        </a>

        <a href="pencarian-mahasiswa.html" class="active-link flex items-center p-4 text-sm font-medium text-gray-300 transition duration-150">
            <i class="fas fa-search w-6"></i><span class="ml-3">Pencarian Mahasiswa</span>
        </a>
        
        <div onclick="showContent('dosenContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-chalkboard-teacher w-6"></i><span class="ml-3">Data Dosen</span>
        </div>
        <div onclick="showContent('matakuliahContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-book w-6"></i><span class="ml-3">Data Mata Kuliah</span>
        </div>
        <div onclick="showContent('settingsContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-cog w-6"></i><span class="ml-3">Pengaturan</span>
        </div>
    </nav>
</aside>
<main class="main-content pt-20 ml-64">
    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Pencarian Data Mahasiswa</h1>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filter Pencarian</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="filter-npm-nama" class="block text-sm font-medium text-gray-700">NPM / Nama</label>
                    <input type="text" id="filter-npm-nama" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik NPM atau Nama">
                </div>
                <div>
                    <label for="filter-prodi-cari" class="block text-sm font-medium text-gray-700">Program Studi</label>
                    <select id="filter-prodi-cari" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Semua Prodi</option>
                        <option value="Industri">Teknik Industri</option>
                        <option value="Sipil">Teknik Sipil</option>
                        <option value="Informatika">Teknik Informatika</option>
                        <option value="Arsitektur">Arsitektur</option>
                    </select>
                </div>
                <div>
                    <label for="filter-tahun-cari" class="block text-sm font-medium text-gray-700">Tahun Masuk</label>
                    <select id="filter-tahun-cari" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Semua Tahun</option>
                        </select>
                </div>
                <div class="flex items-end">
                    <button onclick="performSearch()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                        <i class="fas fa-search mr-2"></i> Cari Data
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Hasil Mahasiswa</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NPM</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prodi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun Masuk</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="search-table-body">
                        <tr><td colspan="7" class="text-center py-4 text-gray-500">Silakan gunakan filter di atas untuk memulai pencarian.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</main>

<script>
    // Konfigurasi Supabase (Harus sama dengan file lain Anda)
    // GUNAKAN KODE SUPABASE ANDA SENDIRI
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- FUNGSI UTAMA PENCARIAN ---
    async function performSearch() {
        const npmNama = document.getElementById('filter-npm-nama').value.toLowerCase();
        const prodi = document.getElementById('filter-prodi-cari').value;
        const tahunMasuk = document.getElementById('filter-tahun-cari').value;
        const tableBody = document.getElementById('search-table-body');
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Mencari data...</td></tr>';

        let query = supabaseClient
            .from('mahasiswa')
            .select('*'); 

        // Filter berdasarkan Prodi
        if (prodi) {
            query = query.eq('prodi', prodi);
        }

        // Filter berdasarkan Tahun Masuk
        if (tahunMasuk) {
            query = query.eq('tahun_masuk', parseInt(tahunMasuk));
        }

        // Filter berdasarkan NPM atau Nama (pencarian teks bebas)
        if (npmNama) {
            // Gunakan .or() untuk mencari di dua kolom
            query = query.or(`npm.ilike.%${npmNama}%,nama.ilike.%${npmNama}%`);
        }

        // Eksekusi Query
        const { data: mahasiswaData, error } = await query;

        if (error) {
            console.error('Error saat pencarian:', error);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">‚ùå Gagal memuat data: ${error.message}</td></tr>`;
            return;
        }

        // Render Hasil
        tableBody.innerHTML = ''; // Kosongkan
        if (mahasiswaData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data mahasiswa yang ditemukan.</td></tr>';
            return;
        }

        mahasiswaData.forEach(mhs => {
            const statusBadge = mhs.status === 'Aktif' 
                ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Aktif</span>'
                : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Nonaktif</span>';

            const row = `
                <tr class="hover:bg-gray-100 transition duration-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${mhs.npm}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.prodi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${mhs.semester}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${mhs.tahun_masuk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="alert('Detail Mahasiswa ID: ${mhs.id}')" class="text-blue-600 hover:text-blue-900 transition duration-150">Lihat Detail</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // --- FUNGSI BANTUAN & AUTHENTIKASI ---
    
    // Mengisi dropdown Tahun Masuk (dari 2018 hingga tahun sekarang)
    function populateYearSelect() {
        const currentYear = new Date().getFullYear();
        const select = document.getElementById('filter-tahun-cari');
        for (let i = currentYear; i >= 2018; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            select.appendChild(option);
        }
    }
    
    // Fungsi Logout (disalin dari dashboard.html)
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // Cek sesi login saat halaman dimuat
    async function checkAuthAndLoad() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        // Memuat username ke navbar
        const { data: userData, error } = await supabaseClient
            .from('users_metadata')
            .select('username')
            .eq('user_id', user.id)
            .single();

        if (userData) {
            document.getElementById('userNameNav').textContent = `Halo, ${userData.username}`;
        }

        populateYearSelect();
        // Pencarian tidak otomatis dilakukan, user harus klik tombol Cari.
    }
    
    // Fungsi ini diperlukan untuk tautan Dosen/Mata Kuliah di sidebar, meskipun tidak ada konten dinamis di halaman ini.
    function showContent(contentId) {
        // Karena ini adalah halaman mandiri, fungsi ini hanya mengarahkan kembali ke dashboard jika diperlukan
        if (contentId === 'dosenContent' || contentId === 'matakuliahContent' || contentId === 'settingsContent') {
             window.location.href = `dashboard.html#${contentId}`; 
        }
    }

    window.onload = checkAuthAndLoad;
</script>
</body>
</html>
