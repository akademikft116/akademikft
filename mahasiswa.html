<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodata & Pencarian Mahasiswa - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* CSS untuk konsistensi layout dengan Dashboard */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    .main-content {
        height: calc(100vh - 4rem); /* 100vh minus tinggi header/navbar */
    }
    /* Style untuk baris tabel (sesuai kebutuhan Anda) */
    .row-A { background-color: #eff6ff; }
    .row-B { background-color: #fffbeb; }
    .row-C { background-color: #f0fdf4; }
    .icon-btn { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-20 flex items-center justify-between px-6">
        <div class="flex items-center space-x-3">
            <img src="logo.jpeg" class="h-10 w-auto"> 
            <h1 class="text-xl font-bold text-white">DASHBOARD AKADEMIK FT</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span id="userNameNav" class="text-white font-semibold">Memuat...</span>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-150">
                <i class="fas fa-sign-out-alt"></i> Ganti Akun
            </button>
        </div>
    </nav>
    
    <div class="flex pt-16 main-content">
        
        <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 z-10 shadow-xl">
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                
                <a href="dashboard.html" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="main.html" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-calendar-alt w-5"></i>
                    <span>Penjadwalan</span>
                </a>

                <a href="mahasiswa.html" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg active-link">
                    <i class="fas fa-user-graduate w-5"></i>
                    <span>Data Mahasiswa</span>
                </a>
                
                <a href="dashboard.html#dosen" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-chalkboard-teacher w-5"></i>
                    <span>Dosen</span>
                </a>
                
                <a href="dashboard.html#matkul" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-book-open w-5"></i>
                    <span>Mata Kuliah</span>
                </a>

                <a href="dashboard.html#settings" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-cog w-5"></i>
                    <span>Pengaturan</span>
                </a>
                
            </nav>
            
            <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
                <p>&copy; 2025 Akademik FT</p>
                <p>Designed by Rifqi & Alfi</p>
                <p>ABD</p>
            </div>
        </aside>
        
        <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100 h-full">
            
            <div class="bg-white p-6 rounded-lg shadow-xl min-h-full">
                <h1 class="text-2xl font-bold mb-4">Biodata & Pencarian Data Mahasiswa</h1>
                
                <div class="mb-6 flex items-center space-x-3 flex-wrap">
                    <select id="filterProdi" class="border p-2 rounded min-w-min">
                        <option value="">Semua Prodi</option>
                        <option value="Industri">Industri</option>
                        <option value="Sipil">Sipil</option>
                        <option value="Arsitektur">Arsitektur</option>
                        <option value="Elektro">Elektro</option>
                        <option value="Informatika">Informatika</option>
                    </select>
                    <select id="filterKelas" class="border p-2 rounded min-w-min">
                        <option value="">Semua Kelas</option>
                    </select>
                    <select id="filterAngkatan" class="border p-2 rounded min-w-min">
                        <option value="">Semua Angkatan</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Cari Nama/NIM..." class="border p-2 rounded flex-grow max-w-sm">
                    
                    <button onclick="loadMahasiswa()" class="bg-blue-500 hover:bg-blue-600 text-white rounded icon-btn transition duration-150" title="Terapkan Filter & Cari">
                        <i class="fas fa-magnifying-glass"></i> 
                    </button>
                    <button onclick="exportExcel()" class="bg-green-500 hover:bg-green-600 text-white rounded icon-btn transition duration-150" title="Export ke Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    <button onclick="exportPDF()" class="bg-red-500 hover:bg-red-600 text-white rounded icon-btn transition duration-150" title="Export ke PDF">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="tabelMahasiswa" class="min-w-full border border-gray-400 text-sm">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border px-2 py-1 text-center">No</th>
                                <th class="border px-2 py-1 text-center">NIM</th>
                                <th class="border px-2 py-1 text-left">Nama</th>
                                <th class="border px-2 py-1 text-left">Prodi</th>
                                <th class="border px-2 py-1 text-center">Kelas</th>
                                <th class="border px-2 py-1 text-center">Angkatan</th>
                                <th class="border px-2 py-1 text-center">Status</th>
                                <th class="border px-2 py-1 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

            </div>
            
        </main>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-blue-800">Detail Mahasiswa: <span id="modalNama"></span></h2>
                    <button onclick="document.getElementById('detailModal').classList.add('hidden');" class="text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div id="modalContent" class="text-gray-700 text-sm space-y-1">
                    </div>

                <div class="flex justify-end space-x-2 mt-6">
                    <button type="button" onclick="document.getElementById('detailModal').classList.add('hidden');" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition duration-150">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
    </div>

    <script>
        // --- Supabase setup ---
        const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let semuaData = []; 
        let dataYangDitampilkan = [];
        let tsFilterKelas;

        // Fungsi Toast Notification
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let baseClasses = "p-4 rounded-lg shadow-xl text-white transition-all duration-500 transform min-w-min";
            let icon = '';

            if (type === 'success') {
                baseClasses += " bg-green-500";
                icon = '✅';
            } else if (type === 'error') {
                baseClasses += " bg-red-600";
                icon = '❌';
            } else if (type === 'info') {
                baseClasses += " bg-blue-500";
                icon = 'ℹ️';
            } else if (type === 'warning') {
                baseClasses += " bg-yellow-500 text-gray-800";
                icon = '⚠️';
            }

            toast.className = baseClasses + " opacity-0 translate-y-2";
            toast.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
            
            container.appendChild(toast);

            // Show animation
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            // Auto-hide and remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                
                setTimeout(() => {
                    if(container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 500); 
            }, 3000); 
        }

        // --- FUNGSI Memuat referensi untuk filter ---
        async function loadReferences() {
            const { data: refData, error: refError } = await supabaseClient
                .from('referensi')
                .select('kunci, nilai')
                .in('kunci', ['kelas', 'angkatan']);

            if (refError) {
                console.error("Gagal memuat referensi:", refError);
                return;
            }

            const kelasOptions = refData.filter(r => r.kunci === 'kelas').map(r => r.nilai).sort();
            const angkatanOptions = refData.filter(r => r.kunci === 'angkatan').map(r => r.nilai).sort((a, b) => b - a);

            populateSelect('filterKelas', kelasOptions, 'Semua Kelas', true);
            populateSelect('filterAngkatan', angkatanOptions, 'Semua Angkatan', true);
        }
        
        // Fungsi pembantu untuk mengisi <select>
        function populateSelect(selectId, optionsArray, defaultText, includeAll = false) {
            const select = document.getElementById(selectId);
            if (!select) return;

            select.innerHTML = '';
            
            let initialOptions = [];
            if (includeAll) {
                 initialOptions.push(`<option value="">${defaultText}</option>`);
            } else {
                 initialOptions.push(`<option value="" disabled selected>${defaultText}</option>`);
            }

            const optionHtml = optionsArray.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            select.innerHTML = initialOptions.join('') + optionHtml;
        }

        // --- FUNGSI Memuat Data Mahasiswa ---
        async function loadMahasiswa() {
            const filterProdi = document.getElementById('filterProdi').value;
            const filterKelas = document.getElementById('filterKelas').value;
            const filterAngkatan = document.getElementById('filterAngkatan').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            let query = supabaseClient.from("mahasiswa").select("*").order("nim", { ascending: true });

            if (filterProdi) {
                query = query.eq('prodi', filterProdi);
            }
            if (filterKelas) {
                query = query.eq('kelas', filterKelas);
            }
             if (filterAngkatan) {
                query = query.eq('angkatan', filterAngkatan);
            }
            
            const { data, error } = await query;
                
            if (error) {
                console.error(error);
                showToast("Gagal memuat data mahasiswa", 'error');
                return;
            }
            
            let filteredData = data;
            
            if (searchInput) {
                 filteredData = data.filter(mhs => 
                    mhs.nama.toLowerCase().includes(searchInput) ||
                    mhs.nim.includes(searchInput)
                );
            }

            semuaData = data; // Simpan semua data yang diambil (sebelum pencarian)
            tampilkanData(filteredData);
            showToast(`Menampilkan ${filteredData.length} data mahasiswa.`, 'info');
        }

        // --- FUNGSI Menampilkan Data ke Tabel ---
        function tampilkanData(data) {
            dataYangDitampilkan = data;
            const tabelBody = document.querySelector("#tabelMahasiswa tbody");
            tabelBody.innerHTML = "";
            
            data.forEach((mhs, index) => {
                const prodiClass = mhs.kelas ? `row-${mhs.kelas.replace(/\s/g, '')}` : ''; // Menggunakan kelas untuk warna baris sementara
                const tr = document.createElement("tr");
                tr.classList.add("border-b", prodiClass);
                
                tr.innerHTML = `
                    <td class="border px-2 py-1 text-center">${index + 1}</td>
                    <td class="border px-2 py-1 text-center">${mhs.nim || '-'}</td>
                    <td class="border px-2 py-1 text-left">${mhs.nama || '-'}</td>
                    <td class="border px-2 py-1 text-left">${mhs.prodi || '-'}</td>
                    <td class="border px-2 py-1 text-center">${mhs.kelas || '-'}</td>
                    <td class="border px-2 py-1 text-center">${mhs.angkatan || '-'}</td>
                    <td class="border px-2 py-1 text-center">${mhs.status || '-'}</td>
                    <td class="border px-2 py-1 text-center">
                        <button onclick="showDetail(${mhs.id})" class="bg-blue-400 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs transition duration-150">Detail</button>
                    </td>
                `;
                tabelBody.appendChild(tr);
            });
        }
        
        // --- FUNGSI Menampilkan Detail Mahasiswa di Modal ---
        function showDetail(id) {
            const mhs = semuaData.find(d => d.id === id);
            if (!mhs) {
                showToast("Data detail tidak ditemukan.", 'error');
                return;
            }

            document.getElementById('modalNama').textContent = mhs.nama || '-';

            // Membuat konten modal
            const modalContent = `
                <h3 class="font-bold text-lg text-blue-700 mb-2">Data Akademik</h3>
                <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
                    <p><span class="font-bold w-32 inline-block">NIM</span>: ${mhs.nim || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Prodi</span>: ${mhs.prodi || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Kelas</span>: ${mhs.kelas || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Angkatan</span>: ${mhs.angkatan || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Status</span>: ${mhs.status || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Jalur Masuk</span>: ${mhs.jalur_masuk || '-'}</p>
                </div>
                
                <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Data Personal & Orang Tua</h4>
                <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
                    <p><span class="font-bold w-32 inline-block">Nama Ayah</span>: ${mhs.nama_ayah || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Nama Ibu</span>: ${mhs.nama_ibu || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">TTL</span>: ${mhs.ttl || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Alamat</span>: ${mhs.alamat || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Kelurahan</span>: ${mhs.kelurahan || '-'}</p>
                    <p><span class="font-bold w-32 inline-block">Kecamatan</span>: ${mhs.kecamatan || '-'}</p>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('detailModal').classList.remove('hidden');
            document.getElementById('detailModal').classList.add('flex');
        }

        // --- FUNGSI Export Excel --- 
        function exportExcel() { 
            const dataForExport = dataYangDitampilkan.map((mhs, index) => ({ 
                No: index + 1, 
                'NIM': mhs.nim || "-",
                'Nama': mhs.nama || "-", 
                'Prodi': mhs.prodi || "-", 
                'Kelas': mhs.kelas || "-", 
                'Angkatan': mhs.angkatan || "-", 
                'Status': mhs.status || "-", 
                'TTL': mhs.ttl || "-", 
                'Alamat': mhs.alamat || "-", 
                'Kelurahan': mhs.kelurahan || "-", 
                'Kecamatan': mhs.kecamatan || "-", 
                'Nama Ayah': mhs.nama_ayah || "-", 
                'Nama Ibu': mhs.nama_ibu || "-", 
                'Jalur Masuk': mhs.jalur_masuk || "-", 
            })); 

            if (dataForExport.length === 0) {
                showToast("Tidak ada data untuk di-export!", 'warning');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(dataForExport); 
            const workbook = XLSX.utils.book_new(); 
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data_Mahasiswa"); 
            XLSX.writeFile(workbook, "Data_Mahasiswa_FT.xlsx"); 
            
            showToast("Data berhasil diekspor ke Excel!", 'success');
        }
        
        // --- FUNGSI Export PDF (Sama seperti logika PDF di main.html, disesuaikan untuk Mahasiswa) --- 
        function exportPDF() { 
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ 
                orientation: 'portrait', 
                unit: 'mm', 
                format: 'a4' 
            }); 

            const tableColumn = [ 
                "No", "NIM", "Nama", "Prodi", "Kelas", "Angkatan", "Status"
            ]; 
            
            const tableRows = []; 
            dataYangDitampilkan.forEach((mhs, index) => { 
                const mhsData = [ 
                    index + 1, 
                    mhs.nim || "-", 
                    mhs.nama || "-", 
                    mhs.prodi || "-", 
                    mhs.kelas || "-", 
                    mhs.angkatan || "-", 
                    mhs.status || "-", 
                ]; 
                tableRows.push(mhsData); 
            }); 

            if (tableRows.length === 0) {
                showToast("Tidak ada data untuk di-export!", 'warning');
                return;
            }

            doc.setFontSize(14);
            doc.text("LAPORAN DATA MAHASISWA FAKULTAS TEKNIK", doc.internal.pageSize.width / 2, 10, { align: 'center' });
            doc.setFontSize(9);
            doc.text(`Total Data: ${dataYangDitampilkan.length}`, 5, 15);
            
            let currentY = 20;

            doc.autoTable(tableColumn, tableRows, { 
                startY: currentY, 
                theme: 'grid', 
                styles: { fontSize: 8, cellPadding: 1.5, halign: 'left' }, 
                margin: { left: 5, right: 5 }, 
                headStyles: { 
                    fillColor: [209, 213, 219], // Gray-200
                    textColor: [55, 65, 81], // Gray-700
                    fontStyle: 'bold', 
                    halign: 'center' 
                }, 
                columnStyles: { 
                    0: { halign: 'center', cellWidth: 10 }, 
                    1: { halign: 'center', cellWidth: 25 },
                    2: { halign: 'left', cellWidth: 50 },
                    3: { halign: 'left', cellWidth: 30 },
                    4: { halign: 'center', cellWidth: 15 },
                    5: { halign: 'center', cellWidth: 20 },
                    6: { halign: 'center', cellWidth: 25 },
                }, 
                didDrawPage: function(data) {
                    // Footer
                    let str = "Halaman " + doc.internal.getNumberOfPages()
                    doc.setFontSize(7)
                    doc.text(str, doc.internal.pageSize.width - 5, doc.internal.pageSize.height - 5, {align: 'right'});
                }
            }); 

            doc.save("Data_Mahasiswa_FT.pdf");
            showToast("Data berhasil diekspor ke PDF!", 'success');
        }


        // --- CEK AUTHENTIKASI & LOAD DATA --
        async function checkAuthAndLoad() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            
            const { data: userData } = await supabaseClient
                .from('users_metadata')
                .select('username')
                .eq('user_id', user.id)
                .single();

            let username = (userData && userData.username) ? userData.username : 'User';
            document.getElementById('userNameNav').textContent = `Halo, ${username}`;

            await loadReferences();
            loadMahasiswa();
        }

        async function logout() { 
            await supabaseClient.auth.signOut(); 
            window.location.href = "index.html"; 
        }

        window.onload = checkAuthAndLoad;

    </script>
</body>
</html>
