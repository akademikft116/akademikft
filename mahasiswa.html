<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodata & Pencarian Mahasiswa - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  
  <style>
    .header-style {
        background-color: #1e3a8a; 
    }
    .main-content {
        padding-top: 5rem; 
        min-height: 100vh;
        background-color: #f3f4f6;
    }
    .container {
        max-width: 1300px;
        margin: auto;
    }
    /* Style untuk Tom Select agar sesuai dengan input Tailwind */
    .ts-wrapper.form-control, .ts-control {
        border-radius: 0.25rem !important;
        border: 1px solid #d1d5db !important;
    }
    /* Menandai link aktif di halaman ini */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    .modal {
        transition: opacity 0.3s ease-out;
    }
    .modal-active {
        opacity: 1;
    }
    /* Tambahkan style untuk menyembunyikan form saat tidak dibutuhkan */
    #mahasiswa-container.hidden {
        display: none;
    }
    /* Styling khusus untuk tombol tab */
    .tab-button {
        transition: all 0.15s ease-in-out;
    }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
        <img src="logo.jpeg" alt="Logo" class="h-10 w-10">
        <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
    </div>
    <div class="flex items-center space-x-4">
        <span id="userNameNav" class="text-white text-sm">Halo, Pengguna</span>
        <button onclick="logout()" class="text-white hover:text-red-300 transition duration-150">
            <i class="fas fa-sign-out-alt mr-1"></i> Logout
        </button>
    </div>
</nav>

<aside class="w-64 fixed top-16 left-0 h-[calc(100vh-4rem)] bg-gray-900 text-white z-20 overflow-y-auto">
    <nav class="flex flex-col p-4 space-y-2">
        <a href="dashboard.html" class="flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-tachometer-alt w-6"></i><span class="ml-3">Dashboard</span>
        </a>
        <a href="main.html" class="flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-calendar-alt w-6"></i><span class="ml-3">Penjadwalan</span>
        </a>
        
        <a href="mahasiswa.html" class="active-link flex items-center p-4 text-sm font-medium text-gray-300 transition duration-150">
            <i class="fas fa-address-card w-6"></i><span class="ml-3">Biodata Mahasiswa</span>
        </a>
        
        <div onclick="showContent('dosenContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-user-tie w-6"></i><span class="ml-3">Data Dosen</span>
        </div>
        
        <div onclick="showContent('matakuliahContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-book w-6"></i><span class="ml-3">Data Mata Kuliah</span>
        </div>
        <div onclick="showContent('settingsContent')" class="cursor-pointer flex items-center p-4 text-sm font-medium text-gray-300 hover:bg-gray-700 transition duration-150">
            <i class="fas fa-cog w-6"></i><span class="ml-3">Pengaturan</span>
        </div>
    </nav>
</aside>


<main class="main-content pt-20 ml-64">
    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Manajemen Biodata & Pencarian Mahasiswa</h1>

        <div id="mahasiswa-container" class="bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="formTitle">Tambah Data Mahasiswa Baru</h2>
            <form id="mahasiswaForm" onsubmit="event.preventDefault(); saveMahasiswa();">
                
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button type="button" id="tab-akademik" onclick="switchTab('akademik')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                            <i class="fas fa-user-graduate mr-2"></i> Data Akademik & Identitas
                        </button>
                        <button type="button" id="tab-personal" onclick="switchTab('personal')" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-id-card mr-2"></i> Data Personal & Orang Tua
                        </button>
                    </nav>
                </div>

                <div id="content-akademik" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="npm" class="block text-sm font-medium text-gray-700">NPM <span class="text-red-500">*</span></label>
                            <input type="text" id="npm" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap <span class="text-red-500">*</span></label>
                            <input type="text" id="nama" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="prodi" class="block text-sm font-medium text-gray-700">Program Studi <span class="text-red-500">*</span></label>
                            <select id="prodi" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Pilih Prodi</option>
                                <option value="Industri">Teknik Industri</option>
                                <option value="Sipil">Teknik Sipil</option>
                                <option value="Arsitektur">Teknik Arsitektur</option>
                                <option value="Elektro">Teknik Elektro</option>
                              <option value="Informatika">Teknik Informatika</option>
                            </select>
                        </div>
    
                        <div>
                            <label for="kelas" class="block text-sm font-medium text-gray-700">Kelas (A/B/C)</label>
                            <input type="text" id="kelas" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin <span class="text-red-500">*</span></label>
                            <select id="jenisKelamin" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Pilih J. Kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label for="tahunmasuk" class="block text-sm font-medium text-gray-700">Tahun Masuk <span class="text-red-500">*</span></label>
                            <select id="tahunmasuk" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Pilih Tahun</option>
                            </select>
                        </div>

                        <div>
                            <label for="nik" class="block text-sm font-medium text-gray-700">NIK Mahasiswa</label>
                            <input type="text" id="nik" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="nohp" class="block text-sm font-medium text-gray-700">No. HP</label>
                            <input type="text" id="nohp" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        
                        <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status Mahasiswa <span class="text-red-500">*</span></label>
                            <select id="status" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                <option value="Aktif">Aktif</option>
                                <option value="Cuti">Cuti</option>
                                <option value="Nonaktif">Nonaktif</option>
                                <option value="Lulus">Lulus</option>
                                <option value="Drop Out">Drop Out</option>
                                <option value="Meninggal">Meninggal Dunia</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="nomorIjazah" class="block text-sm font-medium text-gray-700">Nomor Ijazah (Opsional)</label>
                            <input type="text" id="nomorIjazah" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div></div> 
                        <div></div> 

                    </div>
                    
                    <div class="mt-4">
                        <label for="judulskripsi" class="block text-sm font-medium text-gray-700">Judul Skripsi (Opsional)</label>
                        <input type="text" id="judulskripsi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>

                <div id="content-personal" class="tab-content hidden">
                    <p class="text-sm text-gray-600 mb-4">Lengkapi data personal dan orang tua (dapat dikosongkan).</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="namaayah" class="block text-sm font-medium text-gray-700">Nama Ayah</label>
                            <input type="text" id="namaayah" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="namaibu" class="block text-sm font-medium text-gray-700">Nama Ibu</label>
                            <input type="text" id="namaibu" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="ttl" class="block text-sm font-medium text-gray-700">TTL</label>
                            <input type="text" id="ttl" placeholder="Contoh: Jakarta, 01-01-2000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>

                        <div>
                            <label for="kelurahan" class="block text-sm font-medium text-gray-700">Kelurahan</label>
                            <input type="text" id="kelurahan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="kecamatan" class="block text-sm font-medium text-gray-700">Kecamatan</label>
                            <input type="text" id="kecamatan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                         <div></div>
                    </div>

                    <div class="mt-4">
                        <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat Lengkap (Jalan, RT/RW)</label>
                        <textarea id="alamat" rows="2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                </div>


                <input type="hidden" id="mahasiswaId" value="">
                <div class="mt-6 pt-4 border-t flex space-x-3 justify-end">
                    <button type="submit" id="submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                        <i class="fas fa-save mr-2"></i> Simpan Data
                    </button>
                    <button type="button" onclick="resetForm()" id="reset-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                        <i class="fas fa-times mr-2"></i> Batalkan & Tutup
                    </button>
                </div>
            </form>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Daftar Mahasiswa</h2>
            
            <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                <h3 class="text-lg font-medium mb-3 text-gray-700"><i class="fas fa-filter mr-2"></i> Filter Pencarian</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="searchNama" class="block text-sm font-medium text-gray-700">Nama</label>
                        <input type="text" id="searchNama" placeholder="Ketik Nama Mahasiswa" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="searchNpm" class="block text-sm font-medium text-gray-700">NPM</label>
                        <input type="text" id="searchNpm" placeholder="Ketik NPM" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="searchTahun" class="block text-sm font-medium text-gray-700">Tahun Masuk</label>
                        <select id="searchTahun" class="w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Semua Tahun</option>
                        </select>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="performSearch()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 flex-grow">
                            <i class="fas fa-search mr-1"></i> Cari
                        </button>
                        <button onclick="resetSearch()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" onchange="importFromExcel(event)">
                    <label for="excelFileInput" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 cursor-pointer">
                        <i class="fas fa-file-excel mr-2"></i> Import dari Excel
                    </label>
                    <span id="importStatus" class="text-sm text-gray-600"></span>
                </div>

                <button onclick="showForm()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150">
                    <i class="fas fa-plus-circle mr-2"></i> Tambah Data Mahasiswa
                </button>
            </div>


            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NPM</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prodi</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun Masuk</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="mahasiswa-table-body">
                        </tbody>
                </table>
            </div>
        </div>

    </div>
</main>


<div id="detailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
        <h3 class="text-xl font-bold mb-4 border-b pb-2">Detail Biodata Mahasiswa</h3>
        <div id="modalContent" class="text-sm space-y-2">
            </div>
        <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="mt-6 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Tutup</button>
    </div>
</div>


<script>
    // Konfigurasi Supabase
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isEditMode = false;
    let currentMahasiswaId = null;

    let prodiSelect;
    let tahunMasukSelect;
    let searchTahunSelect; 
    let statusSelect; 

    document.addEventListener('DOMContentLoaded', () => {
        // Inisialisasi Tom Select untuk Form Tambah/Edit
        prodiSelect = new TomSelect("#prodi", { create: false });
        tahunMasukSelect = new TomSelect("#tahunmasuk", { create: false });
        statusSelect = new TomSelect("#status", { create: false }); 
        
        populateYearSelect(tahunMasukSelect);
        
        // Inisialisasi Tom Select untuk Pencarian
        searchTahunSelect = new TomSelect("#searchTahun", { 
            create: false,
            placeholder: "Pilih Tahun",
        });
        populateYearSelect(searchTahunSelect, true); 
    });

    // --- FUNGSI BANTUAN ---
    function populateYearSelect(selectInstance, includeAllOption = false) {
        selectInstance.clear(true); 

        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i >= 2018; i--) {
            selectInstance.addOption({ value: i, text: i });
        }
        
        if(includeAllOption) {
            selectInstance.addOption({ value: '', text: 'Semua Tahun' });
        }
        
        selectInstance.refreshOptions(false);
        if(includeAllOption) {
             selectInstance.setValue('');
        } else if (selectInstance.options.length > 0) {
            selectInstance.setValue(currentYear);
        }
    }
    
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }
    
    // Fungsi showContent untuk sidebar (mengarahkan ke dashboard.html untuk menu lain)
    function showContent(contentId) {
        window.location.href = `dashboard.html#${contentId}`; 
    }
    
    // Fungsi untuk mengelola perpindahan tab di formulir
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('text-blue-600', 'border-blue-600');
            button.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });

        document.getElementById(`content-${tabName}`).classList.remove('hidden');

        const activeBtn = document.getElementById(`tab-${tabName}`);
        activeBtn.classList.add('text-blue-600', 'border-blue-600');
        activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
    }


    // Fungsi untuk menampilkan form Tambah/Edit dan melakukan reset
    function showForm() {
        resetForm();
        document.getElementById('mahasiswa-container').classList.remove('hidden');
        document.getElementById('mahasiswa-container').scrollIntoView({ behavior: 'smooth' });
        switchTab('akademik');
    }

    // Fungsi untuk menyembunyikan form
    function hideForm() {
        document.getElementById('mahasiswa-container').classList.add('hidden');
    }

    // --- FUNGSI PENCARIAN ---
    function performSearch() {
        const searchNama = document.getElementById('searchNama').value.trim();
        const searchNpm = document.getElementById('searchNpm').value.trim();
        const searchTahun = searchTahunSelect.getValue(); 

        loadMahasiswaData({ nama: searchNama, npm: searchNpm, tahun: searchTahun });
    }

    function resetSearch() {
        document.getElementById('searchNama').value = '';
        document.getElementById('searchNpm').value = '';
        searchTahunSelect.setValue(''); 
        loadMahasiswaData(); 
    }

    // --- FUNGSI IMPORT EXCEL ---
    async function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const importStatus = document.getElementById('importStatus');
        importStatus.textContent = 'Membaca file...';

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                let excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (excelData.length === 0) {
                    importStatus.textContent = '❌ File Excel kosong atau tidak terbaca.';
                    return;
                }

                const headers = excelData[0].map(h => String(h).trim().toUpperCase().replace(/[\s\W]+/g, '_').replace(/^_|_$/g, ''));
                const rawData = excelData.slice(1);
                
                // MAPPING KOLOM (Diperbarui untuk Jenis Kelamin dan Nomor Ijazah)
                const columnMapping = {
                    'NPM': 'npm',
                    'NAMA': 'nama',
                    'PRODI': 'prodi',
                    'JENIS_KELAMIN': 'jenis_kelamin', 
                    'TAHUN_MASUK': 'tahun_masuk',
                    'STATUS': 'status',
                    'KELAS': 'kelas',
                    'NIK': 'nik_mahasiswa', 
                    'NO_HP': 'no_hp',
                    'NOMOR_IJAZAH': 'nomor_ijazah', // MAPPING BARU
                    'JUDUL_SKRIPSI': 'judul_skripsi',
                    'NAMA_AYAH': 'nama_ayah',
                    'NAMA_IBU': 'nama_ibu',
                    'TTL': 'ttl',
                    'ALAMAT': 'alamat',
                    'KELURAHAN': 'kelurahan',
                    'KECAMATAN': 'kecamatan',
                    'SEMESTER': 'semester', // Tetap pertahankan jika ada di DB, tapi tidak muncul di form
                };

                const studentsToInsert = [];
                
                for (const row of rawData) {
                    let student = {};
                    let isValidRow = true;
                    
                    for (let i = 0; i < headers.length; i++) {
                        const excelHeader = headers[i];
                        const supabaseColumn = columnMapping[excelHeader];
                        
                        if (supabaseColumn) {
                             let value = row[i] === undefined ? null : row[i];
                             
                             // Konversi tipe data
                             if (supabaseColumn === 'tahun_masuk' || supabaseColumn === 'semester') {
                                 value = parseInt(value) || null; 
                             } else if (value !== null) {
                                 value = String(value).trim() || null;
                             }
                             
                             student[supabaseColumn] = value;
                        }
                    }
                    
                    // Set default/validasi nilai wajib
                    if (!student.npm || !student.nama || !student.prodi || !student.jenis_kelamin || !student.tahun_masuk) {
                         console.warn('Baris diabaikan karena data wajib tidak lengkap:', student);
                         isValidRow = false; 
                    }
                    
                    // Pastikan status ada (default 'Aktif')
                    student.status = student.status || 'Aktif'; 
                    student.semester = student.semester || null; // Pastikan semester di set null jika tidak ada

                    if (isValidRow) {
                        studentsToInsert.push(student);
                    }
                }
                
                if (studentsToInsert.length === 0) {
                    importStatus.textContent = '❌ Tidak ada data mahasiswa valid yang ditemukan untuk diimpor. Pastikan kolom wajib (NPM, Nama, Prodi, Jenis Kelamin, Tahun Masuk) terisi.';
                    return;
                }

                importStatus.textContent = `Menemukan ${studentsToInsert.length} data valid. Menyimpan ke database...`;

                const { error: insertError } = await supabaseClient
                    .from('mahasiswa')
                    .upsert(studentsToInsert, { onConflict: 'npm' }); 

                if (insertError) {
                    alert('❌ Gagal mengimpor data: ' + insertError.message);
                    importStatus.textContent = '❌ Import Gagal. Cek Konsol untuk detail error.';
                    console.error(insertError);
                } else {
                    alert(`✅ Import Sukses! ${studentsToInsert.length} data mahasiswa berhasil disimpan/diperbarui.`);
                    importStatus.textContent = `✅ Import Sukses. ${studentsToInsert.length} data disimpan/diperbarui.`;
                    loadMahasiswaData(); // Reload tabel utama
                }


            } catch (err) {
                console.error('Error saat memproses file Excel:', err);
                importStatus.textContent = '❌ Terjadi kesalahan saat memproses file.';
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsArrayBuffer(file);
    }


    // --- FUNGSI CRUD ---

    // 1. Memuat Data Mahasiswa
    async function loadMahasiswaData(filters = {}) {
        const { nama, npm, tahun } = filters;

        const tableBody = document.getElementById('mahasiswa-table-body');
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Memuat data...</td></tr>';
        
        let query = supabaseClient.from('mahasiswa').select('*');
        
        // Buat filter menggunakan operator OR untuk Nama dan NPM
        if (nama || npm) {
            let or_filters = [];
            if (nama) or_filters.push(`nama.ilike.%${nama}%`);
            if (npm) or_filters.push(`npm.ilike.%${npm}%`);
            
            if (or_filters.length > 0) {
                 query = query.or(or_filters.join(','));
            }
        }
        
        // Filter Tahun Masuk menggunakan operator EQ (terpisah dari OR)
        if (tahun) {
            query = query.eq('tahun_masuk', tahun);
        }

        const { data: mahasiswaData, error } = await query.order('npm', { ascending: true });

        if (error) {
            console.error('Error saat memuat data:', error);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            return;
        }

        tableBody.innerHTML = '';
        if (mahasiswaData.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Tidak ada data mahasiswa yang ditemukan.</td></tr>';
            return;
        }

        mahasiswaData.forEach(mhs => {
            const statusBadge = mhs.status === 'Aktif' 
                ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Aktif</span>'
                : mhs.status === 'Lulus' 
                ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Lulus</span>'
                : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">' + mhs.status + '</span>'; // Menampilkan status lainnya

            const row = `
                <tr class="hover:bg-gray-100 transition duration-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${mhs.npm}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mhs.prodi}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${mhs.kelas || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${mhs.tahun_masuk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        <button onclick="showDetail(${mhs.id})" class="text-indigo-600 hover:text-indigo-900 transition duration-150"><i class="fas fa-eye"></i> Detail</button>
                        <button onclick="editMahasiswa(${mhs.id})" class="text-yellow-600 hover:text-yellow-900 transition duration-150"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteMahasiswa(${mhs.id}, '${mhs.nama}')" class="text-red-600 hover:text-red-900 transition duration-150"><i class="fas fa-trash"></i> Hapus</button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    }

    // 2. Menyimpan/Memperbarui Data
    async function saveMahasiswa() {
        // Data Akademik (Wajib)
        const npm = document.getElementById('npm').value;
        const nama = document.getElementById('nama').value;
        const prodi = prodiSelect.getValue();
        const jenisKelamin = document.getElementById('jenisKelamin').value; 
        const tahunmasuk = parseInt(tahunMasukSelect.getValue()); 
        const statusMhs = statusSelect.getValue(); 
        
        // Data Akademik (Opsional)
        const kelas = document.getElementById('kelas').value || null;
        const nik = document.getElementById('nik').value || null;
        const nohp = document.getElementById('nohp').value || null;
        const nomorIjazah = document.getElementById('nomorIjazah').value || null; // NILAI BARU
        const judulskripsi = document.getElementById('judulskripsi').value || null;
        
        // Data Personal
        const namaAyah = document.getElementById('namaayah').value || null;
        const namaIbu = document.getElementById('namaibu').value || null;
        const ttl = document.getElementById('ttl').value || null;
        const alamat = document.getElementById('alamat').value || null;
        const kelurahan = document.getElementById('kelurahan').value || null;
        const kecamatan = document.getElementById('kecamatan').value || null;
        
        // Semester di set null
        const semester = null; 

        // Validasi minimal
        if (!npm || !nama || !prodi || !jenisKelamin || isNaN(tahunmasuk) || !statusMhs) {
             alert('❌ Pastikan NPM, Nama, Prodi, Jenis Kelamin, Tahun Masuk, dan Status Mahasiswa pada tab Data Akademik terisi dengan benar.');
             switchTab('akademik');
             return;
        }

        const mahasiswaData = {
            npm: npm, 
            nama: nama,
            prodi: prodi,
            jenis_kelamin: jenisKelamin, 
            semester: semester, 
            tahun_masuk: tahunmasuk,
            kelas: kelas,
            nik_mahasiswa: nik,
            no_hp: nohp,
            nomor_ijazah: nomorIjazah, // KOLOM BARU
            judul_skripsi: judulskripsi,
            status: statusMhs,
            
            // Kolom Data Personal
            nama_ayah: namaAyah, 
            nama_ibu: namaIbu,
            ttl: ttl, 
            alamat: alamat,
            kelurahan: kelurahan,
            kecamatan: kecamatan,
        };

        if (isEditMode && currentMahasiswaId) {
            const { error: updateError } = await supabaseClient
                .from('mahasiswa')
                .update(mahasiswaData)
                .eq('id', currentMahasiswaId);

            if (updateError) {
                alert('❌ Gagal memperbarui data mahasiswa: ' + updateError.message);
                console.error(updateError);
            } else {
                alert(`✅ Data mahasiswa ${nama} berhasil diperbarui!`);
                resetForm();
                hideForm(); 
                loadMahasiswaData();
            }
        } else {
            const { error: insertError } = await supabaseClient
                .from('mahasiswa')
                .insert([mahasiswaData]);

            if (insertError) {
                alert('❌ Gagal menyimpan data mahasiswa. Kemungkinan: NPM sudah terdaftar atau skema database tidak sesuai. Pesan: ' + insertError.message);
                console.error(insertError);
            } else {
                alert(`✅ Data mahasiswa ${nama} (NPM: ${npm}) berhasil ditambahkan!`);
                resetForm(); 
                hideForm(); 
                loadMahasiswaData(); 
            }
        }
    }

    // 3. Mengisi Form untuk Edit
    async function editMahasiswa(mahasiswaId) {
        const { data: mhs, error } = await supabaseClient
            .from('mahasiswa')
            .select('*')
            .eq('id', mahasiswaId)
            .single();

        if (error || !mhs) {
            alert('❌ Data tidak ditemukan untuk diedit.');
            return;
        }
        
        showForm();

        // Data Akademik
        document.getElementById('mahasiswaId').value = mhs.id;
        document.getElementById('npm').value = mhs.npm;
        document.getElementById('nama').value = mhs.nama;
        prodiSelect.setValue(mhs.prodi);
        document.getElementById('kelas').value = mhs.kelas || '';
        document.getElementById('jenisKelamin').value = mhs.jenis_kelamin || ''; 
        tahunMasukSelect.setValue(mhs.tahun_masuk);
        statusSelect.setValue(mhs.status); 
        document.getElementById('nik').value = mhs.nik_mahasiswa || '';
        document.getElementById('nohp').value = mhs.no_hp || '';
        document.getElementById('nomorIjazah').value = mhs.nomor_ijazah || ''; // NILAI BARU
        document.getElementById('judulskripsi').value = mhs.judul_skripsi || '';
        
        // Data Personal
        document.getElementById('namaayah').value = mhs.nama_ayah || '';
        document.getElementById('namaibu').value = mhs.nama_ibu || '';
        document.getElementById('ttl').value = mhs.ttl || '';
        document.getElementById('alamat').value = mhs.alamat || '';
        document.getElementById('kelurahan').value = mhs.kelurahan || '';
        document.getElementById('kecamatan').value = mhs.kecamatan || '';
        
        isEditMode = true;
        currentMahasiswaId = mhs.id;
        document.getElementById('formTitle').textContent = `Edit Data Mahasiswa: ${mhs.nama}`;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Update Data';
        
        document.getElementById('mahasiswaForm').scrollIntoView({ behavior: 'smooth' });
    }

    // 4. Menghapus Data Mahasiswa
    async function deleteMahasiswa(mahasiswaId, nama) {
        if (!confirm(`Anda yakin ingin menghapus data mahasiswa ${nama} secara permanen?`)) {
            return;
        }

        const { error } = await supabaseClient
            .from('mahasiswa')
            .delete()
            .eq('id', mahasiswaId); 

        if (error) {
            alert('❌ Gagal menghapus data: ' + error.message);
        } else {
            alert(`✅ Data mahasiswa ${nama} berhasil dihapus.`);
            loadMahasiswaData();
        }
    }

    // 5. Reset Form
    function resetForm() {
        document.getElementById('mahasiswaForm').reset();
        prodiSelect.clear();
        tahunMasukSelect.clear();
        document.getElementById('jenisKelamin').value = ''; 
        statusSelect.setValue('Aktif'); 
        isEditMode = false;
        currentMahasiswaId = null;
        document.getElementById('formTitle').textContent = 'Tambah Data Mahasiswa Baru';
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save mr-2"></i> Simpan Data';
        document.getElementById('mahasiswaId').value = '';
        hideForm(); 
    }
    
    // 6. Tampilkan Detail Modal
    async function showDetail(mahasiswaId) {
        const { data: mhs, error } = await supabaseClient
            .from('mahasiswa')
            .select('*')
            .eq('id', mahasiswaId)
            .single();

        if (error || !mhs) {
            alert('❌ Data tidak ditemukan.');
            return;
        }
        
        const statusText = mhs.status;
        const statusColor = mhs.status === 'Aktif' ? 'text-green-600' : mhs.status === 'Lulus' ? 'text-blue-600' : 'text-red-600';

        const modalContent = `
            <h4 class="font-bold text-lg text-blue-700 mb-2">Data Akademik & Identitas</h4>
            <p><span class="font-bold w-32 inline-block">NPM</span>: ${mhs.npm}</p>
            <p><span class="font-bold w-32 inline-block">Nama Lengkap</span>: ${mhs.nama}</p>
            <p><span class="font-bold w-32 inline-block">Prodi</span>: ${mhs.prodi}</p>
            <p><span class="font-bold w-32 inline-block">Kelas</span>: ${mhs.kelas || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Jenis Kelamin</span>: ${mhs.jenis_kelamin || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Tahun Masuk</span>: ${mhs.tahun_masuk}</p>
            <p><span class="font-bold w-32 inline-block">Status</span>: <span class="font-bold ${statusColor}">${statusText}</span></p>
            <p><span class="font-bold w-32 inline-block">NIK</span>: ${mhs.nik_mahasiswa || '-'}</p>
            <p><span class="font-bold w-32 inline-block">No. HP</span>: ${mhs.no_hp || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Nomor Ijazah</span>: ${mhs.nomor_ijazah || '-'}</p> <hr class="my-3 border-gray-200">
            <p><span class="font-bold w-32 inline-block">Judul Skripsi</span>: ${mhs.judul_skripsi || 'Belum ada'}</p>
            
            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Data Personal & Orang Tua</h4>
            <p><span class="font-bold w-32 inline-block">Nama Ayah</span>: ${mhs.nama_ayah || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Nama Ibu</span>: ${mhs.nama_ibu || '-'}</p>
            <p><span class="font-bold w-32 inline-block">TTL</span>: ${mhs.ttl || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Alamat</span>: ${mhs.alamat || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Kelurahan</span>: ${mhs.kelurahan || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Kecamatan</span>: ${mhs.kecamatan || '-'}</p>
        `;

        document.getElementById('modalContent').innerHTML = modalContent;
        document.getElementById('detailModal').classList.remove('hidden');
    }

    // --- CEK AUTHENTIKASI ---
    async function checkAuthAndLoad() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        const { data: userData } = await supabaseClient
            .from('users_metadata')
            .select('username')
            .eq('user_id', user.id)
            .single();

        if (userData) {
            document.getElementById('userNameNav').textContent = `Halo, ${userData.username}`;
        }

        loadMahasiswaData(); 
    }

    window.onload = checkAuthAndLoad;
</script>
</body>
</html>
