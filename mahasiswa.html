<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodata & Pencarian Mahasiswa - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* Styling untuk menandai menu aktif di sidebar */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    .main-content {
        min-height: calc(100vh - 4rem); 
    }
    .ts-control {
        border-color: #d1d5db !important;
        border-radius: 0.375rem !important;
    }
  </style>
</head>

<body class="bg-gray-100">

    <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-20 flex items-center justify-between px-6">
        <div class="flex items-center space-x-3">
            <span class="text-white text-xl font-bold">FAKULTAS TEKNIK</span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="userNameNav" class="text-white text-sm font-medium">Halo, Pengguna</span>
            <button onclick="logout()" class="text-white hover:text-red-300 transition duration-150">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
            </button>
        </div>
    </nav>

    <div class="flex pt-16">
        <aside class="w-64 bg-gray-800 fixed h-full shadow-xl z-10">
            <div class="p-4 pt-8">
                <nav class="space-y-2">
                    <a href="dashboard.html" class="flex items-center space-x-3 p-3 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-150">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="main.html" class="flex items-center space-x-3 p-3 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-150">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Jadwal Kuliah</span>
                    </a>
                    <a href="dosen.html" class="flex items-center space-x-3 p-3 text-gray-300 rounded-lg hover:bg-gray-700 transition duration-150">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Data Dosen</span>
                    </a>
                    <a href="mahasiswa.html" class="active-link flex items-center space-x-3 p-3 rounded-lg transition duration-150">
                        <i class="fas fa-user-graduate"></i>
                        <span>Data Mahasiswa</span>
                    </a>
                </nav>
            </div>
        </aside>

        <main class="flex-1 ml-64 p-8 main-content">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h1 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Biodata & Pencarian Mahasiswa</h1>

                <div class="flex space-x-4 mb-6 items-center">
                    <div class="w-1/4">
                        <label for="prodiFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter Prodi</label>
                        <select id="prodiFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option value="">Semua Prodi</option>
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Mahasiswa (Nama/NIM)</label>
                        <input type="text" id="searchInput" placeholder="Masukkan Nama atau NIM" class="mt-1 block w-full pl-3 pr-4 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    </div>
                </div>

                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider w-10">No.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">NIM</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Nama Mahasiswa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Prodi</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-white uppercase tracking-wider w-24">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dataMahasiswa" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="detailModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modalContent" class="text-left p-2">
                    </div>
                <div class="items-center px-4 py-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-blue-700 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>


<script>
    // --- KONFIGURASI SUPABASE ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARIABEL GLOBAL ---
    let mahasiswaData = [];
    
    // --- FUNGSI LOGOUT ---
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // --- FUNGSI CEK AUTHENTIKASI & MUAT DATA (KODE YANG DIPERBAIKI) ---
    async function checkAuthAndLoad() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        
        // Perbaikan: Hanya redirect ke index.html jika user TIDAK ADA
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        // Lanjutkan: Ambil username dan tampilkan
        const { data: userData } = await supabaseClient
            .from('users_metadata')
            .select('username')
            .eq('user_id', user.id)
            .single();

        if (userData) {
            document.getElementById('userNameNav').textContent = `Halo, ${userData.username}`;
        }
        
        // Panggil fungsi utama untuk memuat data Mahasiswa
        loadProdiFilter();
        loadDataMahasiswa();
    }

    // --- FUNGSI-FUNGSI UTAMA LAINNYA ---
    
    // Mengambil data prodi untuk filter
    async function loadProdiFilter() {
        const { data, error } = await supabaseClient
            .from('prodi')
            .select('kode_prodi, nama_prodi');

        if (error) {
            console.error("Gagal memuat prodi:", error);
            return;
        }
        
        const prodiFilter = document.getElementById('prodiFilter');
        prodiFilter.innerHTML = '<option value="">Semua Prodi</option>';

        data.forEach(p => {
            const option = document.createElement('option');
            option.value = p.kode_prodi;
            option.textContent = p.nama_prodi;
            prodiFilter.appendChild(option);
        });
    }

    // Mengambil dan menampilkan data mahasiswa
    async function loadDataMahasiswa() {
        document.getElementById('dataMahasiswa').innerHTML = '<tr><td colspan="5" class="py-4 text-center">Memuat data...</td></tr>';
        
        const prodi = document.getElementById('prodiFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        let query = supabaseClient.from('mahasiswa').select('*');

        if (prodi) {
            query = query.eq('kode_prodi', prodi);
        }
        
        const { data, error } = await query.order('nama', { ascending: true });

        if (error) {
            document.getElementById('dataMahasiswa').innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-500">Error memuat data: ${error.message}</td></tr>`;
            return;
        }

        mahasiswaData = data;
        renderDataMahasiswa(mahasiswaData, search);
    }

    // Merender data mahasiswa ke tabel dengan filter lokal
    function renderDataMahasiswa(data, search) {
        const dataMahasiswaBody = document.getElementById('dataMahasiswa');
        dataMahasiswaBody.innerHTML = '';
        
        const filteredData = data.filter(m => 
            m.nama.toLowerCase().includes(search) ||
            m.nim.toLowerCase().includes(search) ||
            m.prodi.toLowerCase().includes(search)
        );

        if (filteredData.length === 0) {
            dataMahasiswaBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center">Tidak ada data mahasiswa yang ditemukan.</td></tr>';
            return;
        }

        filteredData.forEach((m, index) => {
            const row = dataMahasiswaBody.insertRow();
            row.className = 'hover:bg-gray-50';
            
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = m.nim;
            row.insertCell().textContent = m.nama;
            row.insertCell().textContent = m.prodi;
            
            const actionCell = row.insertCell();
            actionCell.className = 'text-center';
            actionCell.innerHTML = `<button onclick="showDetailModal('${m.nim}')" class="text-blue-600 hover:text-blue-800 font-medium">Detail</button>`;
        });
    }

    // Menampilkan modal detail mahasiswa
    function showDetailModal(nim) {
        const mhs = mahasiswaData.find(m => m.nim === nim);
        if (!mhs) return;

        const modalContent = `
            <h3 class="text-xl font-bold text-blue-800 mb-4">${mhs.nama} (${mhs.nim})</h3>
            <h4 class="font-semibold text-lg text-blue-700 mb-2">Data Akademik</h4>
            <p><span class="font-bold w-32 inline-block">NIM</span>: ${mhs.nim}</p>
            <p><span class="font-bold w-32 inline-block">Nama Lengkap</span>: ${mhs.nama}</p>
            <p><span class="font-bold w-32 inline-block">Prodi</span>: ${mhs.prodi}</p>
            <p><span class="font-bold w-32 inline-block">Angkatan</span>: ${mhs.angkatan || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Kelas</span>: ${mhs.kelas || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Status</span>: ${mhs.status}</p>
            <hr class="my-3">
            <h4 class="font-semibold text-lg text-blue-700 mt-4 mb-2">Data Personal & Orang Tua</h4>
            <p><span class="font-bold w-32 inline-block">Nama Ayah</span>: ${mhs.nama_ayah || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Nama Ibu</span>: ${mhs.nama_ibu || '-'}</p>
            <p><span class="font-bold w-32 inline-block">TTL</span>: ${mhs.ttl || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Alamat</span>: ${mhs.alamat || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Kelurahan</span>: ${mhs.kelurahan || '-'}</p>
            <p><span class="font-bold w-32 inline-block">Kecamatan</span>: ${mhs.kecamatan || '-'}</p>
        `;

        document.getElementById('modalContent').innerHTML = modalContent;
        document.getElementById('detailModal').classList.remove('hidden');
    }

    // Menutup modal
    function closeModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }
    
    // Panggil fungsi utama saat dokumen dimuat
    window.onload = checkAuthAndLoad;

    // Tambahkan event listener untuk filter dan search
    document.getElementById('prodiFilter').addEventListener('change', () => renderDataMahasiswa(mahasiswaData, document.getElementById('searchInput').value.toLowerCase()));
    document.getElementById('searchInput').addEventListener('keyup', () => renderDataMahasiswa(mahasiswaData, document.getElementById('searchInput').value.toLowerCase()));

</script>
</body>
</html>
