<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Mahasiswa - Fakultas Teknik</title>

  <!-- CDN Tailwind & Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Tom Select -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">

  <style>
    .active-link { background-color: #1d4ed8; color: white; border-left: 4px solid #f97316; }
    .main-content { height: calc(100vh - 4rem); }
    .ts-wrapper.form-control, .ts-control { border-radius: 0.25rem !important; border: 1px solid #d1d5db !important; }
    .ts-dropdown, .ts-control { font-size: 0.875rem; }
  </style>
</head>

<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
      <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
      <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
    </div>
    <div class="flex items-center space-x-4">
      <span id="userNameNav" class="text-white text-sm">Halo, AkademikFT</span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="flex pt-16 main-content">
    <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 shadow-xl">
      <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
        <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
          <i class="fas fa-chart-bar w-5"></i><span>Dashboard</span>
        </a>
        <a href="main.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
          <i class="fas fa-calendar-alt w-5"></i><span>Penjadwalan</span>
        </a>
        <a href="mahasiswa.html" class="active-link flex items-center space-x-3 p-3 rounded-lg">
          <i class="fas fa-address-card w-5"></i><span>Data Mahasiswa</span>
        </a>
        <a href="dosen.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
          <i class="fas fa-user-tie w-5"></i><span>Data Dosen</span>
        </a>
        <a href="dashboard.html#matkul" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
          <i class="fas fa-book w-5"></i><span>Mata Kuliah</span>
        </a>
        <a href="dashboard.html#pengaturan" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
          <i class="fas fa-cog w-5"></i><span>Pengaturan</span>
        </a>
      </nav>
      <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
        <p>&copy; 2025 Akademik FT</p>
        <p>Designed by Rifqi & Alfi</p>
      </div>
    </aside>

    <!-- Konten utama -->
    <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100">
      <div class="container mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Manajemen Data Mahasiswa</h1>

        <!-- Form Tambah/Edit Mahasiswa -->
        <form id="mahasiswaForm" class="space-y-4">
          <input type="hidden" id="mahasiswaId" value="">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Nama Mahasiswa</label>
              <input type="text" id="nama" required class="w-full border border-gray-300 rounded-md p-2">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Program Studi</label>
              <select id="prodi" class="w-full border border-gray-300 rounded-md p-2">
                <option value="">Pilih Prodi</option>
                <option value="Industri">Teknik Industri</option>
                <option value="Sipil">Teknik Sipil</option>
                <option value="Informatika">Teknik Informatika</option>
                <option value="Arsitektur">Arsitektur</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Tahun Masuk</label>
              <select id="tahunmasuk" class="w-full border border-gray-300 rounded-md p-2">
                <option value="">Pilih Tahun</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Status Mahasiswa</label>
              <select id="status" class="w-full border border-gray-300 rounded-md p-2">
                <option value="Aktif">Aktif</option>
                <option value="Nonaktif">Nonaktif</option>
                <option value="Lulus">Lulus</option>
                <option value="Drop Out">Drop Out</option>
              </select>
            </div>
          </div>

          <div class="flex justify-end space-x-3 mt-4">
            <button type="button" id="btnSimpan" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">
              <i class="fas fa-save mr-2"></i>Simpan
            </button>
            <button type="button" onclick="resetForm()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md shadow">
              <i class="fas fa-times mr-2"></i>Batal
            </button>
          </div>
        </form>

        <hr class="my-8">

        <!-- Tabel Daftar Mahasiswa -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prodi</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tahun Masuk</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
              </tr>
            </thead>
            <tbody id="mahasiswaTable" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Script Supabase -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    let isEditMode = false;
    let currentMahasiswaId = null;

    document.addEventListener("DOMContentLoaded", () => {
      populateYears();
      loadMahasiswa();
      document.getElementById("btnSimpan").addEventListener("click", handleSave);
    });

    function populateYears() {
      const select = document.getElementById("tahunmasuk");
      const year = new Date().getFullYear();
      for (let y = year; y >= 2010; y--) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        select.appendChild(opt);
      }
    }

    async function loadMahasiswa() {
      const { data, error } = await supabase.from("mahasiswa").select("*").order("id", { ascending: false });
      const tbody = document.getElementById("mahasiswaTable");
      tbody.innerHTML = "";

      if (error || !data.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Belum ada data.</td></tr>`;
        return;
      }

      data.forEach((mhs, index) => {
        const row = `
          <tr>
            <td class="px-6 py-3">${index + 1}</td>
            <td class="px-6 py-3">${mhs.nama}</td>
            <td class="px-6 py-3">${mhs.prodi}</td>
            <td class="px-6 py-3 text-center">${mhs.tahun_masuk}</td>
            <td class="px-6 py-3 text-center">${mhs.status}</td>
            <td class="px-6 py-3 text-center">
              <button onclick="editMahasiswa(${mhs.id})" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
              <button onclick="deleteMahasiswa(${mhs.id})" class="text-red-600 hover:text-red-800 ml-3"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    window.editMahasiswa = async function (id) {
      const { data, error } = await supabase.from("mahasiswa").select("*").eq("id", id).single();
      if (error) return alert("Gagal ambil data mahasiswa.");
      document.getElementById("nama").value = data.nama;
      document.getElementById("prodi").value = data.prodi;
      document.getElementById("tahunmasuk").value = data.tahun_masuk;
      document.getElementById("status").value = data.status;
      currentMahasiswaId = id;
      isEditMode = true;
    };

    async function handleSave() {
      const nama = document.getElementById("nama").value.trim();
      const prodi = document.getElementById("prodi").value;
      const tahun_masuk = document.getElementById("tahunmasuk").value;
      const status = document.getElementById("status").value;

      if (!nama || !prodi || !tahun_masuk || !status) {
        alert("Semua field wajib diisi!");
        return;
      }

      if (isEditMode) {
        const { error } = await supabase.from("mahasiswa").update({ nama, prodi, tahun_masuk, status }).eq("id", currentMahasiswaId);
        if (error) alert("Gagal memperbarui data!");
        else alert("Data berhasil diperbarui!");
      } else {
        const { error } = await supabase.from("mahasiswa").insert([{ nama, prodi, tahun_masuk, status }]);
        if (error) alert("Gagal menambah data!");
        else alert("Data berhasil ditambahkan!");
      }
      resetForm();
      loadMahasiswa();
    }

    window.deleteMahasiswa = async function (id) {
      if (!confirm("Yakin ingin menghapus data ini?")) return;
      const { error } = await supabase.from("mahasiswa").delete().eq("id", id);
      if (error) alert("Gagal menghapus data!");
      else {
        alert("Data berhasil dihapus!");
        loadMahasiswa();
      }
    };

    window.resetForm = function () {
      document.getElementById("mahasiswaForm").reset();
      isEditMode = false;
      currentMahasiswaId = null;
    };
  </script>
</body>
</html>
