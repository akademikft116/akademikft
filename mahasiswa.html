<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Biodata & Pencarian Mahasiswa - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    .active-link { background-color: #1d4ed8; color: white; border-left: 4px solid #f97316; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 50; }
    .modal-content { max-width: 90%; max-height: 90vh; overflow-y: auto; }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
  <div class="flex items-center space-x-3">
    <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
    <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
  </div>
  <div class="flex items-center space-x-4">
    <span id="userNameNav" class="text-white text-sm">Halo, Pengguna</span>
    <button onclick="logout()" class="text-white hover:text-red-300 transition duration-150">
      <i class="fas fa-sign-out-alt"></i> Keluar
    </button>
  </div>
</nav>

<div class="flex pt-16 h-screen">
  
  <aside id="sidebar" class="w-64 bg-blue-800 text-white flex flex-col fixed top-16 bottom-0 z-20 overflow-y-auto">
    <div class="p-4 space-y-4 flex-grow">
      <a href="dashboard.html" class="p-3 flex items-center space-x-3 text-gray-300 hover:bg-blue-600 transition duration-150 rounded-lg">
        <i class="fas fa-tachometer-alt w-5"></i>
        <span>Dashboard</span>
      </a>

      <a href="dosen.html" class="p-3 flex items-center space-x-3 text-gray-300 hover:bg-blue-600 transition duration-150 rounded-lg">
        <i class="fas fa-chalkboard-teacher w-5"></i>
        <span>Data Dosen</span>
      </a>

      <div class="space-y-1">
          <button id="mahasiswa-toggle" class="w-full text-left p-3 flex items-center space-x-3 text-white bg-blue-700 active-link focus:outline-none">
              <i class="fas fa-users w-5"></i>
              <span>Data Mahasiswa</span>
              <i class="fas fa-chevron-down ml-auto transition-transform duration-300 transform" id="mahasiswa-chevron"></i>
          </button>
          
          <div id="mahasiswa-submenu" class="ml-4 space-y-1 hidden">
              
              <a href="mahasiswa.html" class="block p-3 text-sm text-white hover:bg-blue-600 transition-colors duration-150 rounded-lg active-link"> 
                  <i class="fas fa-user-graduate w-5 mr-2"></i>
                  <span>Biodata Mahasiswa</span>
              </a>
              
              <a href="status_mahasiswa.html" class="block p-3 text-sm text-gray-300 hover:bg-blue-600 transition-colors duration-150 rounded-lg">
                  <i class="fas fa-chart-line w-5 mr-2"></i>
                  <span>Status Mahasiswa</span>
              </a>
              
          </div>
      </div>
      
      <a href="main.html" class="p-3 flex items-center space-x-3 text-gray-300 hover:bg-blue-600 transition duration-150 rounded-lg">
        <i class="fas fa-calendar-alt w-5"></i>
        <span>Jadwal Kuliah</span>
      </a>

    </div>
    <div class="p-4 border-t border-blue-700 text-center text-xs text-gray-400">
      &copy; 2024 Fakultas Teknik
    </div>
  </aside>

  <main class="flex-grow ml-64 p-6 bg-gray-100 overflow-y-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Data Mahasiswa</h2>
    <div class="flex justify-between items-center mb-6 bg-white p-4 shadow-md rounded-lg">
        <div class="flex space-x-4 w-full max-w-lg">
            <input type="text" id="searchInput" placeholder="Cari berdasarkan Nama, NIM, atau Prodi..." class="p-2 border border-gray-300 rounded-lg w-full focus:ring-blue-500 focus:border-blue-500">
            <button onclick="loadMahasiswaData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-150">
                <i class="fas fa-search"></i> Cari
            </button>
        </div>
        <div class="flex space-x-3">
            <button onclick="openAddModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-150">
                <i class="fas fa-plus"></i> Tambah Mahasiswa
            </button>
            <button onclick="exportToExcel()" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-150">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button onclick="exportToPDF()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-150">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-blue-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIM</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prodi</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Angkatan</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                </tr>
            </thead>
            <tbody id="mahasiswaTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
        </table>
        
        <div class="flex justify-between items-center p-4 border-t">
            <button id="prevPage" onclick="changePage(-1)" class="bg-gray-300 px-3 py-1 rounded-lg hover:bg-gray-400">Previous</button>
            <span id="currentPageInfo" class="text-sm text-gray-600">Page 1</span>
            <button id="nextPage" onclick="changePage(1)" class="bg-gray-300 px-3 py-1 rounded-lg hover:bg-gray-400">Next</button>
        </div>
    </div>
    
    
    <div id="mahasiswaModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modalTitle" class="text-2xl font-semibold text-blue-700">Tambah Mahasiswa</h3>
                <button onclick="closeModal('mahasiswaModal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <form id="mahasiswaForm" onsubmit="saveMahasiswa(event)">
                <input type="hidden" id="mahasiswaId" value="">
                
                <h4 class="font-bold text-lg text-blue-700 mb-4">Data Akademik</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="nim" class="block text-sm font-medium text-gray-700">NIM</label>
                        <input type="text" id="nim" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="nama" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="prodi" class="block text-sm font-medium text-gray-700">Program Studi</label>
                        <select id="prodi" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Prodi</option>
                            <option value="Teknik Informatika">Teknik Informatika</option>
                            <option value="Teknik Industri">Teknik Industri</option>
                            <option value="Teknik Elektro">Teknik Elektro</option>
                            <option value="Teknik Mesin">Teknik Mesin</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="angkatan" class="block text-sm font-medium text-gray-700">Tahun Angkatan</label>
                        <input type="number" id="angkatan" required min="2000" max="2050" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="status_mhs" class="block text-sm font-medium text-gray-700">Status Mahasiswa</label>
                        <select id="status_mhs" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Aktif">Aktif</option>
                            <option value="Cuti">Cuti</option>
                            <option value="Lulus">Lulus</option>
                            <option value="DO">DO (Drop Out)</option>
                        </select>
                    </div>
                    <div>
                        <label for="dosen_wali_nidn" class="block text-sm font-medium text-gray-700">Dosen Wali (NIDN/Nama)</label>
                        <select id="dosen_wali_nidn" required class="mt-1 block w-full"></select>
                    </div>
                </div>
                
                <h4 class="font-bold text-lg text-blue-700 mt-6 mb-4">Data Personal & Kontak</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="tempat_lahir" class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                        <input type="text" id="tempat_lahir" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="tanggal_lahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                        <input type="date" id="tanggal_lahir" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="jenis_kelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                        <select id="jenis_kelamin" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="agama" class="block text-sm font-medium text-gray-700">Agama</label>
                        <select id="agama" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="Islam">Islam</option>
                            <option value="Kristen">Kristen</option>
                            <option value="Katolik">Katolik</option>
                            <option value="Hindu">Hindu</option>
                            <option value="Buddha">Buddha</option>
                            <option value="Konghucu">Konghucu</option>
                        </select>
                    </div>
                    <div>
                        <label for="no_telp" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
                        <input type="text" id="no_telp" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="email_mhs" class="block text-sm font-medium text-gray-700">Email Mahasiswa</label>
                        <input type="email" id="email_mhs" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <h4 class="font-bold text-lg text-blue-700 mt-6 mb-4">Alamat & Orang Tua</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat Lengkap</label>
                        <textarea id="alamat" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div>
                        <label for="kelurahan" class="block text-sm font-medium text-gray-700">Kelurahan</label>
                        <input type="text" id="kelurahan" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <label for="kecamatan" class="block text-sm font-medium text-gray-700 mt-2">Kecamatan</label>
                        <input type="text" id="kecamatan" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="nama_ayah" class="block text-sm font-medium text-gray-700">Nama Ayah</label>
                        <input type="text" id="nama_ayah" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="nama_ibu" class="block text-sm font-medium text-gray-700">Nama Ibu</label>
                        <input type="text" id="nama_ibu" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('mahasiswaModal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="detailModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-semibold text-blue-700">Detail Mahasiswa</h3>
                <button onclick="closeModal('detailModal')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modalContent" class="space-y-2">
                </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('detailModal')" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Tutup</button>
            </div>
        </div>
    </div>
    
  </main>
</div>


<script>
    // Inisialisasi Supabase (Harap Pastikan KEY Anda sudah benar)
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Variabel Global
    let currentPage = 1;
    const itemsPerPage = 10;
    let totalItems = 0;
    let editMode = false; // true untuk edit, false untuk tambah

    // ---------------------------------------------------------------------------------------------------
    // 🌟 MODIFIKASI JAVASCRIPT DIMULAI DI SINI: FUNGSI TOGGLE SUBMENU
    // ---------------------------------------------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('mahasiswa-toggle');
        const submenu = document.getElementById('mahasiswa-submenu');
        const chevron = document.getElementById('mahasiswa-chevron');

        // Di halaman mahasiswa.html, submenu otomatis terbuka
        // Jika Anda ingin submenu TIDAK terbuka otomatis, hapus 3 baris kode di bawah ini.
        submenu.classList.remove('hidden'); 
        chevron.classList.add('rotate-180');

        // Event listener untuk tombol toggle
        toggleButton.addEventListener('click', () => {
            submenu.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        });
        
        // Memastikan sidebar terbuka pada saat load jika menggunakan Tom Select
        checkAuthAndLoad(); 
    });
    
    // ---------------------------------------------------------------------------------------------------
    // 🌟 MODIFIKASI JAVASCRIPT BERAKHIR DI SINI
    // ---------------------------------------------------------------------------------------------------

    // --- LOGOUT ---
    async function logout() {
      const { error } = await supabaseClient.auth.signOut();
      if (error) {
        console.error('Logout Error:', error.message);
        alert('Gagal keluar sesi. Silakan coba lagi.');
      } else {
        window.location.href = "index.html";
      }
    }
    
    // --- CEK AUTHENTIKASI ---
    async function checkAuthAndLoad() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        const { data: userData } = await supabaseClient
            .from('users_metadata')
            .select('username')
            .eq('user_id', user.id)
            .single();

        if (userData?.username) {
            document.getElementById('userNameNav').textContent = 'Halo, ' + userData.username;
        }

        await loadDosenWaliOptions(); // Load Dosen Wali sebelum data mahasiswa
        loadMahasiswaData();
    }


    // --- LOAD MAHASISWA DATA ---
    async function loadMahasiswaData() {
        // ... (Fungsi loadMahasiswaData yang sudah ada) ...
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        // 1. Hitung total data untuk pagination
        const { count: totalCount, error: countError } = await supabaseClient
            .from('mahasiswa')
            .select('*', { count: 'exact', head: true });

        if (countError) {
            console.error('Count Error:', countError);
            return;
        }
        totalItems = totalCount;

        // 2. Ambil data dengan pagination dan filter
        const offset = (currentPage - 1) * itemsPerPage;
        let query = supabaseClient.from('mahasiswa')
            .select('*, dosen_wali:dosen_wali_nidn(nama)', { count: 'exact' })
            .order('nim', { ascending: true })
            .range(offset, offset + itemsPerPage - 1);

        if (searchInput) {
            query = query.or(`nim.ilike.%${searchInput}%,nama.ilike.%${searchInput}%,prodi.ilike.%${searchInput}%`);
        }
            
        const { data: mahasiswaData, error } = await query;
        
        if (error) {
            document.getElementById('mahasiswaTableBody').innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            console.error("Load Data Error:", error);
            return;
        }
        
        renderMahasiswaTable(mahasiswaData);
        updatePaginationInfo();
    }
    
    // --- RENDER TABLE ---
    function renderMahasiswaTable(data) {
        const tableBody = document.getElementById('mahasiswaTableBody');
        tableBody.innerHTML = '';
        
        if (!data || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Tidak ada data mahasiswa ditemukan.</td></tr>`;
            return;
        }

        data.forEach((mhs, index) => {
            const rowNumber = (currentPage - 1) * itemsPerPage + index + 1;
            const dosenWaliNama = mhs.dosen_wali ? mhs.dosen_wali.nama : 'N/A';
            
            tableBody.innerHTML += `
                <tr class="hover:bg-gray-50 transition-colors duration-100">
                    <td class="px-6 py-4 text-sm text-gray-500">${rowNumber}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${mhs.nim}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${mhs.nama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${mhs.prodi}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${mhs.angkatan}</td>
                    <td class="px-6 py-4 text-center text-sm font-medium space-x-2">
                        <button onclick="viewDetail(${mhs.id})" class="text-blue-600 hover:text-blue-900 transition-colors">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="openEditModal(${mhs.id})" class="text-yellow-600 hover:text-yellow-900 transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMahasiswa(${mhs.id})" class="text-red-600 hover:text-red-900 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // --- PAGINATION ---
    function updatePaginationInfo() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        document.getElementById('currentPageInfo').textContent = `Page ${currentPage} of ${totalPages || 1} (${totalItems} total)`;
        document.getElementById('prevPage').disabled = currentPage === 1;
        document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        
        document.getElementById('prevPage').classList.toggle('opacity-50', currentPage === 1);
        document.getElementById('nextPage').classList.toggle('opacity-50', currentPage === totalPages || totalPages === 0);
    }

    function changePage(delta) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            loadMahasiswaData();
        }
    }

    // --- MODAL & FORM LOGIC ---
    function openAddModal() {
        document.getElementById('mahasiswaForm').reset();
        document.getElementById('mahasiswaId').value = '';
        document.getElementById('modalTitle').textContent = 'Tambah Mahasiswa';
        document.getElementById('mahasiswaModal').style.display = 'flex';
        editMode = false;
        // Reset Tom Select (jika ada data lama)
        tsDosenWali.setValue('');
    }

    async function openEditModal(id) {
        const { data: mhs, error } = await supabaseClient
            .from('mahasiswa')
            .select('*')
            .eq('id', id)
            .single();

        if (error || !mhs) {
            alert('Gagal mengambil data mahasiswa untuk diedit.');
            console.error(error);
            return;
        }

        document.getElementById('nim').value = mhs.nim || '';
        document.getElementById('nama').value = mhs.nama || '';
        document.getElementById('prodi').value = mhs.prodi || '';
        document.getElementById('angkatan').value = mhs.angkatan || '';
        document.getElementById('status_mhs').value = mhs.status_mhs || 'Aktif'; // Default aktif
        
        // Data Personal
        document.getElementById('tempat_lahir').value = mhs.tempat_lahir || '';
        document.getElementById('tanggal_lahir').value = mhs.tanggal_lahir || '';
        document.getElementById('jenis_kelamin').value = mhs.jenis_kelamin || 'Laki-laki';
        document.getElementById('agama').value = mhs.agama || 'Islam';
        document.getElementById('no_telp').value = mhs.no_telp || '';
        document.getElementById('email_mhs').value = mhs.email_mhs || '';
        
        // Alamat & Ortu
        document.getElementById('alamat').value = mhs.alamat || '';
        document.getElementById('kelurahan').value = mhs.kelurahan || '';
        document.getElementById('kecamatan').value = mhs.kecamatan || '';
        document.getElementById('nama_ayah').value = mhs.nama_ayah || '';
        document.getElementById('nama_ibu').value = mhs.nama_ibu || '';
        
        // Set Tom Select Dosen Wali
        if (mhs.dosen_wali_nidn) {
             tsDosenWali.setValue(mhs.dosen_wali_nidn);
        } else {
             tsDosenWali.setValue('');
        }
        
        document.getElementById('mahasiswaId').value = id;
        document.getElementById('modalTitle').textContent = 'Edit Mahasiswa';
        document.getElementById('mahasiswaModal').style.display = 'flex';
        editMode = true;
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    async function saveMahasiswa(event) {
        event.preventDefault();
        
        const id = document.getElementById('mahasiswaId').value;
        const nim = document.getElementById('nim').value;
        const nama = document.getElementById('nama').value;
        const prodi = document.getElementById('prodi').value;
        const angkatan = document.getElementById('angkatan').value;
        const status_mhs = document.getElementById('status_mhs').value;
        const dosen_wali_nidn = document.getElementById('dosen_wali_nidn').value; 
        
        const dataToSave = {
            nim, nama, prodi, angkatan, status_mhs, 
            dosen_wali_nidn: dosen_wali_nidn || null, // Pastikan NULL jika kosong
            // Data Personal
            tempat_lahir: document.getElementById('tempat_lahir').value,
            tanggal_lahir: document.getElementById('tanggal_lahir').value,
            jenis_kelamin: document.getElementById('jenis_kelamin').value,
            agama: document.getElementById('agama').value,
            no_telp: document.getElementById('no_telp').value,
            email_mhs: document.getElementById('email_mhs').value,
            // Alamat & Ortu
            alamat: document.getElementById('alamat').value,
            kelurahan: document.getElementById('kelurahan').value,
            kecamatan: document.getElementById('kecamatan').value,
            nama_ayah: document.getElementById('nama_ayah').value,
            nama_ibu: document.getElementById('nama_ibu').value,
        };

        let result;
        if (editMode) {
            result = await supabaseClient.from('mahasiswa').update(dataToSave).eq('id', id);
        } else {
            result = await supabaseClient.from('mahasiswa').insert([dataToSave]);
        }
        
        if (result.error) {
            alert(`❌ Gagal ${editMode ? 'mengubah' : 'menambah'} data: ` + result.error.message);
            console.error(result.error);
        } else {
            alert(`✅ Data mahasiswa berhasil di${editMode ? 'ubah' : 'tambahkan'}!`);
            closeModal('mahasiswaModal');
            loadMahasiswaData(); // Refresh data
        }
    }

    async function deleteMahasiswa(id) {
        if (!confirm('Yakin ingin menghapus data mahasiswa ini?')) return;
        
        const { error } = await supabaseClient.from('mahasiswa').delete().eq('id', id);
        
        if (error) {
            alert('❌ Gagal menghapus data: ' + error.message);
            console.error(error);
        } else {
            alert('✅ Data mahasiswa berhasil dihapus!');
            loadMahasiswaData(); // Refresh data
        }
    }
    
    // --- VIEW DETAIL ---
    async function viewDetail(id) {
        const { data: mhs, error } = await supabaseClient
            .from('mahasiswa')
            .select('*, dosen_wali:dosen_wali_nidn(nama, nidn)') // Join dengan nama dosen
            .eq('id', id)
            .single();

        if (error || !mhs) {
            alert('Gagal mengambil detail data mahasiswa.');
            console.error(error);
            return;
        }
        
        const dosenWaliNama = mhs.dosen_wali ? `${mhs.dosen_wali.nama} (${mhs.dosen_wali.nidn})` : '-';

        const modalContent = `
            <h4 class="font-bold text-xl text-blue-700 mb-2">Data Akademik</h4>
            <p><span class="font-bold w-40 inline-block">NIM</span>: ${mhs.nim || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Nama Lengkap</span>: ${mhs.nama || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Program Studi</span>: ${mhs.prodi || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Tahun Angkatan</span>: ${mhs.angkatan || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Status Mahasiswa</span>: 
               <span class="font-semibold ${mhs.status_mhs === 'Aktif' ? 'text-green-600' : 'text-red-600'}">${mhs.status_mhs || '-'}</span>
            </p>
            <p><span class="font-bold w-40 inline-block">Dosen Wali</span>: ${dosenWaliNama}</p>
            
            <h4 class="font-bold text-xl text-blue-700 mt-4 mb-2">Data Personal</h4>
            <p><span class="font-bold w-40 inline-block">TTL</span>: ${mhs.tempat_lahir || '-'}, ${mhs.tanggal_lahir || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Jenis Kelamin</span>: ${mhs.jenis_kelamin || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Agama</span>: ${mhs.agama || '-'}</p>
            <p><span class="font-bold w-40 inline-block">No. Telp</span>: ${mhs.no_telp || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Email</span>: ${mhs.email_mhs || '-'}</p>
            
            <h4 class="font-bold text-xl text-blue-700 mt-4 mb-2">Alamat & Orang Tua</h4>
            <p><span class="font-bold w-40 inline-block">Alamat</span>: ${mhs.alamat || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Kelurahan/Kecamatan</span>: ${mhs.kelurahan || '-'} / ${mhs.kecamatan || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Nama Ayah</span>: ${mhs.nama_ayah || '-'}</p>
            <p><span class="font-bold w-40 inline-block">Nama Ibu</span>: ${mhs.nama_ibu || '-'}</p>
        `;

        document.getElementById('modalContent').innerHTML = modalContent;
        document.getElementById('detailModal').classList.remove('hidden');
    }
    
    // --- SETUP TOM-SELECT FOR DOSEN WALI ---
    let tsDosenWali;
    
    async function loadDosenWaliOptions() {
        const { data: dosenData, error } = await supabaseClient
            .from('dosen')
            .select('nidn, nama')
            .order('nama', { ascending: true });

        if (error) {
            console.error("Gagal memuat Dosen Wali:", error);
            return;
        }

        const options = dosenData.map(d => ({
            value: d.nidn,
            text: `${d.nama} (${d.nidn})`
        }));
        
        // Inisialisasi Tom Select
        if (tsDosenWali) {
            tsDosenWali.destroy(); // Hancurkan instance lama jika ada
        }
        
        tsDosenWali = new TomSelect('#dosen_wali_nidn',{
            create: false,
            sortField: {field: "text", direction: "asc"},
            options: options,
            placeholder: 'Pilih Dosen Wali',
            valueField: 'value',
            labelField: 'text',
            searchField: ['text']
        });
    }

    // --- EXPORT LOGIC (Excel dan PDF) ---
    async function exportToExcel() {
        // Ambil SEMUA data (tanpa pagination) untuk diexport
        const { data: allData, error } = await supabaseClient
            .from('mahasiswa')
            .select('*, dosen_wali:dosen_wali_nidn(nama)')
            .order('nim', { ascending: true });

        if (error) {
            alert('Gagal mengambil data untuk Export: ' + error.message);
            return;
        }
        
        const header = ["NIM", "Nama", "Prodi", "Angkatan", "Status", "Dosen Wali", "Tempat Lahir", "Tanggal Lahir", "Jenis Kelamin", "Agama", "No. Telp", "Email", "Alamat", "Kelurahan", "Kecamatan", "Nama Ayah", "Nama Ibu"];
        
        const dataForExport = allData.map(mhs => [
            mhs.nim,
            mhs.nama,
            mhs.prodi,
            mhs.angkatan,
            mhs.status_mhs,
            mhs.dosen_wali ? mhs.dosen_wali.nama : 'N/A',
            mhs.tempat_lahir,
            mhs.tanggal_lahir,
            mhs.jenis_kelamin,
            mhs.agama,
            mhs.no_telp,
            mhs.email_mhs,
            mhs.alamat,
            mhs.kelurahan,
            mhs.kecamatan,
            mhs.nama_ayah,
            mhs.nama_ibu
        ]);

        const ws = XLSX.utils.aoa_to_sheet([header, ...dataForExport]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Mahasiswa");
        XLSX.writeFile(wb, "Data_Mahasiswa_FT.xlsx");
    }

    async function exportToPDF() {
         // Ambil SEMUA data (tanpa pagination) untuk diexport
        const { data: allData, error } = await supabaseClient
            .from('mahasiswa')
            .select('*, dosen_wali:dosen_wali_nidn(nama)')
            .order('nim', { ascending: true });

        if (error) {
            alert('Gagal mengambil data untuk Export: ' + error.message);
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape'); // Menggunakan orientasi landscape

        doc.setFontSize(16);
        doc.text("Data Mahasiswa Fakultas Teknik", 148.5, 15, null, null, "center"); // Tengah halaman landscape
        
        const tableColumn = ["No", "NIM", "Nama", "Prodi", "Angkatan", "Status", "Dosen Wali"];
        const tableRows = [];

        allData.forEach((mhs, index) => {
            const rowData = [
                index + 1,
                mhs.nim,
                mhs.nama,
                mhs.prodi,
                mhs.angkatan,
                mhs.status_mhs,
                mhs.dosen_wali ? mhs.dosen_wali.nama : 'N/A'
            ];
            tableRows.push(rowData);
        });
        
        doc.autoTable(tableColumn, tableRows, { 
            startY: 25,
            headStyles: { fillColor: [30, 64, 175], textColor: 255 }, // Warna biru tua
            styles: { fontSize: 8, cellPadding: 2 },
            margin: { top: 10, bottom: 10, left: 10, right: 10 },
        });

        doc.save(`Data_Mahasiswa_FT_${new Date().toISOString().slice(0, 10)}.pdf`);
    }

</script>
</body>
</html>
