<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Jadwal Kuliah</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto mt-10 bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">ðŸ“… Manajemen Jadwal Kuliah</h1>

    <!-- Form Tambah Jadwal -->
    <div class="mb-6 border p-4 rounded bg-gray-50">
      <h2 class="font-semibold mb-2">Tambah Jadwal</h2>
      <div class="grid grid-cols-3 gap-2">
        <input id="kode" placeholder="Kode Matkul" class="border p-2 rounded">
        <select id="prodi" class="border p-2 rounded"></select>
        <select id="hari" class="border p-2 rounded"></select>
        <input id="jam_mulai" placeholder="Jam Mulai (08:00)" class="border p-2 rounded">
        <input id="jam_akhir" placeholder="Jam Akhir (09:40)" class="border p-2 rounded">
        <select id="mata_kuliah" class="border p-2 rounded"></select>
        <input id="sks" type="number" placeholder="SKS" class="border p-2 rounded">
        <select id="dosen" class="border p-2 rounded"></select>
        <select id="asisten" class="border p-2 rounded"></select>
        <select id="semester" class="border p-2 rounded"></select>
        <select id="kelas" class="border p-2 rounded"></select>
        <select id="ruangan" class="border p-2 rounded"></select>
      </div>
      <button onclick="simpanJadwal()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tambah</button>
    </div>

    <!-- Tabel Jadwal -->
    <div>
      <h2 class="font-semibold mb-2">Daftar Jadwal</h2>
      <table class="min-w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">Kode</th>
            <th class="border p-2">Prodi</th>
            <th class="border p-2">Hari</th>
            <th class="border p-2">Jam</th>
            <th class="border p-2">Mata Kuliah</th>
            <th class="border p-2">SKS</th>
            <th class="border p-2">Dosen</th>
            <th class="border p-2">Asisten</th>
            <th class="border p-2">Semester</th>
            <th class="border p-2">Kelas</th>
            <th class="border p-2">Ruangan</th>
          </tr>
        </thead>
        <tbody id="tabel-jadwal"></tbody>
      </table>
    </div>
  </div>

  <script>
    // --- KONFIGURASI SUPABASE ---
    const supabaseUrl = "https://YOUR_PROJECT_URL.supabase.co"; // Ganti dengan URL kamu
    const supabaseKey = "YOUR_ANON_KEY"; // Ganti dengan anon key kamu
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // --- Ambil Data Jadwal ---
    async function loadData() {
      const { data, error } = await supabaseClient.from("jadwal").select("*");
      if (error) {
        console.error("Gagal memuat data:", error);
        return;
      }

      const tbody = document.getElementById("tabel-jadwal");
      tbody.innerHTML = "";

      data.forEach(j => {
        const row = `
          <tr>
            <td class="border p-2">${j.kode || ""}</td>
            <td class="border p-2">${j.prodi || ""}</td>
            <td class="border p-2">${j.hari || ""}</td>
            <td class="border p-2">${j.jam_mulai || ""} - ${j.jam_akhir || ""}</td>
            <td class="border p-2">${j.mata_kuliah || ""}</td>
            <td class="border p-2">${j.sks || ""}</td>
            <td class="border p-2">${j.dosen || ""}</td>
            <td class="border p-2">${j.asisten || ""}</td>
            <td class="border p-2">${j.semester || ""}</td>
            <td class="border p-2">${j.kelas || ""}</td>
            <td class="border p-2">${j.ruangan || ""}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // --- Simpan Jadwal Baru ---
    async function simpanJadwal() {
      const jadwal = {
        kode: document.getElementById("kode").value,
        prodi: document.getElementById("prodi").value,
        hari: document.getElementById("hari").value,
        jam_mulai: document.getElementById("jam_mulai").value,
        jam_akhir: document.getElementById("jam_akhir").value,
        mata_kuliah: document.getElementById("mata_kuliah").value,
        sks: document.getElementById("sks").value,
        dosen: document.getElementById("dosen").value,
        asisten: document.getElementById("asisten").value,
        semester: document.getElementById("semester").value,
        kelas: document.getElementById("kelas").value,
        ruangan: document.getElementById("ruangan").value
      };

      const { error } = await supabaseClient.from("jadwal").insert([jadwal]);
      if (error) {
        alert("Gagal menambah jadwal: " + error.message);
      } else {
        alert("Jadwal berhasil ditambahkan!");
        loadData();
      }
    }

    // --- Ambil data dropdown dari tabel referensi ---
    async function loadDropdownData() {
      const dropdowns = [
        { id: "prodi", table: "prodi", column: "nama_prodi" },
        { id: "hari", table: "hari", column: "nama_hari" },
        { id: "mata_kuliah", table: "mata_kuliah", column: "nama" },
        { id: "dosen", table: "dosen", column: "nama" },
        { id: "asisten", table: "asisten", column: "nama" },
        { id: "semester", table: "semester", column: "nama_semester" },
        { id: "kelas", table: "kelas", column: "nama_kelas" },
        { id: "ruangan", table: "ruangan", column: "nama_ruangan" },
      ];

      for (const d of dropdowns) {
        const { data, error } = await supabaseClient.from(d.table).select(`id, ${d.column}`);
        if (error) {
          console.error(`Gagal memuat ${d.table}`, error);
          continue;
        }

        const select = document.getElementById(d.id);
        select.innerHTML = `<option value="">Pilih ${d.table}</option>`;
        data.forEach(item => {
          select.innerHTML += `<option value="${item[d.column]}">${item[d.column]}</option>`;
        });
      }
    }

    // --- Saat Halaman Dibuka ---
    window.onload = async () => {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      if (!user) {
        alert("Silakan login dulu!");
        window.location.href = "index.html";
        return;
      }
      await loadDropdownData();
      loadData();
    };
  </script>
</body>
</html>
