<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* Styling Seragam dengan Dosen.html */
    .active-link { 
        background-color: #1d4ed8; 
        color: white; 
        border-left: 4px solid #f97316; 
    }
    .modal { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.5); 
        justify-content: center; 
        align-items: center; 
        z-index: 50; 
    }
    .modal-content { 
        background: white; 
        padding: 1.5rem; 
        border-radius: 0.75rem; 
        width: 90%; 
        max-width: 600px; 
        max-height: 90vh; 
        overflow-y: auto; 
    }
    /* Tinggi layar penuh diatur untuk konten utama */
    .main-content {
        height: calc(100vh - 4rem); /* 100vh minus tinggi header/navbar */
    }

  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
  <div class="flex items-center space-x-3">
    <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
    <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
  </div>
  <div class="flex items-center space-x-4">
    <span id="userNameNav" class="text-white text-sm">Halo, AkademikFT</span>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition">
      <i class="fas fa-sign-out-alt mr-1"></i> Ganti Akun
    </button>
  </div>
</nav>

<div class="flex pt-16 main-content">
  <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 shadow-xl">
    <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
      <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300"><i class="fas fa-tachometer-alt w-5"></i><span>Dashboard</span></a>
      <a href="main.html" class="active-link flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-calendar-alt w-5"></i><span>Penjadwalan</span></a>
      <a href="mahasiswa.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300"><i class="fas fa-address-card w-5"></i><span>Biodata Mahasiswa</span></a>
      <a href="dosen.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300"><i class="fas fa-user-tie w-5"></i><span>Data Dosen</span></a>
      <a href="dashboard.html#matkul" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300"><i class="fas fa-book w-5"></i><span>Data Mata Kuliah</span></a>
      <a href="dashboard.html#pengaturan" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300"><i class="fas fa-cog w-5"></i><span>Pengaturan</span></a>
    </nav>
    <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
      <p>&copy; 2024 Akademik FT</p>
      <p>Designed by Rifqi & Alfi</p>
    </div>
  </aside>

  <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Manajemen Penjadwalan Kuliah</h1>

      <div class="bg-white p-4 rounded-lg shadow mb-6">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">Filter Jadwal</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label class="block text-sm text-gray-600 mb-1">Program Studi</label>
            <select id="filterProdi" onchange="applyFilter()" class="w-full border border-gray-300 rounded-md p-2">
                <option value="">Semua Prodi</option>
                <option value="Industri">Industri</option>
                <option value="Sipil">Sipil</option>
                <option value="Arsitektur">Arsitektur</option>
                <option value="Elektro">Elektro</option>
                <option value="Informatika">Informatika</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Semester</label>
            <select id="filterSemester" onchange="applyFilter()" class="w-full border border-gray-300 rounded-md p-2">
                <option value="">Semua Semester</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-600 mb-1">Hari</label>
            <select id="filterHari" onchange="applyFilter()" class="w-full border border-gray-300 rounded-md p-2">
                <option value="">Semua Hari</option>
                <option value="Senin">Senin</option>
                <option value="Selasa">Selasa</option>
                <option value="Rabu">Rabu</option>
                <option value="Kamis">Kamis</option>
                <option value="Jumat">Jumat</option>
                <option value="Sabtu">Sabtu</option>
            </select>
          </div>
          <div class="flex space-x-2">
             <button onclick="resetFilter()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md"><i class="fas fa-undo mr-2"></i>Reset Filter</button>
          </div>
        </div>
        <div class="mt-4 flex space-x-2 justify-end">
            <button onclick="exportAllToPdf()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md"><i class="fas fa-file-pdf mr-2"></i>PDF Semua</button>
            <button onclick="exportAllToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md"><i class="fas fa-file-excel mr-2"></i>Excel Semua</button>
        </div>
      </div>


      <div class="bg-white p-6 rounded-lg shadow-lg">
        <div class="flex justify-between mb-4">
          <h2 class="text-2xl font-semibold text-gray-700">Daftar Jadwal Kuliah</h2>
          <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md"><i class="fas fa-plus-circle mr-2"></i>Tambah Jadwal</button>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prodi</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Semester</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kode Matkul</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mata Kuliah</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kelas</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKS</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dosen</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hari</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ruangan</th>
                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
              </tr>
            </thead>
            <tbody id="jadwal-table-body" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="12" class="text-center py-4 text-gray-500">Memuat data...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="jadwalModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle" class="text-2xl font-semibold mb-4">Tambah Jadwal</h2>
    <form id="jadwalForm" class="space-y-3">
      <input type="hidden" id="jadwalId">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        
        <select id="prodi" class="border p-2 rounded w-full">
            <option value="" disabled selected>Program Studi</option>
            <option value="Industri">Industri</option>
            <option value="Sipil">Sipil</option>
            <option value="Arsitektur">Arsitektur</option>
            <option value="Elektro">Elektro</option>
            <option value="Informatika">Informatika</option>
        </select>
        
        <select id="semester" class="border p-2 rounded w-full">
            <option value="" disabled selected>Semester</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
        </select>
        
        <select id="kode_matkul" class="border p-2 rounded w-full" placeholder="Cari Kode Matkul"></select>
        
        <input id="kelas" class="border p-2 rounded" placeholder="Kelas (A/B/C)">
        
        <select id="dosen" class="border p-2 rounded w-full" placeholder="Cari Dosen"></select>

        <select id="hari" class="border p-2 rounded w-full">
            <option value="" disabled selected>Hari</option>
            <option value="Senin">Senin</option>
            <option value="Selasa">Selasa</option>
            <option value="Rabu">Rabu</option>
            <option value="Kamis">Kamis</option>
            <option value="Jumat">Jumat</option>
            <option value="Sabtu">Sabtu</option>
        </select>

        <input id="waktu_mulai" type="time" class="border p-2 rounded">
        <input id="waktu_selesai" type="time" class="border p-2 rounded">
        
        <input id="ruangan" class="border p-2 rounded" placeholder="Ruangan (cth: R201)">
        
      </div>
      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" onclick="closeModal()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">Batal</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Simpan</button>
      </div>
    </form>
  </div>
</div>


<script>
const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const { jsPDF } = window.jspdf;

let allJadwalData = [];
let allDosenData = [];
let allMatkulData = [];
let editMode = false;

// TomSelect instances
let tomSelectDosen;
let tomSelectMatkul;


document.addEventListener("DOMContentLoaded", initialize);
document.getElementById("jadwalForm").addEventListener("submit", saveJadwal);

async function initialize() {
    await checkAuthAndLoad();
    await loadDosenAndMatkul();
    await loadJadwalData();
}

// Mengambil data dari users_metadata untuk username di navbar
async function checkAuthAndLoad() {
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
        window.location.href = "index.html";
        return;
    }
    
    const { data: userData } = await supabaseClient
        .from('users_metadata')
        .select('username')
        .eq('user_id', user.id)
        .single();

    if (userData && userData.username) {
        document.getElementById('userNameNav').textContent = `Halo, ${userData.username}`;
    }
}


async function loadDosenAndMatkul() {
    // Muat Data Dosen
    let { data: dosenData, error: dosenError } = await supabaseClient
        .from('dosen')
        .select('nidn, nama')
        .order('nama');

    if (dosenError) {
        console.error("Gagal memuat data dosen:", dosenError);
        // Lanjutkan saja, TomSelect akan kosong
        return;
    }
    allDosenData = dosenData.map(d => ({ value: d.nidn, text: `${d.nama} (${d.nidn})` }));

    // Muat Data Mata Kuliah
    let { data: matkulData, error: matkulError } = await supabaseClient
        .from('matakuliah')
        .select('kode_matkul, nama_matkul, sks, semester, prodi')
        .order('nama_matkul');

    if (matkulError) {
        console.error("Gagal memuat data mata kuliah:", matkulError);
        return;
    }
    allMatkulData = matkulData.map(m => ({ 
        value: m.kode_matkul, 
        text: `${m.kode_matkul} - ${m.nama_matkul} (${m.sks} SKS, Smtr ${m.semester}, ${m.prodi})`,
        data: m // Simpan data matkul penuh untuk referensi
    }));

    // Inisialisasi TomSelect
    initializeTomSelect();
}

function initializeTomSelect() {
    // Hapus TomSelect yang sudah ada jika ada (penting untuk mode Edit/Load ulang)
    if (tomSelectDosen) tomSelectDosen.destroy();
    if (tomSelectMatkul) tomSelectMatkul.destroy();

    // 1. TomSelect untuk Dosen
    tomSelectDosen = new TomSelect("#dosen", {
        valueField: 'value',
        labelField: 'text',
        searchField: 'text',
        options: allDosenData,
        create: false,
        placeholder: "Pilih atau Cari Dosen (NIDN/Nama)"
    });

    // 2. TomSelect untuk Mata Kuliah
    tomSelectMatkul = new TomSelect("#kode_matkul", {
        valueField: 'value',
        labelField: 'text',
        searchField: ['value', 'text'],
        options: allMatkulData,
        create: false,
        placeholder: "Pilih atau Cari Mata Kuliah (Kode/Nama)"
    });
}

function closeModal(modalId = 'jadwalModal') {
  document.getElementById(modalId).style.display = "none";
}

function openModal() {
  document.getElementById("jadwalForm").reset();
  document.getElementById("jadwalId").value = "";
  document.getElementById("modalTitle").textContent = "Tambah Jadwal";
  
  // Reset TomSelects
  tomSelectDosen.clear(true);
  tomSelectMatkul.clear(true);

  // Reset dropdowns 
  document.getElementById("prodi").value = ""; 
  document.getElementById("semester").value = ""; 
  document.getElementById("hari").value = "";

  document.getElementById("jadwalModal").style.display = "flex";
  editMode = false;
}

const toNullIfEmpty = (val) => {
    if (typeof val === 'string') {
        const trimmedVal = val.trim();
        // Mengubah string kosong atau placeholder select menjadi null
        return trimmedVal === "" || trimmedVal.includes("Pilih") || trimmedVal.includes("Program Studi") || trimmedVal.includes("Semester") || trimmedVal.includes("Hari") ? null : trimmedVal;
    }
    return val;
};


// ----------------------------------------------------
// ✅ FUNGSI PENTING: loadJadwalData (DIKOREKSI)
// ----------------------------------------------------
async function loadJadwalData() {
  const tbody = document.getElementById("jadwal-table-body");
  tbody.innerHTML = `<tr><td colspan="12" class="text-center py-4">Memuat data...</td></tr>`;
  
  // MENGGUNAKAN Left Join STANDAR untuk keamanan data (menghapus !inner)
  const { data, error } = await supabaseClient
      .from("jadwal")
      .select(`
          *,
          matakuliah(nama_matkul, sks),
          dosen(nama)
      `)
      .order("prodi", { ascending: true })
      .order("semester", { ascending: true })
      .order("hari", { ascending: true }); // Order by hari (nama hari)

  if (error) {
      console.error("❌ Gagal memuat data jadwal:", error);
      alert("❌ ERROR MEMUAT DATA. Pesan: " + error.message + ". Pastikan RLS di tabel jadwal di Supabase sudah diizinkan (SELECT).");
      tbody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-red-500">Gagal memuat data. Pesan Error: ${error.message}. Cek Console!</td></tr>`;
      return;
  }
  
  allJadwalData = data;
  renderTable(data);
}

function renderTable(data) {
  const tbody = document.getElementById("jadwal-table-body");
  if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-gray-500">Data jadwal tidak ditemukan.</td></tr>`;
      return;
  }
  
  let counter = 1;
  tbody.innerHTML = data.map(j => `
    <tr class="hover:bg-gray-100">
      <td class="px-3 py-3 text-center">${counter++}</td>
      <td class="px-3 py-3">${j.prodi || '-'}</td>
      <td class="px-3 py-3 text-center">${j.semester || '-'}</td>
      <td class="px-3 py-3">${j.kode_matkul || '-'}</td>
      <td class="px-3 py-3">${j.matakuliah?.nama_matkul || '-'}</td>
      <td class="px-3 py-3 text-center">${j.kelas || '-'}</td>
      <td class="px-3 py-3 text-center">${j.matakuliah?.sks || '-'}</td>
      <td class="px-3 py-3">${j.dosen?.nama || '-'}</td>
      <td class="px-3 py-3">${j.hari || '-'}</td>
      <td class="px-3 py-3">${j.waktu_mulai || '-'} - ${j.waktu_selesai || '-'}</td>
      <td class="px-3 py-3 text-center">${j.ruangan || '-'}</td>
      <td class="px-3 py-3 text-center space-x-2">
        <button class="text-yellow-600 hover:text-yellow-800" onclick="editJadwal('${j.id}')" title="Edit"><i class="fas fa-edit"></i></button>
        <button class="text-red-600 hover:text-red-800" onclick="deleteJadwal('${j.id}')" title="Hapus"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`).join('');
}


// ----------------------------------------------------
// ✅ FUNGSI PENTING: saveJadwal (DIKOREKSI)
// ----------------------------------------------------
async function saveJadwal(e) {
  e.preventDefault();
  
  const prodi = document.getElementById("prodi").value;
  const semester = document.getElementById("semester").value;
  const kode_matkul = document.getElementById("kode_matkul").value;
  const nidn = document.getElementById("dosen").value;
  const hari = document.getElementById("hari").value;
  const waktu_mulai = document.getElementById("waktu_mulai").value;
  const waktu_selesai = document.getElementById("waktu_selesai").value;
  const kelas = document.getElementById("kelas").value;
  const ruangan = document.getElementById("ruangan").value;

  // Cek validasi dasar
  if (!prodi || !semester || !kode_matkul || !nidn || !hari || !waktu_mulai || !waktu_selesai || !kelas || !ruangan) {
    alert("❌ Harap lengkapi semua bidang wajib.");
    return;
  }

  // Mendapatkan SKS dari data matkul yang tersimpan
  const selectedMatkul = allMatkulData.find(m => m.value === kode_matkul);
  // Ambil SKS, pastikan nilainya adalah integer (atau null)
  const sks = selectedMatkul ? parseInt(selectedMatkul.data.sks) : null; 


  // Tentukan urutan hari (optional, hanya jika kolom hari_urut ada dan bertipe integer)
  const hariOrder = { "Senin": 1, "Selasa": 2, "Rabu": 3, "Kamis": 4, "Jumat": 5, "Sabtu": 6 };
  const hari_urut = hariOrder[hari] || null;

  const jadwalData = {
    prodi: toNullIfEmpty(prodi), 
    // Konversi semester ke integer untuk database
    semester: parseInt(toNullIfEmpty(semester)) || null, 
    kode_matkul: toNullIfEmpty(kode_matkul),
    nidn: toNullIfEmpty(nidn),
    kelas: toNullIfEmpty(kelas),
    ruangan: toNullIfEmpty(ruangan),
    hari: toNullIfEmpty(hari),
    waktu_mulai: toNullIfEmpty(waktu_mulai),
    waktu_selesai: toNullIfEmpty(waktu_selesai),
    sks: sks, 
    hari_urut: hari_urut
  };
  
  let result;
  
  // Filter data yang null/undefined agar Supabase tidak error karena nilai yang tidak valid
  const payloadData = Object.fromEntries(
    Object.entries(jadwalData).filter(([k, v]) => v !== undefined && v !== null)
  );
  
  // Masukkan kembali nilai yang harus null agar proses update/insert berjalan lancar
  if (jadwalData.hari_urut === null) payloadData.hari_urut = null;
  if (jadwalData.sks === null) payloadData.sks = null;
  if (jadwalData.semester === null) payloadData.semester = null;

  try {
      if (editMode) {
        result = await supabaseClient.from("jadwal").update(payloadData).eq("id", document.getElementById("jadwalId").value).select();
      } else {
        result = await supabaseClient.from("jadwal").insert([payloadData]).select();
      }
      
      if (result.error) {
          throw result.error;
      }

      alert(editMode ? "✅ Data jadwal berhasil diperbarui!" : "✅ Jadwal baru berhasil ditambahkan!");
      closeModal('jadwalModal');
      loadJadwalData(); 

  } catch (error) {
       alert("❌ Operasi GAGAL. Pesan: " + error.message + ". Cek RLS (INSERT/UPDATE) atau kolom database.");
       console.error("Supabase Operation Error:", error);
  }
}

async function editJadwal(id) {
  const jadwal = allJadwalData.find(j => j.id == id);
  if (!jadwal) return;
  
  document.getElementById("prodi").value = jadwal.prodi || ""; 
  document.getElementById("semester").value = jadwal.semester || ""; 
  document.getElementById("kelas").value = jadwal.kelas || "";
  document.getElementById("ruangan").value = jadwal.ruangan || "";
  document.getElementById("hari").value = jadwal.hari || "";
  document.getElementById("waktu_mulai").value = jadwal.waktu_mulai || "";
  document.getElementById("waktu_selesai").value = jadwal.waktu_selesai || "";

  // Set TomSelect untuk Matkul
  tomSelectMatkul.clear(true);
  if (jadwal.kode_matkul) {
    tomSelectMatkul.addItem(jadwal.kode_matkul);
  }

  // Set TomSelect untuk Dosen
  tomSelectDosen.clear(true);
  if (jadwal.nidn) {
    tomSelectDosen.addItem(jadwal.nidn);
  }
  
  document.getElementById("jadwalId").value = id;
  document.getElementById("modalTitle").textContent = "Edit Jadwal";
  document.getElementById("jadwalModal").style.display = "flex";
  editMode = true;
}


async function deleteJadwal(id) {
  if (!confirm("Yakin ingin menghapus jadwal ini?")) return;
  const { error } = await supabaseClient.from("jadwal").delete().eq("id", id);
  
  if (error) {
       alert("❌ Gagal menghapus: " + error.message);
       console.error("Hapus Error:", error);
  } else {
       alert("✅ Data berhasil dihapus!");
       loadJadwalData();
  }
}

function applyFilter() {
  const prodiVal = document.getElementById("filterProdi").value;
  const semesterVal = document.getElementById("filterSemester").value;
  const hariVal = document.getElementById("filterHari").value;

  const filtered = allJadwalData.filter(j =>
    (!prodiVal || j.prodi === prodiVal) &&
    (!semesterVal || j.semester == semesterVal) &&
    (!hariVal || j.hari === hariVal)
  );
  renderTable(filtered);
}

function resetFilter() {
  document.getElementById("filterProdi").value = "";
  document.getElementById("filterSemester").value = "";
  document.getElementById("filterHari").value = "";
  renderTable(allJadwalData);
}

// ---------------------------
// FUNGSI EKSPOR
// ---------------------------

const prodiColors = {
    "Industri": { header: [255, 165, 0], text: 0 },   
    "Sipil": { header: [0, 128, 0], text: 255 },       
    "Arsitektur": { header: [128, 0, 128], text: 255 }, 
    "Elektro": { header: [0, 0, 255], text: 255 },     
    "Informatika": { header: [255, 0, 0], text: 255 }, 
    "LAINNYA": { header: [108, 117, 125], text: 255 }, // Dark Grey
    "Default": { header: [44, 62, 80], text: 255 } 
};

// Fungsi exportAllToPdf sudah aman
function exportAllToPdf() {
    if (allJadwalData.length === 0) return alert("Tidak ada data jadwal untuk diekspor.");
    if (typeof jsPDF === 'undefined') return alert("Library jsPDF belum dimuat. Cek koneksi internet, hard refresh.");

    const doc = new jsPDF('l', 'mm', 'a4'); // 'l' untuk Landscape
    
    // Kelompokkan data berdasarkan Prodi
    const groupedData = allJadwalData.reduce((acc, curr) => {
        const prodi = curr.prodi || 'LAINNYA';
        if (!acc[prodi]) acc[prodi] = [];
        acc[prodi].push(curr);
        return acc;
    }, {});

    const prodiKeys = Object.keys(groupedData).sort();
    let finalY = 10;
    const pageMargin = 10;

    const headers = ["#", "Prodi", "Smstr", "Kode", "Mata Kuliah", "Kelas", "SKS", "Dosen", "Hari", "Mulai", "Selesai", "Ruangan"];
    
    // Definisikan lebar kolom
    const columnStyles = {
        0: { halign: 'center', cellWidth: 7 }, 
        1: { halign: 'center', cellWidth: 20 }, 
        2: { halign: 'center', cellWidth: 15 }, 
        3: { halign: 'center', cellWidth: 20 }, 
        4: { halign: 'left', cellWidth: 40 }, 
        5: { halign: 'center', cellWidth: 15 }, 
        6: { halign: 'center', cellWidth: 10 }, 
        7: { halign: 'left', cellWidth: 35 }, 
        8: { halign: 'center', cellWidth: 20 }, 
        9: { halign: 'center', cellWidth: 15 }, 
        10: { halign: 'center', cellWidth: 15 }, 
        11: { halign: 'center', cellWidth: 15 }, 
    };

    prodiKeys.forEach((prodi, index) => {
        const dataProdi = groupedData[prodi];
        const rows = dataProdi.map((j, i) => [
            i + 1,
            j.prodi || '-',
            j.semester || '-',
            j.kode_matkul || '-',
            j.matakuliah?.nama_matkul || '-',
            j.kelas || '-',
            j.matakuliah?.sks || '-',
            j.dosen?.nama || '-',
            j.hari || '-',
            j.waktu_mulai || '-',
            j.waktu_selesai || '-',
            j.ruangan || '-'
        ]);

        const prodiColor = prodiColors[prodi] || prodiColors.Default;
        let startY = finalY + 5;

        // Tambahkan halaman baru jika tidak cukup ruang
        if (startY > doc.internal.pageSize.height - 30 && index > 0) {
            doc.addPage('a4', 'l');
            finalY = 10;
            startY = finalY + 5;
        }

        // Judul Prodi
        doc.setFontSize(14);
        doc.setTextColor(prodiColor.header[0], prodiColor.header[1], prodiColor.header[2]);
        doc.text(`JADWAL KULIAH - PRODI ${prodi.toUpperCase()}`, pageMargin, finalY += 10);
        finalY += 3; // Tambah jarak sebelum tabel

        // Tabel
        doc.autoTable({
            startY: finalY,
            head: [headers],
            body: rows,
            theme: 'striped',
            styles: { fontSize: 8, cellPadding: 1.5, halign: 'left' },
            margin: { left: pageMargin, right: pageMargin }, 
            headStyles: { 
                fillColor: prodiColor.header, 
                textColor: prodiColor.text, 
                fontStyle: 'bold', 
                halign: 'center' 
            },
            columnStyles: columnStyles
        });

        // Update finalY untuk memulai tabel berikutnya
        finalY = doc.autoTable.previous.finalY;
    });
    
    // Penambahan Header/Footer Halaman (Dilakukan secara manual di akhir)
    const pageCount = doc.internal.pages.length;
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(`Halaman ${i} dari ${pageCount}`, pageMargin, doc.internal.pageSize.height - 5);
        doc.text("Jadwal Kuliah Fakultas Teknik", doc.internal.pageSize.width - pageMargin, doc.internal.pageSize.height - 5, null, null, "right");
    }

    doc.save("Jadwal_Kuliah_Fakultas_Teknik.pdf");
}

function exportAllToExcel() {
    if (allJadwalData.length === 0) return alert("Tidak ada data jadwal untuk diekspor.");
    
    const headers = ["Prodi", "Semester", "Kode Matkul", "Mata Kuliah", "SKS", "Kelas", "Dosen", "NIDN", "Hari", "Waktu Mulai", "Waktu Selesai", "Ruangan"];
    
    const rows = allJadwalData.map(j => [
        j.prodi, 
        j.semester, 
        j.kode_matkul, 
        j.matakuliah?.nama_matkul, 
        j.matakuliah?.sks, 
        j.kelas, 
        j.dosen?.nama,
        j.nidn,
        j.hari,
        j.waktu_mulai,
        j.waktu_selesai,
        j.ruangan
    ]);
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
    XLSX.utils.book_append_sheet(wb, ws, "Jadwal Kuliah");
    XLSX.writeFile(wb, "Jadwal_Kuliah_Fakultas_Teknik.xlsx");
}

// ---------------------------

async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "index.html";
}
</script>
</body>
</html>
