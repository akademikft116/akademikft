<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Manajemen Jadwal Kuliah</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    input, select, button { padding: 6px; margin: 4px; }
  </style>
</head>
<body>

<h2>Login / Daftar Akun</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="register()">Daftar</button>
<button onclick="login()">Login</button>
<p id="authMessage"></p>

<hr>

<h2>Tambah Jadwal</h2>
<form id="jadwalForm">
  <input type="text" id="kode_matkul" placeholder="Kode Matkul" required>

  <select id="prodi"></select>
  <select id="hari"></select>
  <input type="time" id="jam_mulai" required>
  <input type="time" id="jam_akhir" required>

  <select id="mata_kuliah"></select>
  <input type="number" id="sks" placeholder="SKS" required>

  <select id="dosen"></select>
  <select id="asisten"></select>
  <select id="semester"></select>
  <select id="kelas"></select>
  <select id="ruangan"></select>

  <button type="submit">Tambah Jadwal</button>
</form>

<p id="statusMessage"></p>

<hr>

<h2>Daftar Jadwal</h2>
<table id="tabelJadwal">
  <thead>
    <tr>
      <th>No</th>
      <th>Kode Matkul</th>
      <th>Prodi</th>
      <th>Hari</th>
      <th>Jam Mulai</th>
      <th>Jam Akhir</th>
      <th>Mata Kuliah</th>
      <th>SKS</th>
      <th>Dosen</th>
      <th>Asisten</th>
      <th>Semester</th>
      <th>Kelas</th>
      <th>Ruangan</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// ======== AUTH ========
async function register() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signUp({ email, password });
  document.getElementById("authMessage").textContent =
    error ? "Gagal daftar: " + error.message : "Akun berhasil dibuat! Cek email untuk verifikasi.";
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    document.getElementById("authMessage").textContent = "Login gagal: " + error.message;
  } else {
    document.getElementById("authMessage").textContent = "Login berhasil!";
    currentUser = data.user;
    loadDropdowns();
    loadJadwal();
  }
}

// ======== DROPDOWN LOAD ========
async function loadDropdowns() {
  await loadOptions("prodi");
  await loadOptions("hari");
  await loadOptions("mata_kuliah");
  await loadOptions("dosen");
  await loadOptions("asisten");
  await loadOptions("semester");
  await loadOptions("kelas");
  await loadOptions("ruangan");
}

async function loadOptions(table) {
  const { data, error } = await supabase.from(table).select("*");
  const select = document.getElementById(table);
  select.innerHTML = `<option value="">Pilih ${table}</option>`;
  if (data) {
    data.forEach(row => {
      const name = row.nama_prodi || row.nama_hari || row.nama || row.nama_semester || row.nama_kelas || row.nama_ruangan;
      select.innerHTML += `<option value="${row.id}">${name}</option>`;
    });
  }
}

// ======== TAMBAH JADWAL ========
document.getElementById("jadwalForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser) return alert("Harap login terlebih dahulu!");

  const jadwal = {
    user_id: currentUser.id,
    kode_matkul: document.getElementById("kode_matkul").value,
    prodi_id: document.getElementById("prodi").value,
    hari_id: document.getElementById("hari").value,
    jam_mulai: document.getElementById("jam_mulai").value,
    jam_akhir: document.getElementById("jam_akhir").value,
    mata_kuliah_id: document.getElementById("mata_kuliah").value,
    sks: document.getElementById("sks").value,
    dosen_id: document.getElementById("dosen").value,
    asisten_id: document.getElementById("asisten").value,
    semester_id: document.getElementById("semester").value,
    kelas_id: document.getElementById("kelas").value,
    ruangan_id: document.getElementById("ruangan").value,
  };

  const { error } = await supabase.from("jadwal").insert([jadwal]);
  document.getElementById("statusMessage").textContent = error
    ? "Gagal menambah jadwal: " + error.message
    : "Jadwal berhasil ditambahkan!";
  if (!error) loadJadwal();
});

// ======== TAMPILKAN JADWAL ========
async function loadJadwal() {
  const { data, error } = await supabase
    .from("jadwal")
    .select(`
      id, kode_matkul, jam_mulai, jam_akhir, sks,
      prodi (nama_prodi),
      hari (nama_hari),
      mata_kuliah (nama),
      dosen (nama),
      asisten (nama),
      semester (nama_semester),
      kelas (nama_kelas),
      ruangan (nama_ruangan)
    `)
    .eq("user_id", currentUser.id);

  const tbody = document.querySelector("#tabelJadwal tbody");
  tbody.innerHTML = "";
  if (data) {
    data.forEach((row, i) => {
      tbody.innerHTML += `
        <tr>
          <td>${i + 1}</td>
          <td>${row.kode_matkul}</td>
          <td>${row.prodi?.nama_prodi || ""}</td>
          <td>${row.hari?.nama_hari || ""}</td>
          <td>${row.jam_mulai}</td>
          <td>${row.jam_akhir}</td>
          <td>${row.mata_kuliah?.nama || ""}</td>
          <td>${row.sks}</td>
          <td>${row.dosen?.nama || ""}</td>
          <td>${row.asisten?.nama || ""}</td>
          <td>${row.semester?.nama_semester || ""}</td>
          <td>${row.kelas?.nama_kelas || ""}</td>
          <td>${row.ruangan?.nama_ruangan || ""}</td>
        </tr>`;
    });
  }
}
</script>
</body>
</html>
