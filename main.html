<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script> 

  <style>
    /* Mengatur body agar menggunakan gambar sebagai background */
    body {
        /* Ganti 'image.png' jika nama filenya berbeda */
        background-image: url('bendera.jpeg'); 
        
        /* Gambar akan menutupi seluruh area body */
        background-size: cover; 
        
        /* Gambar tidak akan diulang (repeat) */
        background-repeat: no-repeat; 
        
        /* Gambar akan tetap di tempat saat halaman discroll */
        background-attachment: fixed; 
        
        /* Warna fallback jika gambar gagal dimuat */
        background-color: #f3f4f6; 
    }

    /* Mengatur kontainer utama (bg-white) agar semi-transparan */
    .bg-white {
        background-color: rgba(255, 255, 255, 0.9); /* Transparansi 90% */
        backdrop-filter: blur(5px); /* Efek blur pada background di belakang kontainer */
    }
    
    /* Mengatur form tambah jadwal (bg-gray-50) agar semi-transparan */
    .bg-gray-50 {
        background-color: rgba(249, 250, 251, 0.9); /* Transparansi 90% */
    }

    /* --- SKEMA WARNA UNTUK ROW TABLE HTML BERDASARKAN PRODI --- */
    .row-Industri { background-color: #fcebeb; } /* Merah sangat muda */
    .row-Sipil { background-color: #ebf5fb; }     /* Biru sangat muda */
    .row-Arsitektur { background-color: #eaf7ee; } /* Hijau sangat muda */
    .row-Elektro { background-color: #faebd7; }    /* Coklat sangat muda */
    .row-Informatika { background-color: #fffbe6; } /* Kuning sangat muda */
    /* --- AKHIR SKEMA WARNA --- */
  </style>
  </head>
<body class="bg-gray-100">

  <div class="max-w-6xl mx-auto p-6 bg-white shadow-md mt-6 rounded-xl">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Manajemen Jadwal Kuliah</h1>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
    </div>

    <div class="mb-6 border p-4 rounded bg-gray-50">
      <h2 class="font-semibold mb-2">Tambah Jadwal</h2>
      <div class="grid grid-cols-3 gap-2"> 
        <input id="kode" placeholder="Kode Matkul" class="border p-2 rounded">
        
        <select id="prodi" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Prodi</option>
          <option value="Industri">Industri</option>
          <option value="Sipil">Sipil</option>
          <option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option>
          <option value="Informatika">Informatika</option>
        </select>
        
        <select id="hari" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Hari</option>
          <option value="Senin">Senin</option>
          <option value="Selasa">Selasa</option>
          <option value="Rabu">Rabu</option>
          <option value="Kamis">Kamis</option>
          <option value="Jumat">Jumat</option>
        </select>

        <input id="jam_mulai" type="time" placeholder="Jam Mulai" class="border p-2 rounded">
        <input id="jam_akhir" type="time" placeholder="Jam Akhir" class="border p-2 rounded">
        
        <select id="mata_kuliah" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Mata Kuliah</option>
        </select>

        <input id="sks" type="number" placeholder="SKS" class="border p-2 rounded">

        <select id="dosen" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Dosen</option>
        </select>

        <select id="asisten" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Asisten</option>
        </select>

        <select id="semester" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Semester</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
        </select>

        <select id="kelas" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Kelas</option>
        </select>

        <select id="ruangan" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Ruangan</option>
        </select>
        
        <input id="tahun_akademik" placeholder="Tahun Akademik (Contoh: 2024/2025)" class="border p-2 rounded col-span-1">
      </div>
      <button onclick="simpanJadwal()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
    </div>

    <div class="flex items-center mb-3 space-x-2 flex-wrap">
      <select id="filterProdi" class="border p-2 rounded min-w-min">
        <option value="">Semua Prodi</option>
         <option value="Industri">Industri</option>
          <option value="Sipil">Sipil</option>
          <option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option>
          <option value="Informatika">Informatika</option>
      </select>
       <select id="filterSemester" class="border p-2 rounded min-w-min">
        <option value="">Semua Semester</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
      
      <select id="filterKelas" class="border p-2 rounded min-w-min">
        <option value="">Semua Kelas</option>
      </select>
      
       <select id="filterTahunAkademik" class="border p-2 rounded min-w-min">
        <option value="">Semua Tahun Akademik</option>
        </select>
      
      <button onclick="filterData()" class="bg-blue-500 text-white px-3 py-2 rounded">Filter</button>
      <button onclick="exportExcel()" class="bg-green-500 text-white px-3 py-2 rounded">Export Excel</button>
      <button onclick="exportPDF()" class="bg-red-500 text-white px-3 py-2 rounded">Export PDF</button>
    </div>

    <div class="overflow-x-auto">
      <table id="tabelJadwal" class="min-w-full border border-gray-400 text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1 text-center">No</th>
            <th class="border px-2 py-1 text-center">Tahun Akademik</th> <th class="border px-2 py-1 text-center">Kode</th>
            <th class="border px-2 py-1 text-left">Prodi</th>
            <th class="border px-2 py-1 text-center">Hari</th>
            <th class="border px-2 py-1 text-center">Jam Mulai</th>
            <th class="border px-2 py-1 text-center">Jam Akhir</th>
            <th class="border px-2 py-1 text-left">Mata Kuliah</th>
            <th class="border px-2 py-1 text-center">SKS</th>
            <th class="border px-2 py-1 text-left">Dosen</th>
            <th class="border px-2 py-1 text-left">Asisten</th>
            <th class="border px-2 py-1 text-center">Semester</th>
            <th class="border px-2 py-1 text-center">Kelas</th>
            <th class="border px-2 py-1 text-center">Ruangan</th>
            <th class="border px-2 py-1 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
          <div class="p-6">
              <h2 class="text-xl font-bold mb-4">Edit Detail Jadwal</h2>
              <form id="editForm" onsubmit="return false;">
                  <input type="hidden" id="edit_id">
                  <div class="grid grid-cols-3 gap-3 mb-4">
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Kode Matkul</label>
                          <input id="edit_kode" type="text" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Prodi</label>
                          <select id="edit_prodi" class="mt-1 block w-full border p-2 rounded">
                             <option value="Industri">Industri</option>
          <option value="Sipil">Sipil</option>
          <option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option>
          <option value="Informatika">Informatika</option>

                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Hari</label>
                          <select id="edit_hari" class="mt-1 block w-full border p-2 rounded">
                              <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                              <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Jam Mulai</label>
                          <input id="edit_jam_mulai" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Jam Akhir</label>
                          <input id="edit_jam_akhir" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
                          <select id="edit_mata_kuliah" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">SKS</label>
                          <input id="edit_sks" type="number" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Dosen</label>
                          <select id="edit_dosen" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Asisten</label>
                          <select id="edit_asisten" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Semester</label>
                          <select id="edit_semester" class="mt-1 block w-full border p-2 rounded">
                              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                              <option value="7">7</option><option value="8">8</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Kelas</label>
                          <select id="edit_kelas" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Ruangan</label>
                          <select id="edit_ruangan" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                       <div>
                          <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label> <input id="edit_tahun_akademik" type="text" class="mt-1 block w-full border p-2 rounded">
                      </div>
                  </div>

                  <div class="flex justify-end space-x-2 mt-4">
                      <button type="button" onclick="document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex');" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button>
                      <button type="button" onclick="updateJadwal()" class="bg-green-600 text-white px-4 py-2 rounded">Simpan Perubahan</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
      </div>


  <script>
    // --- FUNGSI TOAST BARU (Otomatis Hilang) ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        let baseClasses = "p-4 rounded-lg shadow-xl text-white transition-all duration-500 transform min-w-min";
        let icon = '';

        if (type === 'success') {
            baseClasses += " bg-green-500";
            icon = '✅';
        } else if (type === 'error') {
            baseClasses += " bg-red-600";
            icon = '❌';
        } else if (type === 'info') {
            baseClasses += " bg-blue-500";
            icon = 'ℹ️';
        } else if (type === 'warning') {
            baseClasses += " bg-yellow-500 text-gray-800";
            icon = '⚠️';
        }

        toast.className = baseClasses + " opacity-0 translate-y-2";
        toast.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
        
        container.appendChild(toast);

        // Show animation
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        // Auto-hide and remove after 3 seconds
        setTimeout(() => {
            // Hide animation
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
            
            // Remove element after transition
            setTimeout(() => {
                if(container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 500); 
        }, 3000); // Notifikasi muncul selama 3 detik
    }


    // --- Supabase setup ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tabelBody = document.querySelector("#tabelJadwal tbody");
    let semuaData = []; 
    let dataYangDitampilkan = []; 

    // --- FUNGSI Memuat opsi pilihan dari Supabase (DIPERBAIKI UNTUK filterKelas) ---
    async function loadReferences() {
        const references = [
            { table: 'matakuliah', elementId: 'mata_kuliah', editElementId: 'edit_mata_kuliah', column: 'nama', defaultText: 'Pilih Mata Kuliah' },
            { table: 'dosen', elementId: 'dosen', editElementId: 'edit_dosen', column: 'nama', defaultText: 'Pilih Dosen' },
            { table: 'asisten', elementId: 'asisten', editElementId: 'edit_asisten', column: 'nama', defaultText: 'Pilih Asisten' },
            { table: 'kelas', elementId: 'kelas', editElementId: 'edit_kelas', column: 'nama', defaultText: 'Pilih Kelas' },
            { table: 'ruangan', elementId: 'ruangan', editElementId: 'edit_ruangan', column: 'nama', defaultText: 'Pilih Ruangan' },
        ];

        for (const ref of references) {
            const { data, error } = await supabaseClient
                .from(ref.table)
                .select(ref.column)
                .order(ref.column, { ascending: true });

            if (error) {
                console.error(`Gagal memuat data ${ref.table}. Pastikan tabel ada dan RLS disetel.`, error);
                continue;
            }

            const createOptions = (elementId) => {
                const selectElement = document.getElementById(elementId);
                if (!selectElement) return; 
                
                selectElement.innerHTML = `<option value="" disabled selected>${ref.defaultText}</option>`;
                
                data.forEach(item => {
                    const value = item[ref.column];
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                });
            };

            createOptions(ref.elementId); 
            if (ref.editElementId) {
                createOptions(ref.editElementId);
            }

            // PERBAIKAN: Isi elemen filter kelas secara terpisah
            if (ref.table === 'kelas') {
                const filterKelasElement = document.getElementById('filterKelas');
                if(filterKelasElement) {
                    filterKelasElement.innerHTML = `<option value="">Semua Kelas</option>`;
                    data.forEach(item => {
                        const value = item[ref.column];
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        filterKelasElement.appendChild(option);
                    });
                }
            }
        }
    }


    // --- Cek login user ---
    window.onload = async () => {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      if (!user) {
        // ALERT LAMA DIJAGA: Diinginkan user agar index.html (login/register) tidak error
        alert("Silakan login dulu!"); 
        window.location.href = "index.html";
        return;
      }
      await loadReferences();
      loadData();
    };

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // --- Ambil data jadwal & inisialisasi dataYangDitampilkan ---
    async function loadData() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      const { data, error } = await supabaseClient
        .from("jadwal")
        .select("*")
        .eq("user_id", user.id)
        .order("id", { ascending: true });

      if (error) {
        console.error(error);
        showToast("Gagal memuat data jadwal", 'error'); 
        return;
      }
      semuaData = data;
      
      // Setelah data dimuat, tampilkan data mentah tanpa filter awal
      tampilkanData(semuaData);
      
      // PENTING: Isi filter Tahun Akademik setelah semuaData terisi
      populateTahunAkademikFilter(semuaData); 
    }
    
    // FUNGSI BARU: Mengisi opsi Tahun Akademik secara dinamis
    function populateTahunAkademikFilter(data) {
        const filterElement = document.getElementById('filterTahunAkademik');
        const tahunAkademikSet = new Set();
        
        data.forEach(row => {
            if (row.tahun_akademik) {
                tahunAkademikSet.add(row.tahun_akademik);
            }
        });
        
        const sortedYears = Array.from(tahunAkademikSet).sort().reverse();

        // Reset dan isi filter
        filterElement.innerHTML = `<option value="">Semua Tahun Akademik</option>`;
        sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            filterElement.appendChild(option);
        });
    }


    // --- Tampilkan Data (DITAMBAH KOLOM TAHUN AKADEMIK) ---
    function tampilkanData(data) {
      dataYangDitampilkan = data; 
      
      tabelBody.innerHTML = "";
      data.forEach((row, index) => {
        const prodiClass = row.prodi ? `row-${row.prodi.replace(/\s/g, '')}` : ''; 
        const tr = document.createElement("tr");
        tr.classList.add("border-b", prodiClass);
        tr.innerHTML = `
          <td class="border px-2 py-1 text-center">${index + 1}</td>
          <td class="border px-2 py-1 text-center">${row.tahun_akademik || "-"}</td> <td class="border px-2 py-1 text-center">${row.kode_matkul || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.prodi || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.hari || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.jam_mulai || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.jam_akhir || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.mata_kuliah || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.sks || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.dosen || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.asisten || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.semester || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.kelas || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.ruangan || "-"}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick="editJadwal(${row.id})" class="bg-yellow-400 px-2 py-1 rounded text-gray-800">Edit</button>
            <button onclick="hapusJadwal(${row.id})" class="bg-red-500 text-white px-2 py-1 rounded ml-1">Hapus</button>
          </td>
        `;
        tabelBody.appendChild(tr);
      });
    }

    // --- Tambah Jadwal (DITAMBAH TAHUN AKADEMIK) ---
    async function simpanJadwal() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;

      if (!user) {
        showToast("Kamu belum login!", 'error'); 
        window.location.href = "index.html";
        return;
      }

      const prodi = document.getElementById("prodi").value;
      const hari = document.getElementById("hari").value;
      const mata_kuliah = document.getElementById("mata_kuliah").value;
      const dosen = document.getElementById("dosen").value;
      const asisten = document.getElementById("asisten").value;
      const semester = document.getElementById("semester").value;
      const kelas = document.getElementById("kelas").value;
      const ruangan = document.getElementById("ruangan").value;
      const sks = document.getElementById("sks").value;
      const tahun_akademik = document.getElementById("tahun_akademik").value; // BARU

      if (!prodi || !hari || !semester || !mata_kuliah || !dosen || !kelas || !ruangan || !sks || !tahun_akademik) {
        showToast("Semua kolom (termasuk Tahun Akademik) wajib diisi!", 'warning'); 
        return;
      }

      const jadwal = {
        user_id: user.id, 
        kode_matkul: document.getElementById("kode").value,
        prodi: prodi,
        hari: hari,
        jam_mulai: document.getElementById("jam_mulai").value,
        jam_akhir: document.getElementById("jam_akhir").value,
        mata_kuliah: mata_kuliah,
        sks: parseInt(sks),
        dosen: dosen,
        asisten: asisten,
        semester: semester,
        kelas: kelas,
        ruangan: ruangan,
        tahun_akademik: tahun_akademik, // BARU
      };

      const { error } = await supabaseClient.from("jadwal").insert([jadwal]);
      if (error) {
        console.error(error);
        showToast("Gagal menambah jadwal: " + error.message, 'error'); 
      } else {
        showToast("Jadwal berhasil ditambahkan!", 'success'); 
        loadData();
      }
    }

    // --- FUNGSI Edit Jadwal (Modal - DITAMBAH TAHUN AKADEMIK) ---
    function editJadwal(id) {
        const row = semuaData.find(r => r.id === id);
        if (!row) return showToast("Data tidak ditemukan.", 'error'); 

        // Mengisi form modal dengan data lama
        document.getElementById('edit_id').value = row.id;
        document.getElementById('edit_kode').value = row.kode_matkul || '';
        document.getElementById('edit_prodi').value = row.prodi || '';
        document.getElementById('edit_hari').value = row.hari || '';
        document.getElementById('edit_jam_mulai').value = row.jam_mulai || '';
        document.getElementById('edit_jam_akhir').value = row.jam_akhir || '';
        document.getElementById('edit_mata_kuliah').value = row.mata_kuliah || '';
        document.getElementById('edit_sks').value = row.sks || '';
        document.getElementById('edit_dosen').value = row.dosen || '';
        document.getElementById('edit_asisten').value = row.asisten || '';
        document.getElementById('edit_semester').value = row.semester || '';
        document.getElementById('edit_kelas').value = row.kelas || '';
        document.getElementById('edit_ruangan').value = row.ruangan || '';
        document.getElementById('edit_tahun_akademik').value = row.tahun_akademik || ''; // BARU

        // Menampilkan Modal
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editModal').classList.add('flex'); 
    }
    
    // --- FUNGSI Update Jadwal (DITAMBAH TAHUN AKADEMIK) ---
    async function updateJadwal() {
        const id = document.getElementById('edit_id').value;

        const updatedJadwal = {
            kode_matkul: document.getElementById('edit_kode').value,
            prodi: document.getElementById('edit_prodi').value,
            hari: document.getElementById('edit_hari').value,
            jam_mulai: document.getElementById('edit_jam_mulai').value,
            jam_akhir: document.getElementById('edit_jam_akhir').value,
            mata_kuliah: document.getElementById('edit_mata_kuliah').value,
            sks: parseInt(document.getElementById('edit_sks').value) || 0,
            dosen: document.getElementById('edit_dosen').value,
            asisten: document.getElementById('edit_asisten').value,
            semester: document.getElementById('edit_semester').value,
            kelas: document.getElementById('edit_kelas').value,
            ruangan: document.getElementById('edit_ruangan').value,
            tahun_akademik: document.getElementById('edit_tahun_akademik').value, // BARU
        };
        
        if (!updatedJadwal.prodi || !updatedJadwal.hari || !updatedJadwal.mata_kuliah || !updatedJadwal.tahun_akademik) {
            showToast("Kolom Prodi, Hari, Mata Kuliah, dan Tahun Akademik wajib diisi!", 'warning'); 
            return;
        }


        const { error } = await supabaseClient
            .from("jadwal")
            .update(updatedJadwal)
            .eq("id", id);
            
        if (error) {
            console.error("Error update:", error);
            showToast("Gagal memperbarui jadwal: " + error.message, 'error'); 
        } else {
            showToast("Jadwal berhasil diperbarui!", 'success'); 
            
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            loadData();
        }
    }

    // --- Hapus Jadwal (Menggunakan showToast) ---
    async function hapusJadwal(id) {
      // Konfirmasi tetap dipertahankan
      if (!confirm("Yakin ingin menghapus jadwal ini?")) return; 
      
      const { error } = await supabaseClient.from("jadwal").delete().eq("id", id);
      if (error) showToast("Gagal menghapus jadwal", 'error'); 
      else {
        showToast("Jadwal berhasil dihapus!", 'success'); 
        loadData();
      }
    }

    // --- FUNGSI Filter Data (DITAMBAH TAHUN AKADEMIK) ---
    function filterData() {
        const filterProdi = document.getElementById("filterProdi").value;
        const filterSemester = document.getElementById("filterSemester").value;
        const filterKelas = document.getElementById("filterKelas").value;
        const filterTahunAkademik = document.getElementById("filterTahunAkademik").value; // BARU

        let hasilFilter = semuaData.filter(row => {
            // Menggunakan String() dan || '' untuk memastikan konsistensi perbandingan dan menangani nilai null
            const rowProdi = String(row.prodi || '');
            const rowSemester = String(row.semester || '');
            const rowKelas = String(row.kelas || '');
            const rowTahunAkademik = String(row.tahun_akademik || ''); // BARU

            const matchProdi = !filterProdi || rowProdi === filterProdi;
            const matchSemester = !filterSemester || rowSemester === filterSemester; 
            const matchKelas = !filterKelas || rowKelas === filterKelas; 
            const matchTahunAkademik = !filterTahunAkademik || rowTahunAkademik === filterTahunAkademik; // BARU

            return matchProdi && matchSemester && matchKelas && matchTahunAkademik;
        });
        
        tampilkanData(hasilFilter);
    }

    // --- FUNGSI Export Excel (DITAMBAH TAHUN AKADEMIK) ---
    function exportExcel() {
      const dataBersih = dataYangDitampilkan.map(row => ({
        "Tahun Akademik": row.tahun_akademik || '-', // BARU
        "Kode Matkul": row.kode_matkul || '-',
        "Prodi": row.prodi || '-',
        "Hari": row.hari || '-',
        "Jam Mulai": row.jam_mulai || '-',
        "Jam Akhir": row.jam_akhir || '-',
        "Mata Kuliah": row.mata_kuliah || '-',
        "SKS": row.sks || 0,
        "Dosen": row.dosen || '-',
        "Asisten": row.asisten || '-',
        "Semester": row.semester || '-',
        "Kelas": row.kelas || '-',
        "Ruangan": row.ruangan || '-',
      }));
      
      const ws = XLSX.utils.json_to_sheet(dataBersih); 
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Jadwal_Terfilter");
      XLSX.writeFile(wb, "jadwal_kuliah.xlsx");
      showToast("Data berhasil diexport ke Excel!", 'info');
    }

    // --- FUNGSI Export PDF (DITAMBAH TAHUN AKADEMIK) ---
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); 

      if (dataYangDitampilkan.length === 0) {
          showToast("Tidak ada data terfilter untuk diekspor!", 'info'); 
          return;
      }
      
      // Ambil Filter yang Aktif
      const filterProdi = document.getElementById("filterProdi").value;
      const filterKelas = document.getElementById("filterKelas").value;
      const filterTahunAkademik = document.getElementById("filterTahunAkademik").value; // BARU
      
      // 1. Tentukan Judul
      let prodiJudul = filterProdi || "SEMUA PRODI";
      let kelasJudul = filterKelas || "MULTIPLE KELAS";
      let tahunAkademikJudul = filterTahunAkademik || "SEMUA TAHUN AKADEMIK"; // BARU

      // Jika Kelas tidak difilter, cari Kelas yang paling dominan
      if (!filterKelas) {
          const classCounts = {};
          let maxCount = 0;
          let mostFrequentClass = "MULTIPLE KELAS";

          dataYangDitampilkan.forEach(row => {
              const kelas = row.kelas || 'N/A';
              classCounts[kelas] = (classCounts[kelas] || 0) + 1;
              if (classCounts[kelas] > maxCount) {
                  maxCount = classCounts[kelas];
                  mostFrequentClass = kelas;
              }
          });
          kelasJudul = mostFrequentClass !== 'N/A' ? mostFrequentClass : "TIDAK ADA DATA KELAS";
      }


      // Tentukan warna header dan warna latar baris (terang)
      function getProdiColors(prodi) {
          switch (prodi) {
              case 'Industri': 
                  return { header: [231, 76, 60], text: [255, 255, 255], background: [252, 235, 235] }; 
              case 'Sipil': 
                  return { header: [52, 152, 219], text: [255, 255, 255], background: [235, 245, 251] }; 
              case 'Arsitektur': 
                  return { header: [39, 174, 96], text: [255, 255, 255], background: [234, 247, 238] }; 
              case 'Elektro': 
                  return { header: [180, 100, 50], text: [255, 255, 255], background: [250, 235, 215] }; 
              case 'Informatika': 
                  return { header: [241, 196, 15], text: [0, 0, 0], background: [255, 251, 230] }; 
              default: // SEMUA PRODI
                  return { header: [52, 73, 94], text: [255, 255, 255], background: [240, 240, 240] };
          }
      }
      
      const prodiColor = getProdiColors(filterProdi || null);

      // Siapkan data untuk PDF
      const dataPDF = dataYangDitampilkan.map((row, index) => [
        index + 1, 
        row.tahun_akademik || '-', // KOLOM BARU
        row.kode_matkul || '-', row.prodi || '-', row.hari || '-', row.jam_mulai || '-', 
        row.jam_akhir || '-', row.mata_kuliah || '-', row.sks || 0, row.dosen || '-', 
        row.asisten || '-', row.semester || '-', row.kelas || '-', row.ruangan || '-',
      ]);
      
      const headers = [
          "No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Mulai", "Akhir", "Mata Kuliah", 
          "SKS", "Dosen", "Asisten", "Semester", "Kelas", "Ruangan"
      ];

      // Judul Halaman DINAMIS (PRODI, KELAS, TAHUN AKADEMIK)
      doc.setFontSize(10);
      doc.text(`JADWAL PERKULIAHAN TAHUN AKADEMIK: ${tahunAkademikJudul.toUpperCase()}`, 14, 10);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text(`PROGRAM STUDI : ${prodiJudul.toUpperCase()} (${kelasJudul.toUpperCase()})`, 14, 15);
      doc.setFont('helvetica', 'normal');


      doc.autoTable({
        head: [headers],
        body: dataPDF,
        startY: 20, 
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1.5, halign: 'left' },
        // Pewarnaan Kepala Tabel
        headStyles: { 
            fillColor: prodiColor.header, 
            textColor: prodiColor.text, 
            fontStyle: 'bold', 
            halign: 'center' 
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 7 }, 
            1: { halign: 'center', cellWidth: 20 }, // Tahun Akademik
            2: { halign: 'center', cellWidth: 15 }, 
            4: { halign: 'center', cellWidth: 15 }, 5: { halign: 'center', cellWidth: 15 }, 
            6: { halign: 'center', cellWidth: 15 }, 8: { halign: 'center', cellWidth: 10 }, 
            11: { halign: 'center', cellWidth: 15 }, 12: { halign: 'center', cellWidth: 15 }, 
            13: { halign: 'center', cellWidth: 15 }, 
            3: { halign: 'left', cellWidth: 25 }, 7: { halign: 'left', cellWidth: 40 }, 
            9: { halign: 'left', cellWidth: 30 }, 10: { halign: 'left', cellWidth: 30 }, 
        },
        margin: { top: 18, left: 5, right: 5, bottom: 5 },
        
        // Pewarnaan Baris Data Sesuai Prodi (Latar Belakang Sangat Terang)
        didParseCell: function (data) {
            if (data.section === 'body') { 
                const prodi = data.row.raw[3]; // Prodi sekarang berada di indeks kolom 3
                const rowColors = getProdiColors(prodi);
                
                // Terapkan warna latar belakang ke seluruh baris
                data.cell.styles.fillColor = rowColors.background;
            }
        },
      });
      
      doc.save(`jadwal_kuliah_${prodiJudul.replace(/\s/g, '_')}_${tahunAkademikJudul.replace(/\s/g, '_')}.pdf`);
      showToast("File PDF berhasil dibuat!", 'success'); 
    }
  </script>
</body>
</html>
