<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manajemen Penjadwalan - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    .active-link { background-color: #1d4ed8; color: white; border-left: 4px solid #f97316; }
    .main-content { height: calc(100vh - 4rem); }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 50; }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
  <div class="flex items-center space-x-3">
    <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
    <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
  </div>
  <div class="flex items-center space-x-4">
    <span id="userNameNav" class="text-white text-sm">Halo, Admin</span>
    <button onclick="logout()" class="text-white hover:text-red-300 transition duration-150">
        <i class="fas fa-sign-out-alt"></i> Keluar
    </button>
  </div>
</nav>

<div class="flex pt-16">
    
    <aside class="w-64 bg-white shadow-xl h-screen fixed top-16 left-0 z-20">
        <nav class="p-4 space-y-2">
            <a href="dashboard.html" class="flex items-center p-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-tachometer-alt w-5 mr-3"></i> Dashboard
            </a>
            <a href="dosen.html" class="flex items-center p-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-user-tie w-5 mr-3"></i> Data Dosen
            </a>
            <a href="mahasiswa.html" class="flex items-center p-3 text-gray-700 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-user-graduate w-5 mr-3"></i> Data Mahasiswa
            </a>
            <a href="main.html" class="active-link flex items-center p-3 text-gray-700 rounded-lg">
                <i class="fas fa-calendar-alt w-5 mr-3"></i> **Penjadwalan**
            </a>
        </nav>
    </aside>

    <main class="flex-1 p-8 ml-64 main-content overflow-y-auto">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-3"></i> Manajemen Jadwal Kuliah
            </h2>
            <hr class="mb-4">
            
            <div class="flex justify-between items-center mb-6">
                <button onclick="openJadwalModal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-150 shadow-md">
                    <i class="fas fa-plus mr-2"></i> Tambah Jadwal Baru
                </button>
                <div class="space-x-2">
                    <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 shadow-md">
                        <i class="fas fa-file-pdf mr-2"></i> Export PDF
                    </button>
                    <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 shadow-md">
                        <i class="fas fa-file-excel mr-2"></i> Export Excel
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="jadwalTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Kuliah</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prodi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dosen Pengampu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruang</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="jadwalTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

    </main>

</div>

<div id="jadwalModal" class="modal">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h3 id="modalTitle" class="text-xl font-bold mb-4">Tambah Jadwal Baru</h3>
        <form id="jadwalForm" onsubmit="saveJadwal(event)">
            <input type="hidden" id="jadwalId" value="">
            
            <div class="mb-4">
                <label for="mk" class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
                <select id="mk" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </select>
            </div>
            
            <div class="mb-4">
                <label for="dosen" class="block text-sm font-medium text-gray-700">Dosen Pengampu</label>
                <select id="dosen" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </select>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeJadwalModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Batal</button>
                <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Simpan</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Konfigurasi Supabase Anda (Ganti dengan URL dan KEY Anda)
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co"; // URL dari snippet Anda
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o"; // Key dari snippet Anda
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let editMode = false;
    let jadwalDataCache = []; // Untuk keperluan export

    // --------------------------------------------------------
    // KODE PERBAIKAN UTAMA: loadJadwalData()
    // --------------------------------------------------------
    async function loadJadwalData() {
        const tableBody = document.getElementById('jadwalTableBody');
        tableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Memuat data...</td></tr>`;
        
        // Pastikan nama tabel di Supabase sudah benar! (Asumsi nama tabel adalah 'jadwal')
        const { data: jadwal, error } = await supabaseClient
            .from('jadwal') 
            .select(`
                id, hari, waktu_mulai, waktu_selesai, ruang,
                prodi, semester, 
                dosen (nama),
                mata_kuliah (nama, sks)
            `)
            .order('hari', { ascending: true }) // Mengambil semua data tanpa limit
            .order('waktu_mulai', { ascending: true }); // Mengurutkan berdasarkan Hari dan Waktu

        if (error) {
            tableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-sm text-red-500 text-center">❌ Gagal memuat jadwal: ${error.message}</td></tr>`;
            console.error("Jadwal Error:", error);
            return;
        }

        jadwalDataCache = jadwal; // Simpan data untuk export
        tableBody.innerHTML = ''; 

        if (jadwal.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-sm text-gray-500 text-center">Belum ada data jadwal.</td></tr>`;
            return;
        }

        // Mapping hari ke angka untuk urutan (Opsional, jika tabel 'hari' tidak ada)
        const hariMap = {
            'Senin': 1, 'Selasa': 2, 'Rabu': 3, 'Jumat': 4, 'Sabtu': 5, 'Minggu': 6 // Sesuaikan urutan hari
        };

        // Urutkan data berdasarkan hari (angka) dan waktu_mulai (string waktu)
        jadwal.sort((a, b) => {
            if (hariMap[a.hari] !== hariMap[b.hari]) {
                return hariMap[a.hari] - hariMap[b.hari];
            }
            return a.waktu_mulai.localeCompare(b.waktu_mulai);
        });


        // Tampilkan data ke tabel
        jadwal.forEach((j, i) => {
            // Pastikan Anda mengakses nama dosen/mk dari relasi
            const dosenNama = j.dosen ? j.dosen.nama : 'N/A';
            const mkNama = j.mata_kuliah ? j.mata_kuliah.nama : 'N/A';
            
            tableBody.innerHTML += `
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-500">${i + 1}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${mkNama} (${j.mata_kuliah.sks} SKS)</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${j.prodi}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${dosenNama}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${j.hari}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${j.waktu_mulai} - ${j.waktu_selesai}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${j.ruang}</td>
                    <td class="px-6 py-4 text-sm font-medium space-x-2">
                        <button onclick="editJadwal('${j.id}')" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteJadwal('${j.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    // --------------------------------------------------------
    // FUNGSI AUTH DAN LAINNYA (Pastikan sama dengan script.js/index.html Anda)
    // --------------------------------------------------------

    async function checkAuthAndLoad() {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            window.location.href = "index.html"; // Redirect ke halaman login jika belum login
            return;
        }
        
        // Ambil username untuk ditampilkan di navbar
        const { data: userData } = await supabaseClient
            .from('users_metadata')
            .select('username')
            .eq('user_id', user.id)
            .single();

        if (userData && userData.username) {
            document.getElementById('userNameNav').textContent = `Halo, ${userData.username}`;
        }

        // Panggil fungsi pemuat data utama setelah autentikasi
        await loadJadwalData();
        // Anda juga mungkin perlu memanggil fungsi untuk mengisi dropdown MK dan Dosen di modal
        // await loadSelectOptions(); 
    }

    function logout() {
        supabaseClient.auth.signOut().then(() => {
            window.location.href = "index.html";
        });
    }
    
    // Panggil saat halaman dimuat
    window.onload = checkAuthAndLoad;


    // --------------------------------------------------------
    // FUNGSI TAMBAHAN (Modal, Save, Edit, Delete, Export)
    // --------------------------------------------------------

    function openJadwalModal(id = null) {
        // ... Logika untuk membuka modal ...
        document.getElementById("modalTitle").textContent = id ? "Edit Jadwal" : "Tambah Jadwal Baru";
        document.getElementById("jadwalId").value = id || '';
        editMode = !!id;
        document.getElementById("jadwalModal").style.display = "flex";
        // Di sini Anda perlu memuat data MK dan Dosen ke dalam select (jika belum)
    }

    function closeJadwalModal() {
        // ... Logika untuk menutup modal ...
        document.getElementById("jadwalForm").reset();
        document.getElementById("jadwalModal").style.display = "none";
        editMode = false;
    }

    async function saveJadwal(event) {
        event.preventDefault();
        // ... Logika untuk menyimpan/update jadwal ke Supabase ...
        alert("Simpan/Update berhasil!"); // Ganti dengan logika Supabase Anda
        closeJadwalModal();
        loadJadwalData();
    }

    async function deleteJadwal(id) {
        if (!confirm("Yakin ingin menghapus jadwal ini?")) return;
        
        // Pastikan nama tabel di Supabase sudah benar! (Asumsi nama tabel adalah 'jadwal')
        const { error } = await supabaseClient.from("jadwal").delete().eq("id", id);
        
        if (error) {
             alert("❌ Gagal menghapus: " + error.message);
             console.error("Hapus Error:", error);
        } else {
             alert("✅ Data berhasil dihapus!");
             loadJadwalData();
        }
    }

    // Fungsi Export (Anda mungkin sudah punya ini)
    function exportToExcel() {
        // Logika Export Excel menggunakan jadwalDataCache
        alert("Fungsi Export Excel dipanggil!");
    }

    function exportToPDF() {
        // Logika Export PDF menggunakan jadwalDataCache
        alert("Fungsi Export PDF dipanggil!");
    }


</script>
</body>
</html>
