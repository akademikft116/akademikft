<!DOCTYPE html>
<html lang="id" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd8kF+5p9j0z9/bW5gB5zU1l4f5k8qC3Z5E9Qy6A5CM41vzapQJoB1MvJkPQE03o" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script> 

  <style>
    /* KEYFRAME BARU: Mendefinisikan pergerakan background */
    @keyframes moveBackground {
        from { background-position: 0 0; }
        to { background-position: 500px 500px; } 
    }
    
    /* LIGHT MODE (Default) - Animated Background */
    body {
        background-image: url('bendera.jpeg'); 
        background-size: 150px 150px; 
        background-repeat: repeat; 
        background-attachment: fixed; 
        background-color: #f3f4f6; 
        animation: moveBackground 60s linear infinite; 
        color: #1f2937; /* Default text color (Dark Gray) */
    }

    /* DARK MODE - Stop animation, use solid dark background */
    html.dark body {
        background-image: none; /* Nonaktifkan gambar pattern di Dark Mode */
        background-color: #111827; /* Very Dark Gray */
        animation: none; /* Nonaktifkan animasi */
        color: #f3f4f6; /* Light text color */
    }
    
    /* Style untuk Kontainer Utama dan Form agar transparan di Light Mode */
    .bg-white {
        background-color: rgba(255, 255, 255, 0.9); 
        backdrop-filter: blur(5px); 
    }
    
    /* DARK MODE: Kontainer Utama */
    html.dark .bg-white {
        background-color: rgba(31, 41, 55, 0.95); /* Darker container background */
        border: 1px solid #374151;
    }
    
    /* DARK MODE: Form Input */
    html.dark input, html.dark select, html.dark .ts-control {
        background-color: #374151 !important;
        color: #f3f4f6 !important;
        border-color: #4b5563 !important;
    }

    /* Style untuk baris prodi (dipertahankan warnanya, hanya teks yang diubah di dark mode) */
    .row-Industri { background-color: #fcebeb; } 
    .row-Sipil { background-color: #ebf5fb; }     
    .row-Arsitektur { background-color: #eaf7ee; } 
    .row-Elektro { background-color: #faebd7; }    
    .row-Informatika { background-color: #fffbe6; } 
    
    html.dark .row-Industri { background-color: #602d2d; color: #fcebeb;} 
    html.dark .row-Sipil { background-color: #2a3e50; color: #ebf5fb;}     
    html.dark .row-Arsitektur { background-color: #2b553d; color: #eaf7ee;} 
    html.dark .row-Elektro { background-color: #614a38; color: #faebd7;}    
    html.dark .row-Informatika { background-color: #636149; color: #fffbe6;} 
    
    /* ... (Style lainnya) ... */
    .icon-btn { padding: 0.5rem 0.75rem; }
    .ts-control { border-radius: 0.25rem !important; border: 1px solid #d1d5db !important; padding: 0.5rem !important; min-height: 2.5rem !important; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

  <div class="max-w-6xl mx-auto p-6 bg-white shadow-md mt-6 rounded-xl dark:bg-gray-800">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Manajemen Jadwal Kuliah</h1>
      
      <div class="flex items-center space-x-3">
        <select id="theme-switcher" onchange="setTheme(this.value)" class="border p-2 rounded text-sm bg-white dark:bg-gray-700 dark:text-gray-100 border-gray-300 dark:border-gray-600">
            <option value="system">Sesuai Perangkat</option>
            <option value="light">Terang</option>
            <option value="dark">Gelap</option>
        </select>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
      </div>
      </div>

    <div class="mb-6 border p-4 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
      <h2 class="font-semibold mb-2 text-gray-800 dark:text-gray-100">Tambah Jadwal</h2>
      <div class="grid grid-cols-3 gap-2"> 
        
        <select id="kode_matkul_search" placeholder="Cari Kode / Mata Kuliah" class="border p-2 rounded col-span-1"></select>
        
        <select id="prodi" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Prodi</option>
          <option value="Industri">Industri</option><option value="Sipil">Sipil</option><option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option><option value="Informatika">Informatika</option>
        </select>
        
        <select id="hari" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Hari</option>
          <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
          <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option>
        </select>

        <input id="jam_mulai" type="time" placeholder="Jam Mulai" class="border p-2 rounded">
        <input id="jam_akhir" type="time" placeholder="Jam Akhir" class="border p-2 rounded">
        <input id="sks" type="number" placeholder="SKS" class="border p-2 rounded">

        <select id="dosen" class="border p-2 rounded"><option value="" disabled selected>Pilih Dosen</option></select>
        <select id="asisten" class="border p-2 rounded"><option value="" disabled selected>Pilih Asisten</option></select>

        <select id="semester" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Semester</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        </select>

        <select id="kelas" class="border p-2 rounded"><option value="" disabled selected>Pilih Kelas</option></select>
        <select id="ruangan" class="border p-2 rounded"><option value="" disabled selected>Pilih Ruangan</option></select>
        <select id="tahun_akademik" class="border p-2 rounded col-span-1"><option value="" disabled selected>Pilih Tahun Akademik</option></select>
      </div>
      <button onclick="simpanJadwal()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tambah</button>
    </div>
    
    <div class="flex items-center mb-3 space-x-2 flex-wrap text-gray-800 dark:text-gray-200">
      <select id="filterProdi" class="border p-2 rounded min-w-min"></select>
      <select id="filterSemester" class="border p-2 rounded min-w-min"></select>
      <select id="filterKelas" class="border p-2 rounded min-w-min"></select>
      <select id="filterMataKuliah" class="border p-2 rounded min-w-min"></select>
      <select id="filterDosen" class="border p-2 rounded min-w-min"></select>
      <select id="filterTahunAkademik" class="border p-2 rounded min-w-min"></select>
      
      <button onclick="filterData()" class="bg-blue-500 text-white rounded icon-btn hover:bg-blue-600" title="Terapkan Filter (Pencarian)"><i class="fas fa-magnifying-glass"></i></button>
      <button onclick="exportExcel()" class="bg-green-500 text-white rounded icon-btn hover:bg-green-600" title="Export ke Excel"><i class="fas fa-file-excel"></i></button>
      <button onclick="exportPDF()" class="bg-red-500 text-white rounded icon-btn hover:bg-red-600" title="Export ke PDF"><i class="fas fa-file-pdf"></i></button>
      </div>
    
    <div class="overflow-x-auto">
      <table id="tabelJadwal" class="min-w-full border border-gray-400 text-sm dark:border-gray-600">
        <thead class="bg-gray-200 dark:bg-gray-700 dark:text-gray-100">
          <tr>
            <th class="border px-2 py-1 text-center dark:border-gray-600">No</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Tahun Akademik</th> <th class="border px-2 py-1 text-center dark:border-gray-600">Kode</th>
            <th class="border px-2 py-1 text-left dark:border-gray-600">Prodi</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Hari</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Jam Mulai</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Jam Akhir</th>
            <th class="border px-2 py-1 text-left dark:border-gray-600">Mata Kuliah</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">SKS</th>
            <th class="border px-2 py-1 text-left dark:border-gray-600">Dosen</th>
            <th class="border px-2 py-1 text-left dark:border-gray-600">Asisten</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Semester</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Kelas</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Ruangan</th>
            <th class="border px-2 py-1 text-center dark:border-gray-600">Aksi</th>
          </tr>
        </thead>
        <tbody class="dark:text-gray-200"></tbody>
      </table>
    </div>
  </div>


  <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl dark:bg-gray-700 dark:text-gray-100">
          <div class="p-6">
              <h2 class="text-xl font-bold mb-4">Edit Detail Jadwal</h2>
              <form id="editForm" onsubmit="return false;">
                  <input type="hidden" id="edit_id">
                  <div class="grid grid-cols-3 gap-3 mb-4">
                      
                      <select id="edit_kode_matkul_search" class="mt-1 block w-full border p-2 rounded"></select>
                      
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Prodi</label>
                          <select id="edit_prodi" class="mt-1 block w-full border p-2 rounded">
                             <option value="Industri">Industri</option><option value="Sipil">Sipil</option>
                             <option value="Arsitektur">Arsitektur</option><option value="Elektro">Elektro</option>
                             <option value="Informatika">Informatika</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hari</label>
                          <select id="edit_hari" class="mt-1 block w-full border p-2 rounded">
                              <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                              <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Jam Mulai</label>
                          <input id="edit_jam_mulai" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Jam Akhir</label>
                          <input id="edit_jam_akhir" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">SKS</label>
                          <input id="edit_sks" type="number" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dosen</label>
                          <select id="edit_dosen" class="mt-1 block w-full border p-2 rounded"><option value="" disabled selected>Memuat...</option></select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Asisten</label>
                          <select id="edit_asisten" class="mt-1 block w-full border p-2 rounded"><option value="" disabled selected>Memuat...</option></select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Semester</label>
                          <select id="edit_semester" class="mt-1 block w-full border p-2 rounded">
                              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                              <option value="7">7</option><option value="8">8</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kelas</label>
                          <select id="edit_kelas" class="mt-1 block w-full border p-2 rounded"><option value="" disabled selected>Memuat...</option></select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ruangan</label>
                          <select id="edit_ruangan" class="mt-1 block w-full border p-2 rounded"><option value="" disabled selected>Memuat...</option></select>
                      </div>
                       <div>
                          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tahun Akademik</label> 
                          <select id="edit_tahun_akademik" class="mt-1 block w-full border p-2 rounded"><option value="" disabled selected>Memuat...</option></select>
                      </div>
                  </div>

                  <div class="flex justify-end space-x-2 mt-4">
                      <button type="button" onclick="document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex');" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Batal</button>
                      <button type="button" onclick="updateJadwal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Simpan Perubahan</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
  </div>


  <script>
    // --- Variabel Global TomSelect & Supabase setup (TIDAK BERUBAH) ---
    let tsMataKuliah;
    let tsEditMataKuliah;
    let tsFilterMataKuliah; 
    let tsFilterDosen; 
    
    // ... (Fungsi showToast dan Supabase setup di sini) ...
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        let baseClasses = "p-4 rounded-lg shadow-xl text-white transition-all duration-500 transform min-w-min";
        let icon = '';

        if (type === 'success') { baseClasses += " bg-green-500"; icon = '✅'; } 
        else if (type === 'error') { baseClasses += " bg-red-600"; icon = '❌'; } 
        else if (type === 'info') { baseClasses += " bg-blue-500"; icon = 'ℹ️'; } 
        else if (type === 'warning') { baseClasses += " bg-yellow-500 text-gray-800"; icon = '⚠️'; }

        toast.className = baseClasses + " opacity-0 translate-y-2";
        toast.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
        
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                if(container.contains(toast)) { container.removeChild(toast); }
            }, 500); 
        }, 3000); 
    }

    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tabelBody = document.querySelector("#tabelJadwal tbody");
    let semuaData = []; 
    let dataYangDitampilkan = []; 
    let mataKuliahData = []; 

    // --- FUNGSI TEMA BARU ---
    function setTheme(theme) {
        const html = document.documentElement;
        const switcher = document.getElementById('theme-switcher');

        // 1. Simpan preferensi
        localStorage.setItem('theme', theme);
        
        // 2. Set nilai UI switcher
        if (switcher && switcher.value !== theme) {
             switcher.value = theme;
        }

        // 3. Terapkan kelas di tag HTML
        html.classList.remove('light', 'dark');

        if (theme === 'dark') {
            html.classList.add('dark');
        } else if (theme === 'light') {
            html.classList.add('light');
        } else { // 'system'
            // Cek preferensi perangkat
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                html.classList.add('dark');
            } else {
                html.classList.add('light');
            }
        }
    }

    function applyTheme() {
        // Ambil tema tersimpan, default ke 'system'
        const savedTheme = localStorage.getItem('theme') || 'system';
        setTheme(savedTheme);
        
        // Dengarkan perubahan tema sistem jika diatur ke 'system'
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('theme') === 'system') {
                setTheme('system'); // Terapkan ulang untuk mengikuti perubahan sistem
            }
        });
    }


    // --- Cek login user dan Panggil applyTheme ---
    window.onload = async () => {
      // Panggil fungsi tema di awal
      applyTheme(); 
      
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      if (!user) {
        alert("Silakan login dulu!"); 
        window.location.href = "index.html";
        return;
      }
      await loadReferences(); 
      
      new TomSelect("#dosen", { create: true, sortField: { field: "text", direction: "asc" } });
      new TomSelect("#asisten", { create: true, sortField: { field: "text", direction: "asc" } });
      
      loadData();
    };


    // --- (Sisa fungsi loadReferences, logout, loadData, tampilkanData, simpanJadwal, editJadwal, updateJadwal, hapusJadwal, filterData, exportExcel, exportPDF TETAP SAMA) ---
    async function loadReferences() {
        // ... (Implementasi TomSelect dan loading data referensi) ...
        const { data: mkData, error: mkError } = await supabaseClient.from('matakuliah').select('kode, nama').order('kode', { ascending: true }); 
        if (mkError) { console.error('Gagal memuat data Mata Kuliah:', mkError); showToast("Gagal memuat data Mata Kuliah", 'error'); } 
        else {
            mataKuliahData = mkData; 
            const tomSelectOptions = mkData.map(item => ({ value: item.kode + ' | ' + item.nama, text: item.kode + ' | ' + item.nama, kode: item.kode, nama: item.nama }));
            // TomSelect untuk Form Tambah
            tsMataKuliah = new TomSelect('#kode_matkul_search', { valueField: 'value', labelField: 'text', searchField: ['kode', 'nama'], options: tomSelectOptions, placeholder: 'Cari Kode atau Nama Mata Kuliah', render: { option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`, item: (data, escape) => `<div>${escape(data.text)}</div>` } });
            // TomSelect untuk Form Edit
            tsEditMataKuliah = new TomSelect('#edit_kode_matkul_search', { valueField: 'value', labelField: 'text', searchField: ['kode', 'nama'], options: tomSelectOptions, placeholder: 'Cari Kode atau Nama Mata Kuliah', render: { option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`, item: (data, escape) => `<div>${escape(data.text)}</div>` } });
            // TomSelect untuk Filter Mata Kuliah
            const filterOptionsMk = [{ value: '', text: 'Semua Mata Kuliah', kode: '', nama: '' }, ...tomSelectOptions];
            tsFilterMataKuliah = new TomSelect('#filterMataKuliah', { valueField: 'value', labelField: 'text', searchField: ['kode', 'nama'], options: filterOptionsMk, placeholder: 'Semua Mata Kuliah', render: { option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`, item: (data, escape) => `<div>${escape(data.text)}</div>` }, onInitialize: function() { this.setValue(''); } });
        }
        
        const references = [
            { table: 'dosen', elementId: 'dosen', editElementId: 'edit_dosen', column: 'nama', defaultText: 'Pilih Dosen', isFilter: true, filterElementId: 'filterDosen', filterDefaultText: 'Semua Dosen', isTomSelectFilter: true }, 
            { table: 'asisten', elementId: 'asisten', editElementId: 'edit_asisten', column: 'nama', defaultText: 'Pilih Asisten' },
            { table: 'kelas', elementId: 'kelas', editElementId: 'edit_kelas', column: 'nama', defaultText: 'Pilih Kelas', isFilter: true, filterElementId: 'filterKelas', filterDefaultText: 'Semua Kelas' },
            { table: 'ruangan', elementId: 'ruangan', editElementId: 'edit_ruangan', column: 'nama', defaultText: 'Pilih Ruangan' },
        ];
        
        const populateSelect = (elementId, dataArray, defaultText, isFilter = false) => {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return; 
            selectElement.innerHTML = `<option value="" ${isFilter ? '' : 'disabled selected'}>${defaultText}</option>`;
            dataArray.forEach(value => { const option = document.createElement('option'); option.value = value; option.textContent = value; selectElement.appendChild(option); });
        };

        for (const ref of references) {
            const { data, error } = await supabaseClient.from(ref.table).select(ref.column).order(ref.column, { ascending: true }); 
            if (error) { console.error(`Gagal memuat data ${ref.table}:`, error); continue; }
            const dataValues = data.map(item => item[ref.column]);
            populateSelect(ref.elementId, dataValues, ref.defaultText); 
            if (ref.editElementId) { populateSelect(ref.editElementId, dataValues, ref.defaultText); }
            if (ref.isFilter && ref.isTomSelectFilter) {
                const filterOptionsDosen = [{ value: '', text: 'Semua Dosen' }, ...dataValues.map(v => ({ value: v, text: v }))];
                tsFilterDosen = new TomSelect('#filterDosen', { valueField: 'value', labelField: 'text', searchField: ['text'], options: filterOptionsDosen, placeholder: 'Semua Dosen', onInitialize: function() { this.setValue(''); } });
            } else if (ref.isFilter) {
                populateSelect(ref.filterElementId, dataValues, ref.filterDefaultText, true);
            }
        }
        
        const tahunAkademikOptions = [ '2025/2026 Ganjil', '2024/2025 Genap', '2024/2025 Ganjil', '2023/2024 Genap', '2023/2024 Ganjil', '2022/2023 Genap', '2022/2023 Ganjil' ].sort((a, b) => b.localeCompare(a)); 
        const taDefaultText = 'Pilih Tahun Akademik';
        const taFilterDefaultText = 'Semua Tahun Akademik';
        populateSelect('tahun_akademik', tahunAkademikOptions, taDefaultText); 
        populateSelect('edit_tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('filterTahunAkademik', tahunAkademikOptions, taFilterDefaultText, true);
    }
    
    async function logout() { await supabaseClient.auth.signOut(); window.location.href = "index.html"; }

    async function loadData() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      const { data, error } = await supabaseClient.from("jadwal").select("*").eq("user_id", user.id).order("id", { ascending: true });
      if (error) { console.error(error); showToast("Gagal memuat data jadwal", 'error'); return; }
      semuaData = data;
      tampilkanData(semuaData);
    }

    function tampilkanData(data) {
      dataYangDitampilkan = data; 
      tabelBody.innerHTML = "";
      data.forEach((row, index) => {
        const prodiClass = row.prodi ? `row-${row.prodi.replace(/\s/g, '')}` : ''; 
        const tr = document.createElement("tr");
        tr.classList.add("border-b", prodiClass);
        // Tambahkan dark:border-gray-600 ke setiap cell
        tr.innerHTML = `
          <td class="border px-2 py-1 text-center dark:border-gray-600">${index + 1}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.tahun_akademik || "-"}</td> 
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.kode_matkul || "-"}</td>
          <td class="border px-2 py-1 text-left dark:border-gray-600">${row.prodi || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.hari || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.jam_mulai || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.jam_akhir || "-"}</td>
          <td class="border px-2 py-1 text-left dark:border-gray-600">${row.mata_kuliah || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.sks || "-"}</td>
          <td class="border px-2 py-1 text-left dark:border-gray-600">${row.dosen || "-"}</td>
          <td class="border px-2 py-1 text-left dark:border-gray-600">${row.asisten || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.semester || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.kelas || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">${row.ruangan || "-"}</td>
          <td class="border px-2 py-1 text-center dark:border-gray-600">
            <button onclick="editJadwal(${row.id})" class="bg-yellow-400 px-2 py-1 rounded text-gray-800 hover:bg-yellow-500">Edit</button>
            <button onclick="hapusJadwal(${row.id})" class="bg-red-500 text-white px-2 py-1 rounded ml-1 hover:bg-red-600">Hapus</button>
          </td>
        `;
        tabelBody.appendChild(tr);
      });
    }

    async function simpanJadwal() { /* ... kode simpanJadwal tetap sama ... */
        const { data: userData } = await supabaseClient.auth.getUser();
        const user = userData.user;
        if (!user) { showToast("Kamu belum login!", 'error'); window.location.href = "index.html"; return; }
        const mkValue = tsMataKuliah.getValue();
        if (!mkValue) { showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning'); return; }
        const [kode, nama] = mkValue.split(' | ').map(s => s.trim());
        const prodi = document.getElementById("prodi").value;
        const hari = document.getElementById("hari").value;
        const dosen = document.getElementById("dosen").value; 
        const asisten = document.getElementById("asisten").value;
        const semester = document.getElementById("semester").value;
        const kelas = document.getElementById("kelas").value;
        const ruangan = document.getElementById("ruangan").value;
        const sks = document.getElementById("sks").value;
        const tahun_akademik = document.getElementById("tahun_akademik").value; 

        if (!prodi || !hari || !semester || !dosen || !kelas || !ruangan || !sks || !tahun_akademik) { showToast("Semua kolom wajib diisi!", 'warning'); return; }

        const jadwal = {
            user_id: user.id, kode_matkul: kode, mata_kuliah: nama, prodi: prodi, hari: hari,
            jam_mulai: document.getElementById("jam_mulai").value, jam_akhir: document.getElementById("jam_akhir").value,
            sks: parseInt(sks), dosen: dosen, asisten: asisten, semester: semester,
            kelas: kelas, ruangan: ruangan, tahun_akademik: tahun_akademik,
        };

        const { error } = await supabaseClient.from("jadwal").insert([jadwal]);
        if (error) { console.error(error); showToast("Gagal menambah jadwal: " + error.message, 'error'); } 
        else {
            showToast("Jadwal berhasil ditambahkan!", 'success'); 
            tsMataKuliah.setValue(''); document.getElementById("dosen").tomselect.setValue(''); 
            document.getElementById("asisten").tomselect.setValue('');
            document.getElementById("sks").value = ''; document.getElementById("jam_mulai").value = '';
            document.getElementById("jam_akhir").value = ''; document.getElementById("prodi").value = '';
            document.getElementById("hari").value = ''; document.getElementById("semester").value = '';
            document.getElementById("kelas").value = ''; document.getElementById("ruangan").value = '';
            document.getElementById("tahun_akademik").value = '';
            loadData();
        }
    }

    function editJadwal(id) { /* ... kode editJadwal tetap sama ... */
        const row = semuaData.find(r => r.id === id);
        if (!row) return showToast("Data tidak ditemukan.", 'error'); 
        const mkValueToSelect = (row.kode_matkul && row.mata_kuliah) ? `${row.kode_matkul} | ${row.mata_kuliah}` : '';
        tsEditMataKuliah.setValue(mkValueToSelect);
        document.getElementById('edit_id').value = row.id;
        document.getElementById('edit_prodi').value = row.prodi || '';
        document.getElementById('edit_hari').value = row.hari || '';
        document.getElementById('edit_jam_mulai').value = row.jam_mulai || '';
        document.getElementById('edit_jam_akhir').value = row.jam_akhir || '';
        document.getElementById('edit_sks').value = row.sks || '';
        document.getElementById('edit_dosen').value = row.dosen || ''; 
        document.getElementById('edit_asisten').value = row.asisten || '';
        document.getElementById('edit_semester').value = row.semester || '';
        document.getElementById('edit_kelas').value = row.kelas || '';
        document.getElementById('edit_ruangan').value = row.ruangan || '';
        document.getElementById('edit_tahun_akademik').value = row.tahun_akademik || '';
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editModal').classList.add('flex'); 
    }
    
    async function updateJadwal() { /* ... kode updateJadwal tetap sama ... */
        const id = document.getElementById('edit_id').value;
        const mkValue = tsEditMataKuliah.getValue();
        if (!mkValue) { showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning'); return; }
        const [kode, nama] = mkValue.split(' | ').map(s => s.trim());

        const updatedJadwal = {
            kode_matkul: kode, mata_kuliah: nama, prodi: document.getElementById('edit_prodi').value,
            hari: document.getElementById('edit_hari').value, jam_mulai: document.getElementById('edit_jam_mulai').value,
            jam_akhir: document.getElementById('edit_jam_akhir').value, sks: parseInt(document.getElementById('edit_sks').value) || 0,
            dosen: document.getElementById('edit_dosen').value, asisten: document.getElementById('edit_asisten').value,
            semester: document.getElementById('edit_semester').value, kelas: document.getElementById('edit_kelas').value,
            ruangan: document.getElementById('edit_ruangan').value, tahun_akademik: document.getElementById('edit_tahun_akademik').value, 
        };
        
        if (!updatedJadwal.prodi || !updatedJadwal.hari || !updatedJadwal.mata_kuliah || !updatedJadwal.tahun_akademik) { showToast("Kolom wajib diisi!", 'warning'); return; }

        const { error } = await supabaseClient.from("jadwal").update(updatedJadwal).eq("id", id);
        if (error) { console.error("Error update:", error); showToast("Gagal memperbarui jadwal: " + error.message, 'error'); } 
        else {
            showToast("Jadwal berhasil diperbarui!", 'success'); 
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            loadData();
        }
    }

    async function hapusJadwal(id) { /* ... kode hapusJadwal tetap sama ... */
      if (!confirm("Yakin ingin menghapus jadwal ini?")) return; 
      const { error } = await supabaseClient.from("jadwal").delete().eq("id", id);
      if (error) showToast("Gagal menghapus jadwal", 'error'); 
      else { showToast("Jadwal berhasil dihapus!", 'success'); loadData(); }
    }

    function filterData() { /* ... kode filterData tetap sama ... */
        const filterProdi = document.getElementById("filterProdi").value;
        const filterSemester = document.getElementById("filterSemester").value;
        const filterKelas = document.getElementById("filterKelas").value;
        const filterMataKuliahRaw = tsFilterMataKuliah.getValue();
        const filterDosenRaw = tsFilterDosen.getValue();
        
        let filterMataKuliah = (filterMataKuliahRaw !== "" && filterMataKuliahRaw.includes('|')) ? filterMataKuliahRaw.split(' | ')[1].trim() : "";
        const filterDosen = filterDosenRaw;
        const filterTahunAkademik = document.getElementById("filterTahunAkademik").value;

        let hasilFilter = semuaData.filter(row => {
            const rowProdi = String(row.prodi || '');
            const rowSemester = String(row.semester || '');
            const rowKelas = String(row.kelas || '');
            const rowMataKuliah = String(row.mata_kuliah || ''); 
            const rowDosen = String(row.dosen || '');             
            const rowTahunAkademik = String(row.tahun_akademik || '');

            const matchProdi = !filterProdi || rowProdi === filterProdi;
            const matchSemester = !filterSemester || rowSemester === filterSemester; 
            const matchKelas = !filterKelas || rowKelas === filterKelas; 
            const matchMataKuliah = !filterMataKuliah || rowMataKuliah === filterMataKuliah; 
            const matchDosen = !filterDosen || rowDosen === filterDosen;                     
            const matchTahunAkademik = !filterTahunAkademik || rowTahunAkademik === filterTahunAkademik;

            return matchProdi && matchSemester && matchKelas && matchTahunAkademik && matchMataKuliah && matchDosen;
        });
        tampilkanData(hasilFilter);
    }
    
    function exportExcel() { /* ... kode exportExcel tetap sama ... */
      const dataBersih = dataYangDitampilkan.map(row => ({
        "Tahun Akademik": row.tahun_akademik || '-', "Kode Matkul": row.kode_matkul || '-', "Prodi": row.prodi || '-',
        "Hari": row.hari || '-', "Jam Mulai": row.jam_mulai || '-', "Jam Akhir": row.jam_akhir || '-',
        "Mata Kuliah": row.mata_kuliah || '-', "SKS": row.sks || 0, "Dosen": row.dosen || '-',
        "Asisten": row.asisten || '-', "Semester": row.semester || '-', "Kelas": row.kelas || '-',
        "Ruangan": row.ruangan || '-',
      }));
      const ws = XLSX.utils.json_to_sheet(dataBersih); 
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Jadwal_Terfilter");
      XLSX.writeFile(wb, "jadwal_kuliah.xlsx");
      showToast("Data berhasil diexport ke Excel!", 'info');
    }

    function exportPDF() { /* ... kode exportPDF tetap sama ... */
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); 
      const docWidth = doc.internal.pageSize.getWidth(); 
      if (dataYangDitampilkan.length === 0) { showToast("Tidak ada data terfilter untuk diekspor!", 'info'); return; }
      
      const filterProdi = document.getElementById("filterProdi").value;
      const filterKelas = document.getElementById("filterKelas").value;
      const filterTahunAkademik = document.getElementById("filterTahunAkademik").value;
      let prodiJudul = filterProdi || "SEMUA PRODI";
      let kelasJudul = filterKelas || "MULTIPLE KELAS";
      let tahunAkademikJudul = filterTahunAkademik || "SEMUA TAHUN AKADEMIK"; 

      function getProdiColors(prodi) {
          switch (prodi) {
              case 'Industri': return { header: [231, 76, 60], text: [255, 255, 255], background: [252, 235, 235] }; 
              case 'Sipil': return { header: [52, 152, 219], text: [255, 255, 255], background: [235, 245, 251] }; 
              case 'Arsitektur': return { header: [39, 174, 96], text: [255, 255, 255], background: [234, 247, 238] }; 
              case 'Elektro': return { header: [180, 100, 50], text: [255, 255, 255], background: [250, 235, 215] }; 
              case 'Informatika': return { header: [241, 196, 15], text: [0, 0, 0], background: [255, 251, 230] }; 
              default: return { header: [52, 73, 94], text: [255, 255, 255], background: [240, 240, 240] };
          }
      }
      
      const prodiColor = getProdiColors(filterProdi || null);
      const dataPDF = dataYangDitampilkan.map((row, index) => [
        index + 1, row.tahun_akademik || '-', row.kode_matkul || '-', row.prodi || '-', row.hari || '-', 
        row.jam_mulai || '-', row.jam_akhir || '-', row.mata_kuliah || '-', row.sks || 0, row.dosen || '-', 
        row.asisten || '-', row.semester || '-', row.kelas || '-', row.ruangan || '-',
      ]);
      const headers = ["No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Mulai", "Akhir", "Mata Kuliah", "SKS", "Dosen", "Asisten", "Semester", "Kelas", "Ruangan"];

      const lineHeight = 5; let currentY = 15; 
      
      const mainTitle = "JADWAL PERKULIAHAN";
      doc.setFontSize(14); doc.setFont('helvetica', 'bold');
      const mainTitleWidth = doc.getStringUnitWidth(mainTitle) * doc.internal.getFontSize() / doc.internal.scaleFactor;
      const mainTitleX = (docWidth - mainTitleWidth) / 2; doc.text(mainTitle, mainTitleX, currentY); currentY += lineHeight;

      const subTitle1 = `TAHUN AKADEMIK: ${tahunAkademikJudul.toUpperCase()}`;
      doc.setFontSize(10); doc.setFont('helvetica', 'normal');
      const subTitle1Width = doc.getStringUnitWidth(subTitle1) * doc.internal.getFontSize() / doc.internal.scaleFactor;
      const subTitle1X = (docWidth - subTitle1Width) / 2; doc.text(subTitle1, subTitle1X, currentY); currentY += lineHeight;

      const subTitle2 = `PROGRAM STUDI : ${prodiJudul.toUpperCase()} (${kelasJudul.toUpperCase()})`;
      doc.setFontSize(12); doc.setFont('helvetica', 'bold');
      const subTitle2Width = doc.getStringUnitWidth(subTitle2) * doc.internal.getFontSize() / doc.internal.scaleFactor;
      const subTitle2X = (docWidth - subTitle2Width) / 2; doc.text(subTitle2, subTitle2X, currentY); currentY += lineHeight + 3; 

      doc.autoTable({
        head: [headers], body: dataPDF, startY: currentY, theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1.5, halign: 'left' },
        margin: { left: 5, right: 5 }, 
        headStyles: { fillColor: prodiColor.header, textColor: prodiColor.text, fontStyle: 'bold', halign: 'center' },
        columnStyles: {
            0: { halign: 'center', cellWidth: 7 }, 1: { halign: 'center', cellWidth: 20 }, 
            2: { halign: 'center', cellWidth: 15 }, 4: { halign: 'center', cellWidth: 15 }, 
            5: { halign: 'center', cellWidth: 15 }, 6: { halign: 'center', cellWidth: 15 }, 
            8: { halign: 'center', cellWidth: 10 }, 11: { halign: 'center', cellWidth: 15 }, 
            12: { halign: 'center', cellWidth: 15 }, 13: { halign: 'center', cellWidth: 15 }, 
            3: { halign: 'left', cellWidth: 25 }, 7: { halign: 'left', cellWidth: 40 }, 
            9: { halign: 'left', cellWidth: 30 }, 10: { halign: 'left', cellWidth: 30 }, 
        },
        didParseCell: function (data) {
            if (data.section === 'body') { 
                const prodi = data.row.raw[3]; 
                const rowColors = getProdiColors(prodi);
                data.cell.styles.fillColor = rowColors.background;
            }
        },
      });
      doc.save(`jadwal_kuliah_${prodiJudul.replace(/\s/g, '_')}_${tahunAkademikJudul.replace(/\s/g, '_')}.pdf`);
      showToast("File PDF berhasil dibuat!", 'success'); 
    }
  </script>
</body>
</html>
