<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Kuliah - Fakultas Teknik</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd8kF+5p9j0z9/bW5gB5zU1l4f5k8qC3Z5E9Qy6A5CM41vzapQJoB1MvJkPQE03o" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* style.css (Modified for z-index and container margin) */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9eef2; margin: 0; padding: 0; }
    .container { max-width: 1300px; margin: auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); margin-top: 80px; /* Ditambahkan agar tidak tertutup navbar */ }
    h1, h2 { color: #2c3e50; text-align: center; }
    hr { border: 0; height: 1px; background-color: #ddd; margin: 25px 0; }

    /* Form */
    #jadwal-form { padding: 20px; border: 1px solid #cce; border-radius: 8px; background-color: #f8faff; }
    .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    input[type="text"], input[type="number"], input[type="time"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

    /* Buttons */
    button { padding: 10px 18px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; transition: background-color 0.2s; }
    #submit-btn { background-color: #2ecc71; color: white; }
    .secondary-btn { background-color: #95a5a6; color: white; }
    .export-btn { color: white; font-weight: bold; }
    .pdf-btn { background-color: #e74c3c; }
    .excel-btn { background-color: #27ae60; }

    /* Table */
    #tabelJadwal { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
    #tabelJadwal th, #tabelJadwal td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    #tabelJadwal th { background-color: #34495e; color: white; }
    #tabelJadwal tr:nth-child(even) { background-color: #f2f2f2; }
    .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
    .table-actions { margin-bottom: 15px; }
    @media (max-width: 900px) {
        .form-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    /* Custom & TomSelect Styling */
    .row-Industri { background-color: #ffeaea !important; }
    .row-Sipil { background-color: #eaf8ff !important; }
    .row-Arsitektur { background-color: #eaffea !important; }
    .row-Elektro { background-color: #fff4eb !important; }
    .row-Informatika { background-color: #ffffea !important; }

    .icon-btn { padding: 6px 10px; margin: 0; }
    
    .ts-wrapper .ts-control { 
        border-radius: 4px !important; 
        padding: 10px !important; 
        height: auto !important; 
        border: 1px solid #ccc !important;
    }
    .ts-wrapper.single.focus .ts-control { 
        border-color: #3498db !important;
        box-shadow: 0 0 0 1px #3498db !important; 
    }
    .ts-dropdown { z-index: 50; } 

    /* Modal Styling (Menggunakan Tailwind Utility yang tidak bertabrakan) */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
        background-color: rgba(0, 0, 0, 0.5); 
        overflow-y: auto; z-index: 50;
    }
    .modal-container { 
        position: relative; top: 40px; margin: auto; padding: 24px; 
        max-width: 90%; width: 900px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
        border-radius: 12px; 
        background-color: #fff;
    }
  </style>
</head>
<body>

  <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-20 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
        <img src="logo.jpeg" alt="Logo FT" class="h-8 w-8 rounded-full">
        <span class="text-xl font-bold text-white">Fakultas Teknik</span>
    </div>
    <div class="space-x-4 flex items-center">
        <a href="dashboard.html" class="text-white hover:text-blue-200 transition duration-150">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="main.html" class="text-white font-bold border-b-2 border-white pb-1 transition duration-150">
            <i class="fas fa-calendar-alt"></i> Jadwal Kuliah
        </a>
        <a href="mahasiswa.html" class="text-white hover:text-blue-200 transition duration-150">
            <i class="fas fa-users"></i> Mahasiswa
        </a>
        <button onclick="logout()" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg transition duration-150">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
  </nav>

  <div class="container">
    <h1 class="text-3xl font-extrabold mb-8">Manajemen Jadwal Kuliah</h1>
    <hr>

    <div id="jadwal-form">
      <h2 class="text-xl font-semibold mb-6">Tambah Jadwal Baru</h2>
      <div class="form-grid">
        
        <div>
          <label class="block text-sm font-medium">Tahun Akademik <span style="color:red;">*</span></label>
          <select id="tahun_akademik"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Kode/Nama Mata Kuliah <span style="color:red;">*</span></label>
          <select id="kode_matkul_search"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Prodi <span style="color:red;">*</span></label>
          <select id="prodi">
            <option disabled selected value="">Pilih Prodi</option>
            <option value="Industri">Industri</option>
            <option value="Sipil">Sipil</option>
            <option value="Arsitektur">Arsitektur</option>
            <option value="Elektro">Elektro</option>
            <option value="Informatika">Informatika</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">SKS</label>
          <input type="number" id="sks" placeholder="Otomatis terisi" readonly style="background-color:#f5f5f5;">
        </div>

        <div>
          <label class="block text-sm font-medium">Hari <span style="color:red;">*</span></label>
          <select id="hari">
            <option disabled selected value="">Pilih Hari</option>
            <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
            <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Jam Mulai <span style="color:red;">*</span></label>
          <input type="time" id="jam_mulai">
        </div>
        <div>
          <label class="block text-sm font-medium">Jam Akhir <span style="color:red;">*</span></label>
          <input type="time" id="jam_akhir">
        </div>
        <div>
          <label class="block text-sm font-medium">Dosen Pengampu <span style="color:red;">*</span></label>
          <select id="dosen"></select>
        </div>

        <div>
          <label class="block text-sm font-medium">Asisten (Opsional)</label>
          <select id="asisten"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Semester <span style="color:red;">*</span></label>
          <select id="semester">
            <option disabled selected value="">Pilih Semester</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Kelas <span style="color:red;">*</span></label>
          <select id="kelas"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Ruangan <span style="color:red;">*</span></label>
          <select id="ruangan"></select>
        </div>

      </div>
      <div class="text-center" style="margin-top: 20px;">
        <button id="submit-btn" onclick="simpanJadwal()">
          <i class="fas fa-plus-circle"></i> Simpan Jadwal
        </button>
      </div>
    </div>

    <hr>

    <div id="filter-export-section" style="padding: 20px; border: 1px solid #cce; border-radius: 8px; background-color: #f8faff; margin-bottom: 20px;">
      <h2 class="text-xl font-semibold mb-4">Filter & Ekspor Data</h2>
      <div class="form-grid">
        <div>
          <label class="block text-sm font-medium">Tahun Akademik</label>
          <select id="filterTahunAkademik" onchange="filterData()"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Prodi</label>
          <select id="filterProdi" onchange="filterData()">
            <option value="">Semua Prodi</option>
            <option value="Industri">Industri</option>
            <option value="Sipil">Sipil</option>
            <option value="Arsitektur">Arsitektur</option>
            <option value="Elektro">Elektro</option>
            <option value="Informatika">Informatika</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Semester</label>
          <select id="filterSemester" onchange="filterData()">
            <option value="">Semua Semester</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Dosen</label>
          <select id="filterDosen"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Mata Kuliah</label>
          <select id="filterMataKuliah"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Kelas</label>
          <select id="filterKelas"></select>
        </div>
      </div>
      <div style="text-align: right; margin-top: 15px;">
        <button onclick="filterData()" class="secondary-btn">
          <i class="fas fa-filter"></i> Terapkan Filter
        </button>
        <button onclick="exportExcel()" class="export-btn excel-btn">
          <i class="fas fa-file-excel"></i> Ekspor Excel
        </button>
        <button onclick="exportPDF()" class="export-btn pdf-btn">
          <i class="fas fa-file-pdf"></i> Ekspor PDF
        </button>
      </div>
    </div>

    <div style="padding: 20px; border: 1px solid #cce; border-radius: 8px; background-color: #f8faff;">
      <h2 class="text-xl font-semibold mb-4">Data Jadwal Kuliah</h2>
      <div style="overflow-x: auto;">
        <table id="tabelJadwal">
          <thead>
            <tr>
              <th>No</th>
              <th>Tahun Akademik</th>
              <th>Kode</th>
              <th>Prodi</th>
              <th>Hari</th>
              <th>Jam Mulai</th>
              <th>Jam Akhir</th>
              <th>Mata Kuliah</th>
              <th>SKS</th>
              <th>Dosen</th>
              <th>Asisten</th>
              <th>Semester</th>
              <th>Kelas</th>
              <th>Ruangan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="15" style="text-align: center; padding: 10px; color: #777;">Memuat konten penjadwalan...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="editModal" class="hidden modal-overlay">
    <div class="modal-container">
      
      <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid #ccc;">
        <h3 style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">Edit Jadwal Kuliah</h3>
        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.25rem; color: #95a5a6; margin-right: 0;">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="margin-top: 16px;">
        <input type="hidden" id="edit_id">
        <div class="form-grid">
            
            <div>
              <label class="block text-sm font-medium">Tahun Akademik</label>
              <select id="edit_tahun_akademik"></select>
            </div>
            <div>
              <label class="block text-sm font-medium">Kode Mata Kuliah / Nama</label>
              <select id="edit_kode_matkul_search"></select>
            </div>
            <div>
              <label class="block text-sm font-medium">Prodi</label>
              <select id="edit_prodi">
                <option value="Industri">Industri</option><option value="Sipil">Sipil</option>
                <option value="Arsitektur">Arsitektur</option><option value="Elektro">Elektro</option>
                <option value="Informatika">Informatika</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">SKS</label>
              <input type="number" id="edit_sks" readonly style="background-color:#f5f5f5;">
            </div>

            <div>
              <label class="block text-sm font-medium">Hari</label>
              <select id="edit_hari">
                <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Jam Mulai</label>
              <input type="time" id="edit_jam_mulai">
            </div>
            <div>
              <label class="block text-sm font-medium">Jam Akhir</label>
              <input type="time" id="edit_jam_akhir">
            </div>
            <div>
              <label class="block text-sm font-medium">Dosen Pengampu</label>
              <select id="edit_dosen"></select>
            </div>

            <div>
              <label class="block text-sm font-medium">Asisten (Opsional)</label>
              <select id="edit_asisten"></select>
            </div>
            <div>
              <label class="block text-sm font-medium">Semester</label>
              <select id="edit_semester">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Kelas</label>
              <select id="edit_kelas"></select>
            </div>
            <div>
              <label class="block text-sm font-medium">Ruangan</label>
              <select id="edit_ruangan"></select>
            </div>

          </div>
        </div>

      <div style="margin-top: 24px; text-align: right; padding-top: 12px; border-top: 1px solid #ccc;">
        <button onclick="updateJadwal()" style="background-color: #3498db; color: white;">
          <i class="fas fa-save"></i> Perbarui
        </button>
        <button onclick="closeModal()" class="secondary-btn">
          Batal
        </button>
      </div>

    </div>
  </div>


<script>
    // --- KONFIGURASI SUPABASE ---
    // GANTI DENGAN URL DAN KEY SUPABASE ANDA YANG SAMA DENGAN index.html!
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARIABEL GLOBAL ---
    let dataYangDitampilkan = [];
    let allMatakuliah = [];
    let globalUserId = null; 

    // TomSelect Variables (Dideklarasikan di window scope agar mudah diakses)
    let dosenSelect, asistenSelect, ruanganSelect, kelasSelect;
    let editDosenSelect, editAsistenSelect, editRuanganSelect, editKelasSelect;
    let filterMataKuliahSelect, filterDosenSelect, filterKelasSelect;
    let kodeMatkulSearchSelect, editKodeMatkulSearchSelect; 

    // Data referensi untuk pengulangan
    const references = [
        { table: 'dosen', column: 'nama', elementId: 'dosen', defaultText: 'Pilih Dosen', filterElementId: 'filterDosen', filterDefaultText: 'Semua Dosen' },
        { table: 'dosen', column: 'nama', elementId: 'asisten', defaultText: 'Pilih Asisten (Opsional)', filterElementId: 'filterAsisten', filterDefaultText: 'Semua Asisten' },
        { table: 'ruangan', column: 'nama', elementId: 'ruangan', defaultText: 'Pilih Ruangan', filterElementId: 'filterRuangan', filterDefaultText: 'Semua Ruangan' },
        { table: 'kelas', column: 'nama', elementId: 'kelas', defaultText: 'Pilih Kelas', filterElementId: 'filterKelas', filterDefaultText: 'Semua Kelas' },
    ];
    
    // --- FUNGSI BANTUAN TAMPILAN & DATA ---

    function getProdiColors(prodi) {
        switch (prodi) {
            case 'Industri': return { row: 'row-Industri', header: '#ffcccc', text: '#800000' };
            case 'Sipil': return { row: 'row-Sipil', header: '#cceeff', text: '#000080' };
            case 'Arsitektur': return { row: 'row-Arsitektur', header: '#ccffcc', text: '#006400' };
            case 'Elektro': return { row: 'row-Elektro', header: '#fff4eb', text: '#8b4513' };
            case 'Informatika': return { row: 'row-Informatika', header: '#ffffea', text: '#808000' };
            default: return { row: '', header: '#f3f4f6', text: '#000000' };
        }
    }
    
    // Fungsi inisialisasi TomSelect untuk input Mata Kuliah
    const initializeTomSelects = (mode) => {
        const elementId = mode === 'add' ? 'kode_matkul_search' : 'edit_kode_matkul_search';
        let currentTomSelect = mode === 'add' ? kodeMatkulSearchSelect : editKodeMatkulSearchSelect;
        
        const selectElement = document.getElementById(elementId);
        if (!selectElement) return;

        if (currentTomSelect && currentTomSelect.destroy) { 
            currentTomSelect.destroy(); 
        }

        const dataOptions = allMatakuliah.map(mk => ({
            value: mk.kode_matkul,
            text: `${mk.kode_matkul} - ${mk.nama_matkul}`,
            sks: mk.sks,
        }));
        
        const tomSelect = new TomSelect(`#${elementId}`, {
            valueField: 'value',
            labelField: 'text',
            searchField: ['value', 'text'],
            options: dataOptions,
            sortField: [{field: 'value', direction: 'asc'}],
            placeholder: "Cari Kode / Mata Kuliah",
            create: false,
            maxItems: 1,
            onChange: (value) => {
                const matkul = allMatakuliah.find(mk => mk.kode_matkul === value);
                const sksElementId = mode === 'add' ? 'sks' : 'edit_sks';
                document.getElementById(sksElementId).value = matkul ? matkul.sks : '';
            }
        });

        if (mode === 'add') {
            kodeMatkulSearchSelect = tomSelect;
        } else {
            editKodeMatkulSearchSelect = tomSelect;
        }

        return tomSelect;
    }

    // Fungsi helper untuk inisialisasi TomSelects referensi lainnya
    const initReferenceTomSelect = (elementId, options, placeholder, isFilter = false, filterCallback = null) => {
        const selectElement = document.getElementById(elementId);
        if (!selectElement) return null;

        let instance = window[elementId + 'Select'];
        if (instance && instance.destroy) {
            instance.destroy();
            instance = null;
        }

        const tomSelect = new TomSelect(`#${elementId}`, {
            options: options,
            valueField: 'value',
            labelField: 'text',
            searchField: ['value', 'text'],
            create: false,
            placeholder: placeholder,
            onInitialize: isFilter ? function() { this.setValue(""); } : undefined 
        });
        
        if (isFilter && filterCallback) {
            tomSelect.on('change', filterCallback);
        }

        window[elementId + 'Select'] = tomSelect;
        return tomSelect;
    }

    // Fungsi untuk mempopulasi dropdown biasa (non-TomSelect)
    function populateSelect(selectId, options, defaultText, isFilter = false) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;

        selectElement.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = isFilter ? "" : "";
        defaultOption.textContent = defaultText;
        if (!isFilter) {
            defaultOption.disabled = true;
            defaultOption.selected = true;
        }
        selectElement.appendChild(defaultOption);

        options.forEach(optionValue => {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            selectElement.appendChild(option);
        });
    }


    // --- FUNGSI LOAD DATA REFERENSI ---

    async function loadReferences() {
        if (!supabaseClient) {
            console.error("Supabase client not initialized.");
            return;
        }
        
        // 1. Ambil data Mata Kuliah
        const { data: mkData, error: mkError } = await supabaseClient
            .from('mata_kuliah')
            .select('kode_matkul, nama_matkul, sks');

        if (mkError) {
            console.error("Gagal memuat mata kuliah:", mkError.message);
            // Memberi pesan error di UI
            alert("❌ Gagal memuat data Mata Kuliah. Cek koneksi Supabase & nama tabel 'mata_kuliah'.");
        }
        allMatakuliah = mkData || [];

        // Inisialisasi Tom Select untuk input Mata Kuliah
        kodeMatkulSearchSelect = initializeTomSelects('add');
        editKodeMatkulSearchSelect = initializeTomSelects('edit');

        // Tom Select untuk Filter Mata Kuliah
        const filterMatkulOptions = [{value: "", text: "Semua Mata Kuliah"}].concat(
            allMatakuliah.map(mk => ({
                value: mk.kode_matkul,
                text: `${mk.nama_matkul} (${mk.kode_matkul})`
            }))
        );
        filterMataKuliahSelect = initReferenceTomSelect('filterMataKuliah', filterMatkulOptions, "Filter Mata Kuliah", true, filterData);
        

        // 2. Ambil data Dosen, Ruangan, Kelas
        for (const ref of references) {
            const { data, error } = await supabaseClient
                .from(ref.table)
                .select(ref.column)
                .order(ref.column, { ascending: true });

            if (error) {
                console.error(`Gagal memuat data ${ref.table}:`, error.message);
                alert(`❌ Gagal memuat data ${ref.table}. Cek koneksi Supabase & nama tabel '${ref.table}'.`);
                continue;
            }

            const uniqueData = Array.from(new Set(data.map(item => item[ref.column]))).filter(Boolean);
            const options = uniqueData.map(d => ({value: d, text: d}));
            
            // Inisialisasi input form
            if (ref.elementId === 'dosen') {
                dosenSelect = initReferenceTomSelect(ref.elementId, options, ref.defaultText);
                editDosenSelect = initReferenceTomSelect("edit_" + ref.elementId, options, ref.defaultText);
                
                const filterDosenOptions = [{value: "", text: ref.filterDefaultText}].concat(options.filter(o => o.value !== ""));
                filterDosenSelect = initReferenceTomSelect(ref.filterElementId, filterDosenOptions, ref.filterDefaultText, true, filterData);

            } else if (ref.elementId === 'asisten') {
                asistenSelect = initReferenceTomSelect(ref.elementId, options, ref.defaultText);
                editAsistenSelect = initReferenceTomSelect("edit_" + ref.elementId, options, ref.defaultText);

            } else if (ref.elementId === 'ruangan') {
                ruanganSelect = initReferenceTomSelect(ref.elementId, options, ref.defaultText);
                editRuanganSelect = initReferenceTomSelect("edit_" + ref.elementId, options, ref.defaultText);
            
            } else if (ref.elementId === 'kelas') {
                kelasSelect = initReferenceTomSelect(ref.elementId, options, ref.defaultText);
                editKelasSelect = initReferenceTomSelect("edit_" + ref.elementId, options, ref.defaultText);

                const filterKelasOptions = [{value: "", text: ref.filterDefaultText}].concat(options.filter(o => o.value !== ""));
                filterKelasSelect = initReferenceTomSelect(ref.filterElementId, filterKelasOptions, ref.filterDefaultText, true, filterData);
            }
        }

        // 3. Ambil data Tahun Akademik
        const { data: taData, error: taError } = await supabaseClient
            .from('tahun_akademik')
            .select('tahun_akademik')
            .order('tahun_akademik', { ascending: false });

        if (taError) {
            console.error("Gagal memuat tahun akademik:", taError.message);
            alert("❌ Gagal memuat data Tahun Akademik. Cek koneksi Supabase & nama tabel 'tahun_akademik'.");
            return;
        }

        const tahunAkademikOptions = Array.from(new Set(taData.map(item => item.tahun_akademik))).filter(Boolean).sort((a, b) => b.localeCompare(a));
        const taDefaultText = 'Pilih Tahun Akademik';
        const taFilterDefaultText = 'Semua Tahun Akademik';
        
        populateSelect('tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('edit_tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('filterTahunAkademik', tahunAkademikOptions, taFilterDefaultText, true);

        await loadData();
    }


    // --- FUNGSI UTAMA (CRUD & FETCH DATA) ---

    async function checkAuthAndLoad() {
        const { data: userData } = await supabaseClient.auth.getUser();
        const user = userData.user;

        if (!user) {
            window.location.href = "index.html"; 
            return;
        }
        globalUserId = user.id;

        await loadReferences(); 
    }

    async function loadData(filters = {}) {
        const tbody = document.querySelector('#tabelJadwal tbody');
        if (!tbody) return;
        
        tbody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 10px; color: #777;">Memuat konten penjadwalan...</td></tr>`;

        let query = supabaseClient.from('jadwal_kuliah').select('*').order('hari', { ascending: true }).order('jam_mulai', { ascending: true });

        // Terapkan filter
        if (filters.prodi) query = query.eq('prodi', filters.prodi);
        if (filters.semester) query = query.eq('semester', filters.semester);
        if (filters.kelas) query = query.eq('kelas', filters.kelas);
        if (filters.kode_matkul) query = query.eq('kode_matkul', filters.kode_matkul);
        if (filters.dosen) query = query.eq('dosen', filters.dosen);
        if (filters.tahun_akademik) query = query.eq('tahun_akademik', filters.tahun_akademik);

        const { data, error } = await query;
        
        tbody.innerHTML = ''; 

        if (error) {
            console.error("Gagal memuat data jadwal:", error.message);
            tbody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 10px; color: red;">Gagal memuat data jadwal: ${error.message} (Cek nama tabel 'jadwal_kuliah')</td></tr>`;
            dataYangDitampilkan = [];
            return;
        }

        dataYangDitampilkan = data; 
        
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 10px; color: #777;">Tidak ada data jadwal yang ditemukan.</td></tr>`;
            return;
        }

        data.forEach((jadwal, index) => {
            const row = tbody.insertRow();
            const colors = getProdiColors(jadwal.prodi);
            row.className = colors.row; 

            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = jadwal.tahun_akademik || '-';
            row.insertCell().textContent = jadwal.kode_matkul || '-';
            row.insertCell().textContent = jadwal.prodi || '-';
            row.insertCell().textContent = jadwal.hari || '-';
            row.insertCell().textContent = jadwal.jam_mulai ? jadwal.jam_mulai.substring(0, 5) : '-';
            row.insertCell().textContent = jadwal.jam_akhir ? jadwal.jam_akhir.substring(0, 5) : '-';
            
            const matkul = allMatakuliah.find(mk => mk.kode_matkul === jadwal.kode_matkul);
            row.insertCell().textContent = matkul ? matkul.nama_matkul : '-';
            
            row.insertCell().textContent = jadwal.sks || '-';
            row.insertCell().textContent = jadwal.dosen || '-';
            row.insertCell().textContent = jadwal.asisten || '-';
            row.insertCell().textContent = jadwal.semester || '-';
            row.insertCell().textContent = jadwal.kelas || '-';
            row.insertCell().textContent = jadwal.ruangan || '-';

            const actionCell = row.insertCell();
            actionCell.style.textAlign = "center";
            actionCell.innerHTML = `
                <button onclick="editJadwal('${jadwal.id}')" class="bg-yellow-500 text-white icon-btn rounded-l" style="background-color: #f39c12; margin-right: 0;" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteJadwal('${jadwal.id}')" class="bg-red-500 text-white icon-btn rounded-r" style="background-color: #e74c3c;" title="Hapus">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
        });
    }

    async function simpanJadwal() {
        const kodeMatkul = kodeMatkulSearchSelect ? kodeMatkulSearchSelect.getValue() : '';
        const dosen = dosenSelect ? dosenSelect.getValue() : '';
        const asisten = asistenSelect ? asistenSelect.getValue() : '';
        const kelas = kelasSelect ? kelasSelect.getValue() : '';
        const ruangan = ruanganSelect ? ruanganSelect.getValue() : '';

        const jadwalBaru = {
            tahun_akademik: document.getElementById('tahun_akademik').value,
            kode_matkul: kodeMatkul,
            prodi: document.getElementById('prodi').value,
            hari: document.getElementById('hari').value,
            jam_mulai: document.getElementById('jam_mulai').value,
            jam_akhir: document.getElementById('jam_akhir').value,
            sks: parseInt(document.getElementById('sks').value) || 0,
            dosen: dosen,
            asisten: asisten || null, // Pastikan asisten adalah null jika kosong
            semester: document.getElementById('semester').value,
            kelas: kelas,
            ruangan: ruangan,
        };
        
        if (!jadwalBaru.tahun_akademik || !jadwalBaru.kode_matkul || !jadwalBaru.prodi || !jadwalBaru.hari || !jadwalBaru.jam_mulai || !jadwalBaru.jam_akhir || !jadwalBaru.dosen || !jadwalBaru.semester || !jadwalBaru.kelas || !jadwalBaru.ruangan) {
            alert("❌ Harap lengkapi semua kolom wajib (ditandai *).");
            return;
        }

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .insert([jadwalBaru]);

        if (error) {
            alert("❌ Gagal menyimpan jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil ditambahkan!");
            // Reset Form
            document.getElementById('tahun_akademik').selectedIndex = 0;
            document.getElementById('prodi').selectedIndex = 0;
            document.getElementById('hari').selectedIndex = 0;
            document.getElementById('jam_mulai').value = "";
            document.getElementById('jam_akhir').value = "";
            document.getElementById('sks').value = "";
            document.getElementById('semester').selectedIndex = 0;
            
            if (kodeMatkulSearchSelect) kodeMatkulSearchSelect.clear();
            if (dosenSelect) dosenSelect.clear();
            if (asistenSelect) asistenSelect.clear();
            if (kelasSelect) kelasSelect.clear();
            if (ruanganSelect) ruanganSelect.clear();
            
            filterData();
        }
    }
    
    // --- FUNGSI FILTER DATA ---
    function filterData() {
        const filters = {
            prodi: document.getElementById('filterProdi').value,
            semester: document.getElementById('filterSemester').value,
            kelas: filterKelasSelect ? filterKelasSelect.getValue() : '',
            kode_matkul: filterMataKuliahSelect ? filterMataKuliahSelect.getValue() : '',
            dosen: filterDosenSelect ? filterDosenSelect.getValue() : '',
            tahun_akademik: document.getElementById('filterTahunAkademik').value,
        };
        
        loadData(filters);
    }

    // --- FUNGSI EDIT & DELETE ---

    async function editJadwal(id) {
        const jadwal = dataYangDitampilkan.find(j => j.id == id);
        if (!jadwal) return alert("Jadwal tidak ditemukan.");

        document.getElementById('edit_id').value = id;
        
        if (editKodeMatkulSearchSelect) editKodeMatkulSearchSelect.setValue(jadwal.kode_matkul || '', true);
        if (editDosenSelect) editDosenSelect.setValue(jadwal.dosen || '', true);
        if (editAsistenSelect) editAsistenSelect.setValue(jadwal.asisten || '', true);
        if (editRuanganSelect) editRuanganSelect.setValue(jadwal.ruangan || '', true);
        if (editKelasSelect) editKelasSelect.setValue(jadwal.kelas || '', true);

        document.getElementById('edit_prodi').value = jadwal.prodi || '';
        document.getElementById('edit_hari').value = jadwal.hari || '';
        document.getElementById('edit_jam_mulai').value = jadwal.jam_mulai ? jadwal.jam_mulai.substring(0, 5) : '';
        document.getElementById('edit_jam_akhir').value = jadwal.jam_akhir ? jadwal.jam_akhir.substring(0, 5) : '';
        document.getElementById('edit_sks').value = jadwal.sks || '';
        document.getElementById('edit_semester').value = jadwal.semester || '';
        document.getElementById('edit_tahun_akademik').value = jadwal.tahun_akademik || '';

        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    async function updateJadwal() {
        const id = document.getElementById('edit_id').value;
        
        const kodeMatkul = editKodeMatkulSearchSelect ? editKodeMatkulSearchSelect.getValue() : '';
        const dosen = editDosenSelect ? editDosenSelect.getValue() : '';
        const asisten = editAsistenSelect ? editAsistenSelect.getValue() : '';
        const kelas = editKelasSelect ? editKelasSelect.getValue() : '';
        const ruangan = editRuanganSelect ? editRuanganSelect.getValue() : '';

        const dataUpdate = {
            tahun_akademik: document.getElementById('edit_tahun_akademik').value,
            kode_matkul: kodeMatkul,
            prodi: document.getElementById('edit_prodi').value,
            hari: document.getElementById('edit_hari').value,
            jam_mulai: document.getElementById('edit_jam_mulai').value,
            jam_akhir: document.getElementById('edit_jam_akhir').value,
            sks: parseInt(document.getElementById('edit_sks').value) || 0,
            dosen: dosen,
            asisten: asisten || null,
            semester: document.getElementById('edit_semester').value,
            kelas: kelas,
            ruangan: ruangan,
        };

        if (!dataUpdate.kode_matkul || !dataUpdate.prodi || !dataUpdate.hari || !dataUpdate.jam_mulai || !dataUpdate.dosen || !dataUpdate.semester || !dataUpdate.kelas || !dataUpdate.ruangan || !dataUpdate.tahun_akademik) {
            alert("❌ Harap lengkapi semua kolom wajib.");
            return;
        }

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .update(dataUpdate)
            .eq('id', id);

        if (error) {
            alert("❌ Gagal memperbarui jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil diperbarui!");
            closeModal();
            filterData();
        }
    }

    async function deleteJadwal(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini? Tindakan ini tidak dapat dibatalkan.")) return;

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .delete()
            .eq('id', id);

        if (error) {
            alert("❌ Gagal menghapus jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil dihapus!");
            filterData();
        }
    }
    
    // --- FUNGSI EKSPORT ---
    function exportExcel() {
        if (dataYangDitampilkan.length === 0) {
            alert("Tidak ada data untuk diekspor.");
            return;
        }
        const headers = ["No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Jam Mulai", "Jam Akhir", "Mata Kuliah", "SKS", "Dosen", "Asisten", "Semester", "Kelas", "Ruangan"];
        const data = dataYangDitampilkan.map((j, index) => {
            const matkul = allMatakuliah.find(mk => mk.kode_matkul === j.kode_matkul);
            return [ index + 1, j.tahun_akademik || '-', j.kode_matkul || '-', j.prodi || '-', j.hari || '-', j.jam_mulai ? j.jam_mulai.substring(0, 5) : '-', j.jam_akhir ? j.jam_akhir.substring(0, 5) : '-', matkul ? matkul.nama_matkul : '-', j.sks || '-', j.dosen || '-', j.asisten || '-', j.semester || '-', j.kelas || '-', j.ruangan || '-', ];
        });
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Jadwal_Kuliah");
        XLSX.writeFile(wb, "Jadwal_Kuliah.xlsx");
    }

    function exportPDF() {
        if (dataYangDitampilkan.length === 0) {
            alert("Tidak ada data untuk diekspor.");
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', format: 'a4' }); 
        const headers = [["No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Mulai", "Akhir", "Mata Kuliah", "SKS", "Dosen", "Asisten", "Smt", "Kls", "Rgn"]];
        const rows = dataYangDitampilkan.map((j, index) => {
             const matkul = allMatakuliah.find(mk => mk.kode_matkul === j.kode_matkul);
            return [ index + 1, j.tahun_akademik || '-', j.kode_matkul || '-', j.prodi || '-', j.hari || '-', j.jam_mulai ? j.jam_mulai.substring(0, 5) : '-', j.jam_akhir ? j.jam_akhir.substring(0, 5) : '-', matkul ? matkul.nama_matkul : '-', j.sks || '-', j.dosen || '-', j.asisten || '-', j.semester || '-', j.kelas || '-', j.ruangan || '-', ];
        });
        const currentFilterProdi = document.getElementById('filterProdi').value;
        const prodiColor = getProdiColors(currentFilterProdi);
        const prodiDisplay = currentFilterProdi || "Semua Prodi";
        doc.setFontSize(14);
        doc.text("JADWAL KULIAH FAKULTAS TEKNIK", 148.5, 15, { align: 'center' }); 
        doc.setFontSize(10);
        doc.text(`Filter Prodi: ${prodiDisplay}`, 148.5, 20, { align: 'center' });
        doc.autoTable({
            startY: 25, head: headers, body: rows, theme: 'grid',
            styles: { fontSize: 7, cellPadding: 1.5, halign: 'left' }, margin: { left: 5, right: 5 }, 
            headStyles: { fillColor: prodiColor.header, textColor: prodiColor.text, fontStyle: 'bold', halign: 'center' },
            columnStyles: {
                0: { halign: 'center', cellWidth: 7 }, 1: { halign: 'center', cellWidth: 15 }, 2: { halign: 'center', cellWidth: 10 }, 4: { halign: 'center', cellWidth: 12 }, 
                5: { halign: 'center', cellWidth: 10 }, 6: { halign: 'center', cellWidth: 10 }, 8: { halign: 'center', cellWidth: 8 }, 11: { halign: 'center', cellWidth: 8 }, 
                12: { halign: 'center', cellWidth: 10 }, 13: { halign: 'center', cellWidth: 10 }, 3: { halign: 'left', cellWidth: 20 }, 7: { halign: 'left', cellWidth: 40 }, 
                9: { halign: 'left', cellWidth: 30 }, 10: { halign: 'left', cellWidth: 30 }, 
            },
            didParseCell: function (data) {
                if (data.section === 'body' && data.column.index === 3) {
                    const cellProdi = data.row.raw[3]; 
                    const cellColors = getProdiColors(cellProdi);
                    data.cell.styles.fillColor = cellColors.header;
                }
            }
        });
        doc.save('Jadwal_Kuliah.pdf');
    }
    
    // --- FUNGSI LOGOUT ---
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // --- INISIALISASI UTAMA ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('filterProdi').addEventListener('change', filterData);
        document.getElementById('filterSemester').addEventListener('change', filterData);
        
        checkAuthAndLoad();
    });
</script>
</body>
</html>
