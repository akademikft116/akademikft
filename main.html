<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Penjadwalan Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd8kF+5p9j0z9/bW5gB5zU1l4f5k8qC3Z5E9Qy6A5CM41vzapQJoB1MvJkPQE03o" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* ADDED: Styling untuk menu aktif di sidebar (diambil dari dashboard.html) */
    .active-link {
        background-color: #1d4ed8; /* blue-700 */
        color: white;
        border-left: 4px solid #f97316; /* orange-500 */
    }
    /* ADDED: Tinggi layar penuh diatur untuk konten utama (diambil dari dashboard.html) */
    .main-content {
        height: calc(100vh - 4rem); /* 100vh minus tinggi header/navbar */
    }

    /* Style tambahan yang mungkin sudah ada di style.css */
    .row-Industri { background-color: #fee2e2; } 
    .row-Sipil { background-color: #eff6ff; } 
    .row-Arsitektur { background-color: #d1fae5; }
    .row-Elektro { background-color: #fffbeb; }
    .row-Informatika { background-color: #f5f5f4; }
    .icon-btn { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; }
</style>

</head>
<body class="bg-gray-100">

    <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-20 flex items-center justify-between px-6">
        <div class="flex items-center space-x-3">
            <img src="logo.jpeg" class="h-10 w-auto"> 
            <h1 class="text-xl font-bold text-white">DASHBOARD AKADEMIK FT</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span id="userNameNav" class="text-white font-semibold">Memuat...</span>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition duration-150">
                <i class="fas fa-sign-out-alt"></i> Ganti Akun
            </button>
        </div>
    </nav>
    
    <div class="flex pt-16 main-content">
        
        <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 z-10 shadow-xl">
            <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                
                <a href="dashboard.html" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-home w-5"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="main.html" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg active-link">
                    <i class="fas fa-calendar-alt w-5"></i>
                    <span>Penjadwalan</span>
                </a>

                <a href="mahasiswa.html" class="w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-user-graduate w-5"></i>
                    <span>Data Mahasiswa</span>
                </a>
                
                <a href="dashboard.html#dosen" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-chalkboard-teacher w-5"></i>
                    <span>Dosen</span>
                </a>
                
                <a href="dashboard.html#matkul" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-book-open w-5"></i>
                    <span>Mata Kuliah</span>
                </a>

                <a href="dashboard.html#settings" class="nav-item w-full text-left flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300 hover:text-white transition duration-150">
                    <i class="fas fa-cog w-5"></i>
                    <span>Pengaturan</span>
                </a>
                
            </nav>
            
            <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
                <p>&copy; 2025 Akademik FT</p>
                <p>Designed by Rifqi & Alfi</p>
                <p>ABD</p>
            </div>
        </aside>
        
        <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100 h-full">
            
            <div class="bg-white p-6 rounded-lg shadow-xl min-h-full">
                <h1 class="text-2xl font-bold mb-4">Manajemen Jadwal Kuliah</h1>
                
                <div class="mb-6 border p-4 rounded bg-gray-50">
                    <h2 class="font-semibold mb-2">Tambah Jadwal</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3"> 
        
                        <select id="kode_matkul_search" placeholder="Cari Kode / Mata Kuliah" class="border p-2 rounded">
                            <option value="">Cari Kode / Mata Kuliah</option> 
                        </select>
                        
                        <select id="prodi" class="border p-2 rounded">
                          <option value="" disabled selected>Pilih Prodi</option>
                          <option value="Industri">Industri</option>
                          <option value="Sipil">Sipil</option>
                          <option value="Arsitektur">Arsitektur</option>
                          <option value="Elektro">Elektro</option>
                          <option value="Informatika">Informatika</option>
                        </select>
                        
                        <select id="hari" class="border p-2 rounded">
                          <option value="" disabled selected>Pilih Hari</option>
                           <option value="-">-</option>
                          <option value="Senin">Senin</option>
                          <option value="Selasa">Selasa</option>
                          <option value="Rabu">Rabu</option>
                          <option value="Kamis">Kamis</option>
                          <option value="Jumat">Jumat</option>
                           <option value="Sabtu">Sabtu</option>
                        </select>

                        <input id="jam_mulai" type="time" placeholder="Jam Mulai" class="border p-2 rounded">
                        <input id="jam_akhir" type="time" placeholder="Jam Akhir" class="border p-2 rounded">
                        
                        <input id="sks" type="number" placeholder="SKS" class="border p-2 rounded">

                        <select id="dosen" class="border p-2 rounded">
                            <option value="" disabled selected>Pilih Dosen</option>
                        </select>

                        <select id="asisten" class="border p-2 rounded">
                            <option value="" disabled selected>Pilih Asisten</option>
                        </select>

                        <select id="semester" class="border p-2 rounded">
                          <option value="" disabled selected>Pilih Semester</option>
                          <option value="1">1</option>
                          <option value="2">2</option>
                          <option value="3">3</option>
                          <option value="4">4</option>
                          <option value="5">5</option>
                          <option value="6">6</option>
                          <option value="7">7</option>
                          <option value="8">8</option>
                        </select>

                        <select id="kelas" class="border p-2 rounded">
                            <option value="" disabled selected>Pilih Kelas</option>
                        </select>

                        <select id="ruangan" class="border p-2 rounded">
                            <option value="" disabled selected>Pilih Ruangan</option>
                        </select>
                        
                        <select id="tahun_akademik" class="border p-2 rounded">
                            <option value="" disabled selected>Pilih Tahun Akademik</option>
                        </select>
                      </div>
                      <button onclick="simpanJadwal()" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition duration-150">
                        <i class="fas fa-plus"></i> Tambah
                      </button>
                </div>
                
                <div class="flex items-center mb-3 space-x-2 flex-wrap">
                  <select id="filterProdi" class="border p-2 rounded min-w-min">
                    <option value="">Semua Prodi</option>
                     <option value="Industri">Industri</option>
                      <option value="Sipil">Sipil</option>
                      <option value="Arsitektur">Arsitektur</option>
                      <option value="Elektro">Elektro</option>
                      <option value="Informatika">Informatika</option>
                  </select>
                   <select id="filterSemester" class="border p-2 rounded min-w-min">
                    <option value="">Semua Semester</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                  </select>
                  
                  <select id="filterKelas" class="border p-2 rounded min-w-min">
                    <option value="">Semua Kelas</option>
                  </select>
                  
                  <select id="filterMataKuliah" class="border p-2 rounded min-w-min">
                    <option value="">Memuat Mata Kuliah...</option>
                  </select>
                  
                  <select id="filterDosen" class="border p-2 rounded min-w-min">
                    <option value="">Memuat Dosen...</option>
                  </select>
                  
                   <select id="filterTahunAkademik" class="border p-2 rounded min-w-min">
                    <option value="">Semua Tahun Akademik</option>
                  </select>
                  
                  <button onclick="filterData()" class="bg-blue-500 hover:bg-blue-600 text-white rounded icon-btn transition duration-150" title="Terapkan Filter (Pencarian)">
                    <i class="fas fa-magnifying-glass"></i> 
                  </button>
                  <button onclick="exportExcel()" class="bg-green-500 hover:bg-green-600 text-white rounded icon-btn transition duration-150" title="Export ke Excel">
                    <i class="fas fa-file-excel"></i>
                  </button>
                  <button onclick="exportPDF()" class="bg-red-500 hover:bg-red-600 text-white rounded icon-btn transition duration-150" title="Export ke PDF">
                    <i class="fas fa-file-pdf"></i>
                  </button>
                </div>
                <div class="overflow-x-auto">
                  <table id="tabelJadwal" class="min-w-full border border-gray-400 text-sm">
                    <thead class="bg-gray-200">
                      <tr>
                        <th class="border px-2 py-1 text-center">No</th>
                        <th class="border px-2 py-1 text-center">Tahun Akademik</th> <th class="border px-2 py-1 text-center">Kode</th>
                        <th class="border px-2 py-1 text-left">Prodi</th>
                        <th class="border px-2 py-1 text-center">Hari</th>
                        <th class="border px-2 py-1 text-center">Jam Mulai</th>
                        <th class="border px-2 py-1 text-center">Jam Akhir</th>
                        <th class="border px-2 py-1 text-left">Mata Kuliah</th>
                        <th class="border px-2 py-1 text-center">SKS</th>
                        <th class="border px-2 py-1 text-left">Dosen</th>
                        <th class="border px-2 py-1 text-left">Asisten</th>
                        <th class="border px-2 py-1 text-center">Semester</th>
                        <th class="border px-2 py-1 text-center">Kelas</th>
                        <th class="border px-2 py-1 text-center">Ruangan</th>
                        <th class="border px-2 py-1 text-center">Aksi</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
                
            </div>
            
        </main>
    </div>


    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4">Edit Detail Jadwal</h2>
                <form id="editForm" onsubmit="return false;">
                    <input type="hidden" id="edit_id">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                        
                        <div class="col-span-1 sm:col-span-3 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
                            <select id="edit_kode_matkul_search" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Cari Kode / Mata Kuliah</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Prodi</label>
                            <select id="edit_prodi" class="mt-1 block w-full border p-2 rounded">
                               <option value="Industri">Industri</option>
                               <option value="Sipil">Sipil</option>
                               <option value="Arsitektur">Arsitektur</option>
                               <option value="Elektro">Elektro</option>
                               <option value="Informatika">Informatika</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Hari</label>
                            <select id="edit_hari" class="mt-1 block w-full border p-2 rounded">
                                <option value="-">-</option><option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Jam Mulai</label>
                            <input id="edit_jam_mulai" type="time" class="mt-1 block w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Jam Akhir</label>
                            <input id="edit_jam_akhir" type="time" class="mt-1 block w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">SKS</label>
                            <input id="edit_sks" type="number" class="mt-1 block w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dosen</label>
                            <select id="edit_dosen" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Memuat...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Asisten</label>
                            <select id="edit_asisten" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Memuat...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Semester</label>
                            <select id="edit_semester" class="mt-1 block w-full border p-2 rounded">
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                <option value="7">7</option><option value="8">8</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Kelas</label>
                            <select id="edit_kelas" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Memuat...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ruangan</label>
                            <select id="edit_ruangan" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Memuat...</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label> 
                            <select id="edit_tahun_akademik" class="mt-1 block w-full border p-2 rounded">
                                <option value="" disabled selected>Memuat...</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex');" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition duration-150">Batal</button>
                        <button type="button" onclick="updateJadwal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition duration-150">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
    </div>

    <script>
    // --- Variabel Global TomSelect ---
    let tsMataKuliah;
    let tsEditMataKuliah;
    let tsFilterMataKuliah; 
    let tsFilterDosen; 
    let dosenOptions = [];   
    let asistenOptions = []; 
    
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        let baseClasses = "p-4 rounded-lg shadow-xl text-white transition-all duration-500 transform min-w-min";
        let icon = '';

        if (type === 'success') {
            baseClasses += " bg-green-500";
            icon = '✅';
        } else if (type === 'error') {
            baseClasses += " bg-red-600";
            icon = '❌';
        } else if (type === 'info') {
            baseClasses += " bg-blue-500";
            icon = 'ℹ️';
        } else if (type === 'warning') {
            baseClasses += " bg-yellow-500 text-gray-800";
            icon = '⚠️';
        }

        toast.className = baseClasses + " opacity-0 translate-y-2";
        toast.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
        
        container.appendChild(toast);

        // Show animation
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        // Auto-hide and remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                if(container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 500); 
        }, 3000); 
    }


    // --- Supabase setup ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tabelBody = document.querySelector("#tabelJadwal tbody");
    let semuaData = []; 
    let dataYangDitampilkan = []; 
    let mataKuliahData = []; 

    // --- FUNGSI Memuat opsi pilihan (Disesuaikan untuk TomSelect) ---
    async function loadReferences() {
        // --- 1. Ambil dan Inisialisasi Mata Kuliah (TomSelect) ---
        const { data: mkData, error: mkError } = await supabaseClient
            .from('matakuliah')
            .select('kode, nama')
            .order('nama', { ascending: true });

        if (mkError) {
            console.error("Gagal memuat Mata Kuliah:", mkError);
            return;
        }

        mataKuliahData = mkData;
        const matkulOptions = mkData.map(mk => ({
            value: `${mk.kode} | ${mk.nama}`,
            text: `${mk.kode} | ${mk.nama}`
        }));
        
        // Bersihkan TomSelect yang mungkin sudah ada sebelum inisialisasi
        if (tsMataKuliah) tsMataKuliah.destroy();
        if (tsEditMataKuliah) tsEditMataKuliah.destroy();
        if (tsFilterMataKuliah) tsFilterMataKuliah.destroy();


        // Inisialisasi TomSelect untuk Tambah Jadwal
        tsMataKuliah = new TomSelect("#kode_matkul_search", {
            options: matkulOptions,
            sortField: { field: "text", direction: "asc" },
            placeholder: 'Cari Kode / Mata Kuliah',
        });

        // Inisialisasi TomSelect untuk Edit Modal
        tsEditMataKuliah = new TomSelect("#edit_kode_matkul_search", {
            options: matkulOptions,
            sortField: { field: "text", direction: "asc" },
            placeholder: 'Cari Kode / Mata Kuliah',
        });
        
        // Inisialisasi TomSelect untuk Filter Mata Kuliah
        tsFilterMataKuliah = new TomSelect("#filterMataKuliah", {
            options: [{ value: "", text: "Semua Mata Kuliah" }].concat(matkulOptions),
            sortField: { field: "text", direction: "asc" },
            create: false,
            placeholder: 'Filter Mata Kuliah...'
        });
        tsFilterMataKuliah.setValue(""); // Set default value

        // --- 2. Ambil dan Inisialisasi Dosen ---
        const { data: dosenData, error: dosenError } = await supabaseClient
            .from('dosen')
            .select('nama')
            .order('nama', { ascending: true });

        if (dosenError) {
            console.error("Gagal memuat Dosen:", dosenError);
            return;
        }

        dosenOptions = dosenData.map(d => d.nama);
        asistenOptions = dosenOptions; // Asisten bisa dari daftar dosen juga

        // Inisialisasi TomSelect untuk Dosen dan Asisten
        new TomSelect("#dosen", { options: dosenOptions.map(d => ({ value: d, text: d })), placeholder: 'Pilih Dosen' });
        new TomSelect("#edit_dosen", { options: dosenOptions.map(d => ({ value: d, text: d })), placeholder: 'Pilih Dosen' });
        new TomSelect("#asisten", { options: asistenOptions.map(d => ({ value: d, text: d })), placeholder: 'Pilih Asisten' });
        new TomSelect("#edit_asisten", { options: asistenOptions.map(d => ({ value: d, text: d })), placeholder: 'Pilih Asisten' });
        
        // Inisialisasi TomSelect untuk Filter Dosen
        const dosenFilterOptions = [{ value: "", text: "Semua Dosen" }].concat(dosenOptions.map(d => ({ value: d, text: d })));
        if (tsFilterDosen) tsFilterDosen.destroy();
        tsFilterDosen = new TomSelect("#filterDosen", {
            options: dosenFilterOptions,
            sortField: { field: "text", direction: "asc" },
            create: false,
            placeholder: 'Filter Dosen...'
        });
        tsFilterDosen.setValue(""); // Set default value


        // --- 3. Ambil dan Inisialisasi Ruangan & Kelas ---
        const { data: refData, error: refError } = await supabaseClient
            .from('referensi')
            .select('kunci, nilai')
            .in('kunci', ['kelas', 'ruangan', 'tahun_akademik']);

        if (refError) {
            console.error("Gagal memuat referensi:", refError);
            return;
        }

        const kelasOptions = refData.filter(r => r.kunci === 'kelas').map(r => r.nilai).sort();
        const ruanganOptions = refData.filter(r => r.kunci === 'ruangan').map(r => r.nilai).sort();
        const tahunAkademikOptions = refData.filter(r => r.kunci === 'tahun_akademik').map(r => r.nilai).sort((a, b) => b.localeCompare(a));


        populateSelect('kelas', kelasOptions, 'Pilih Kelas');
        populateSelect('edit_kelas', kelasOptions, 'Pilih Kelas');
        populateSelect('filterKelas', kelasOptions, 'Semua Kelas', true);
        
        populateSelect('ruangan', ruanganOptions, 'Pilih Ruangan');
        populateSelect('edit_ruangan', ruanganOptions, 'Pilih Ruangan');
        
        const taDefaultText = 'Pilih Tahun Akademik';
        const taFilterDefaultText = 'Semua Tahun Akademik';
        populateSelect('tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('edit_tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('filterTahunAkademik', tahunAkademikOptions, taFilterDefaultText, true);
    }

    // Fungsi pembantu untuk mengisi <select>
    function populateSelect(selectId, optionsArray, defaultText, includeAll = false) {
        const select = document.getElementById(selectId);
        if (!select) return;

        select.innerHTML = '';
        
        let initialOptions = [];
        if (includeAll) {
             initialOptions.push(`<option value="">${defaultText}</option>`);
        } else {
             initialOptions.push(`<option value="" disabled selected>${defaultText}</option>`);
        }

        const optionHtml = optionsArray.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        select.innerHTML = initialOptions.join('') + optionHtml;
    }


    // --- Cek login user & Ambil data ---
    async function checkAuthAndLoadData() {
        const { data: userData } = await supabaseClient.auth.getUser();
        const user = userData.user;

        if (!user) {
            alert("Silakan login dulu!");
            window.location.href = "index.html";
            return;
        }
        
        // Load username for Navbar (Copied from dashboard.html logic)
        const { data: metadata, error: metadataError } = await supabaseClient 
          .from('users_metadata') 
          .select('username') 
          .eq('user_id', user.id) 
          .single();
          
        let username = (metadata && metadata.username) ? metadata.username : 'User';
        document.getElementById('userNameNav').textContent = `Halo, ${username}`;

        await loadReferences();
        loadData();
    }
    
    window.onload = checkAuthAndLoadData;

    async function logout() { 
        await supabaseClient.auth.signOut(); 
        window.location.href = "index.html"; 
    }

    // --- Ambil data jadwal & inisialisasi dataYangDitampilkan --- 
    async function loadData() { 
        const { data: userData } = await supabaseClient.auth.getUser(); 
        const user = userData.user; 
        
        // HANYA AMBIL JADWAL YANG DIBUAT OLEH USER YANG SEDANG LOGIN
        const { data, error } = await supabaseClient 
            .from("jadwal") 
            .select("*") 
            .eq("user_id", user.id) // Filter by user_id
            .order("id", { ascending: true }); 
            
        if (error) { 
            console.error(error); 
            showToast("Gagal memuat data jadwal", 'error'); 
            return; 
        } 
        semuaData = data; 
        tampilkanData(semuaData); 
    } 

    // --- Tampilkan Data --- 
    function tampilkanData(data) { 
        dataYangDitampilkan = data; 
        tabelBody.innerHTML = ""; 
        data.forEach((row, index) => { 
            const prodiClass = row.prodi ? `row-${row.prodi.replace(/\s/g, '')}` : ''; 
            const tr = document.createElement("tr"); 
            tr.classList.add("border-b", prodiClass); 
            tr.innerHTML = ` 
                <td class="border px-2 py-1 text-center">${index + 1}</td> 
                <td class="border px-2 py-1 text-center">${row.tahun_akademik || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.kode_matkul || "-"}</td> 
                <td class="border px-2 py-1 text-left">${row.prodi || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.hari || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.jam_mulai || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.jam_akhir || "-"}</td> 
                <td class="border px-2 py-1 text-left">${row.mata_kuliah || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.sks || "-"}</td> 
                <td class="border px-2 py-1 text-left">${row.dosen || "-"}</td> 
                <td class="border px-2 py-1 text-left">${row.asisten || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.semester || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.kelas || "-"}</td> 
                <td class="border px-2 py-1 text-center">${row.ruangan || "-"}</td> 
                <td class="border px-2 py-1 text-center"> 
                    <button onclick="editJadwal(${row.id})" class="bg-yellow-400 hover:bg-yellow-500 px-2 py-1 rounded text-gray-800 transition duration-150">Edit</button> 
                    <button onclick="hapusJadwal(${row.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded ml-1 transition duration-150">Hapus</button> 
                </td> 
            `; 
            tabelBody.appendChild(tr); 
        }); 
    } 

    // --- Tambah Jadwal --- 
    async function simpanJadwal() { 
        const { data: userData } = await supabaseClient.auth.getUser(); 
        const user = userData.user; 
        if (!user) { 
            showToast("Kamu belum login!", 'error'); 
            window.location.href = "index.html"; 
            return; 
        } 
        
        // Ambil nilai dari TomSelect Mata Kuliah 
        const mkValue = tsMataKuliah.getValue(); 
        if (!mkValue) { 
            showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning'); 
            return; 
        } 
        const [kode, nama] = mkValue.split(' | ').map(s => s.trim()); 
        
        const prodi = document.getElementById("prodi").value; 
        const hari = document.getElementById("hari").value; 
        
        // AMBIL NILAI DARI TOMSELECT Dosen & Asisten 
        const dosen = document.getElementById("dosen").tomselect.getValue(); 
        const asisten = document.getElementById("asisten").tomselect.getValue(); 
        
        const semester = document.getElementById("semester").value; 
        const kelas = document.getElementById("kelas").value; 
        const ruangan = document.getElementById("ruangan").value; 
        const sks = document.getElementById("sks").value; 
        const tahun_akademik = document.getElementById("tahun_akademik").value; 

        if (!prodi || !hari || !semester || !dosen || !kelas || !ruangan || !sks || !tahun_akademik) { 
            showToast("Semua kolom wajib diisi!", 'warning'); 
            return; 
        } 
        
        const jadwal = { 
            user_id: user.id, 
            kode_matkul: kode, 
            mata_kuliah: nama, 
            prodi: prodi, 
            hari: hari, 
            jam_mulai: document.getElementById("jam_mulai").value, 
            jam_akhir: document.getElementById("jam_akhir").value, 
            sks: parseInt(sks), 
            dosen: dosen, 
            asisten: asisten, 
            semester: semester, 
            kelas: kelas, 
            ruangan: ruangan, 
            tahun_akademik: tahun_akademik, 
        }; 
        
        const { error } = await supabaseClient.from("jadwal").insert([jadwal]); 
        
        if (error) { 
            console.error(error); 
            showToast("Gagal menambah jadwal: " + error.message, 'error'); 
        } else { 
            showToast("Jadwal berhasil ditambahkan!", 'success'); 
            // Reset form 
            tsMataKuliah.setValue(''); 
            document.getElementById("dosen").tomselect.setValue(''); 
            document.getElementById("asisten").tomselect.setValue(''); 
            document.getElementById("sks").value = ''; 
            document.getElementById("jam_mulai").value = ''; 
            document.getElementById("jam_akhir").value = ''; 
            document.getElementById("prodi").value = ''; 
            document.getElementById("hari").value = ''; 
            document.getElementById("semester").value = ''; 
            document.getElementById("kelas").value = ''; 
            document.getElementById("ruangan").value = ''; 
            document.getElementById("tahun_akademik").value = ''; 
            loadData(); 
        } 
    } 

    // --- FUNGSI Edit Jadwal (Modal) --- 
    function editJadwal(id) { 
        const row = semuaData.find(r => r.id === id); 
        if (!row) return showToast("Data tidak ditemukan.", 'error'); 
        
        document.getElementById('edit_id').value = row.id; 
        document.getElementById('edit_prodi').value = row.prodi || ''; 
        document.getElementById('edit_hari').value = row.hari || '-'; 
        document.getElementById('edit_jam_mulai').value = row.jam_mulai || ''; 
        document.getElementById('edit_jam_akhir').value = row.jam_akhir || ''; 
        document.getElementById('edit_sks').value = row.sks || ''; 
        document.getElementById('edit_semester').value = row.semester || ''; 
        document.getElementById('edit_kelas').value = row.kelas || ''; 
        document.getElementById('edit_ruangan').value = row.ruangan || ''; 
        document.getElementById('edit_tahun_akademik').value = row.tahun_akademik || '';

        // Nilai yang harus dipilih di TomSelect Mata Kuliah 
        const mkValueToSelect = (row.kode_matkul && row.mata_kuliah) ? `${row.kode_matkul} | ${row.mata_kuliah}` : ''; 

        // Set value for TomSelects
        tsEditMataKuliah.setValue(mkValueToSelect); 
        
        // Dosen & Asisten (Menggunakan TomSelect API)
        document.getElementById('edit_dosen').tomselect.setValue(row.dosen || '');
        document.getElementById('edit_asisten').tomselect.setValue(row.asisten || '');

        document.getElementById('editModal').classList.remove('hidden'); 
        document.getElementById('editModal').classList.add('flex'); 
    } 

    // --- FUNGSI Update Jadwal --- 
    async function updateJadwal() { 
        const id = document.getElementById('edit_id').value; 
        
        // Ambil nilai dari TomSelect Mata Kuliah
        const mkValue = tsEditMataKuliah.getValue();
        if (!mkValue) { 
            showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning'); 
            return; 
        } 
        const [kode, nama] = mkValue.split(' | ').map(s => s.trim()); 

        const prodi = document.getElementById('edit_prodi').value; 
        const hari = document.getElementById('edit_hari').value; 
        const jam_mulai = document.getElementById('edit_jam_mulai').value; 
        const jam_akhir = document.getElementById('edit_jam_akhir').value; 
        const sks = document.getElementById('edit_sks').value; 
        const semester = document.getElementById('edit_semester').value; 
        const kelas = document.getElementById('edit_kelas').value; 
        const ruangan = document.getElementById('edit_ruangan').value; 
        const tahun_akademik = document.getElementById('edit_tahun_akademik').value;
        
        // AMBIL NILAI DARI TOMSELECT Dosen & Asisten 
        const dosen = document.getElementById("edit_dosen").tomselect.getValue(); 
        const asisten = document.getElementById("edit_asisten").tomselect.getValue(); 

        if (!prodi || !hari || !semester || !dosen || !kelas || !ruangan || !sks || !tahun_akademik) { 
            showToast("Semua kolom wajib diisi!", 'warning'); 
            return; 
        } 

        const updatedJadwal = { 
            kode_matkul: kode, 
            mata_kuliah: nama, 
            prodi: prodi, 
            hari: hari, 
            jam_mulai: jam_mulai, 
            jam_akhir: jam_akhir, 
            sks: parseInt(sks), 
            dosen: dosen, 
            asisten: asisten, 
            semester: semester, 
            kelas: kelas, 
            ruangan: ruangan, 
            tahun_akademik: tahun_akademik,
        }; 

        const { error } = await supabaseClient.from("jadwal").update(updatedJadwal).eq('id', id); 

        if (error) { 
            console.error(error); 
            showToast("Gagal memperbarui jadwal: " + error.message, 'error'); 
        } else { 
            showToast("Jadwal berhasil diperbarui!", 'success'); 
            document.getElementById('editModal').classList.add('hidden'); 
            document.getElementById('editModal').classList.remove('flex'); 
            loadData(); 
        } 
    } 

    // --- FUNGSI Hapus Jadwal --- 
    async function hapusJadwal(id) { 
        if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) return; 

        const { error } = await supabaseClient.from("jadwal").delete().eq("id", id); 

        if (error) { 
            console.error(error); 
            showToast("Gagal menghapus jadwal: " + error.message, 'error'); 
        } else { 
            showToast("Jadwal berhasil dihapus!", 'success'); 
            loadData(); 
        } 
    } 

    // --- FUNGSI Filter Data --- 
    function filterData() { 
        const filterProdi = document.getElementById('filterProdi').value; 
        const filterSemester = document.getElementById('filterSemester').value; 
        const filterKelas = document.getElementById('filterKelas').value; 
        const filterTahunAkademik = document.getElementById('filterTahunAkademik').value;
        
        // Filter TomSelect
        const filterMkValue = tsFilterMataKuliah.getValue();
        const filterDosenValue = tsFilterDosen.getValue();
        
        let filteredData = semuaData.filter(row => { 
            const isProdiMatch = !filterProdi || row.prodi === filterProdi; 
            const isSemesterMatch = !filterSemester || row.semester === filterSemester; 
            const isKelasMatch = !filterKelas || row.kelas === filterKelas; 
            const isTahunAkademikMatch = !filterTahunAkademik || row.tahun_akademik === filterTahunAkademik;
            
            const isMkMatch = !filterMkValue || `${row.kode_matkul} | ${row.mata_kuliah}` === filterMkValue;
            const isDosenMatch = !filterDosenValue || row.dosen === filterDosenValue;

            return isProdiMatch && isSemesterMatch && isKelasMatch && isTahunAkademikMatch && isMkMatch && isDosenMatch; 
        }); 

        tampilkanData(filteredData); 
        showToast(`Menampilkan ${filteredData.length} dari ${semuaData.length} data.`, 'info');
    }

    // --- FUNGSI Export Excel --- 
    function exportExcel() { 
        const dataForExport = dataYangDitampilkan.map((row, index) => ({ 
            No: index + 1, 
            'Tahun Akademik': row.tahun_akademik || "-",
            'Kode MK': row.kode_matkul || "-",
            'Prodi': row.prodi || "-", 
            'Hari': row.hari || "-", 
            'Jam Mulai': row.jam_mulai || "-", 
            'Jam Akhir': row.jam_akhir || "-", 
            'Mata Kuliah': row.mata_kuliah || "-", 
            'SKS': row.sks || "-", 
            'Dosen': row.dosen || "-", 
            'Asisten': row.asisten || "-", 
            'Semester': row.semester || "-", 
            'Kelas': row.kelas || "-", 
            'Ruangan': row.ruangan || "-", 
        })); 

        if (dataForExport.length === 0) {
            showToast("Tidak ada data untuk di-export!", 'warning');
            return;
        }

        const worksheet = XLSX.utils.json_to_sheet(dataForExport); 
        const workbook = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(workbook, worksheet, "Jadwal_Kuliah"); 
        XLSX.writeFile(workbook, "Jadwal_Kuliah_FT.xlsx"); 
        
        showToast("Data berhasil diekspor ke Excel!", 'success');
    }

    // --- FUNGSI Export PDF --- 
    function exportPDF() { 
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ 
            orientation: 'landscape', 
            unit: 'mm', 
            format: 'a4' 
        }); 

        const tableColumn = [ 
            "No", "T.A", "Kode", "Prodi", "Hari", "Mulai", "Akhir", 
            "Mata Kuliah", "SKS", "Dosen", "Asisten", "Smt", "Kls", "Rgn" 
        ]; 
        
        const tableRows = []; 
        dataYangDitampilkan.forEach((row, index) => { 
            const jadwalData = [ 
                index + 1, 
                row.tahun_akademik || "-", 
                row.kode_matkul || "-", 
                row.prodi || "-", 
                row.hari || "-", 
                row.jam_mulai || "-", 
                row.jam_akhir || "-", 
                row.mata_kuliah || "-", 
                row.sks || "-", 
                row.dosen || "-", 
                row.asisten || "-", 
                row.semester || "-", 
                row.kelas || "-", 
                row.ruangan || "-", 
            ]; 
            tableRows.push(jadwalData); 
        }); 

        if (tableRows.length === 0) {
            showToast("Tidak ada data untuk di-export!", 'warning');
            return;
        }

        // Warna latar belakang berdasarkan Prodi
        const prodiColorMap = {
            'Industri': { header: [252, 235, 235], text: [120, 27, 27] },
            'Sipil': { header: [235, 245, 251], text: [29, 78, 216] },
            'Arsitektur': { header: [234, 247, 238], text: [21, 128, 61] },
            'Elektro': { header: [250, 235, 215], text: [136, 78, 0] },
            'Informatika': { header: [255, 251, 230], text: [113, 113, 3] },
        };
        const defaultColor = { header: [209, 213, 219], text: [55, 65, 81] }; // Gray

        // Helper untuk mendapatkan warna prodi
        const getProdiColor = (prodi) => prodiColorMap[prodi] || defaultColor;

        doc.setFontSize(14);
        doc.text("LAPORAN JADWAL KULIAH FAKULTAS TEKNIK", doc.internal.pageSize.width / 2, 10, { align: 'center' });
        doc.setFontSize(9);
        doc.text(`Total Data: ${dataYangDitampilkan.length}`, 5, 15);
        
        let currentY = 20;

        // Custom autoTable to apply row styles
        doc.autoTable(tableColumn, tableRows, { 
            startY: currentY, 
            theme: 'grid', 
            styles: { fontSize: 7, cellPadding: 1.5, halign: 'left' }, 
            margin: { left: 5, right: 5 }, 
            headStyles: { 
                fillColor: defaultColor.header, 
                textColor: defaultColor.text, 
                fontStyle: 'bold', 
                halign: 'center' 
            }, 
            columnStyles: { 
                0: { halign: 'center', cellWidth: 7 }, 1: { halign: 'center', cellWidth: 10 }, 
                2: { halign: 'center', cellWidth: 15 }, 4: { halign: 'center', cellWidth: 12 }, 
                5: { halign: 'center', cellWidth: 12 }, 6: { halign: 'center', cellWidth: 12 }, 
                8: { halign: 'center', cellWidth: 7 }, 11: { halign: 'center', cellWidth: 8 }, 
                12: { halign: 'center', cellWidth: 8 }, 13: { halign: 'center', cellWidth: 12 }, 
                3: { halign: 'left', cellWidth: 20 }, 7: { halign: 'left', cellWidth: 35 }, 
                9: { halign: 'left', cellWidth: 25 }, 10: { halign: 'left', cellWidth: 25 }, 
            }, 
            didParseCell: function (data) { 
                if (data.section === 'body') { 
                    const rowIndex = data.row.index; 
                    const prodi = dataYangDitampilkan[rowIndex]?.prodi || ''; 
                    const colors = getProdiColor(prodi);

                    // Apply row background color to the first column for visual cue
                    if (data.column.index === 0) { 
                        data.cell.styles.fillColor = colors.header;
                    }

                } 
            },
            didDrawPage: function(data) {
                // Footer
                let str = "Halaman " + doc.internal.getNumberOfPages()
                doc.setFontSize(7)
                doc.text(str, doc.internal.pageSize.width - 5, doc.internal.pageSize.height - 5, {align: 'right'});
            }
        }); 

        doc.save("Jadwal_Kuliah_FT.pdf");
        showToast("Data berhasil diekspor ke PDF!", 'success');
    }
    </script>


</body>
</html>
