<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jadwal Kuliah</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMD/cd8kF+5p9j0z9/bW5gB5zU1l4f5k8qC3Z5E9Qy6A5CM41vzapQJoB1MvJkPQE03o" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    /* Styling khusus untuk tabel */
    .row-Industri { background-color: #ffeaea; }
    .row-Sipil { background-color: #eaf8ff; }
    .row-Arsitektur { background-color: #eaffea; }
    .row-Elektro { background-color: #fff4eb; }
    .row-Informatika { background-color: #ffffea; }

    .icon-btn { padding: 6px 10px; margin: 0; }
    
    /* TomSelect Override untuk Tailwind */
    .ts-wrapper.single.focus .ts-control { border-color: #3b82f6 !important; box-shadow: 0 0 0 1px #3b82f6 !important; }
    .ts-control { border-radius: 4px !important; padding: 10px !important; height: auto !important; }
    .ts-wrapper .dropdown-input { border: none !important; }

    /* Modal Styling */
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    .modal-container { max-width: 90%; width: 800px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
    <div class="flex items-center space-x-3">
        <img src="logo.jpeg" alt="Logo FT" class="h-8 w-8 rounded-full">
        <span class="text-xl font-bold text-white">Fakultas Teknik</span>
    </div>
    <div class="space-x-4">
        <button onclick="window.location.href='dashboard.html'" class="text-white hover:text-blue-200">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </button>
        <button onclick="window.location.href='mahasiswa.html'" class="text-white hover:text-blue-200">
            <i class="fas fa-users"></i> Mahasiswa
        </button>
        <button onclick="logout()" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </div>
  </nav>

  <div class="pt-24 pb-8 px-6 max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Manajemen Jadwal Kuliah</h1>

    <div id="jadwal-form" class="bg-white p-6 rounded-lg shadow-xl mb-8 border-t-4 border-green-500">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Tambah Jadwal Baru</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        
        <div>
          <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label>
          <select id="tahun_akademik" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Kode Mata Kuliah / Nama</label>
          <select id="kode_matkul_search" class="mt-1 block w-full"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Prodi</label>
          <select id="prodi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option disabled selected>Pilih Prodi</option>
            <option value="Industri">Industri</option>
            <option value="Sipil">Sipil</option>
            <option value="Arsitektur">Arsitektur</option>
            <option value="Elektro">Elektro</option>
            <option value="Informatika">Informatika</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">SKS</label>
          <input type="number" id="sks" placeholder="Otomatis terisi" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Hari</label>
          <select id="hari" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option disabled selected>Pilih Hari</option>
            <option value="Senin">Senin</option>
            <option value="Selasa">Selasa</option>
            <option value="Rabu">Rabu</option>
            <option value="Kamis">Kamis</option>
            <option value="Jumat">Jumat</option>
            <option value="Sabtu">Sabtu</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Jam Mulai</label>
          <input type="time" id="jam_mulai" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Jam Akhir</label>
          <input type="time" id="jam_akhir" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Dosen Pengampu</label>
          <select id="dosen" class="mt-1 block w-full"></select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Asisten (Opsional)</label>
          <select id="asisten" class="mt-1 block w-full"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Semester</label>
          <select id="semester" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option disabled selected>Pilih Semester</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Kelas</label>
          <select id="kelas" class="mt-1 block w-full"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Ruangan</label>
          <select id="ruangan" class="mt-1 block w-full"></select>
        </div>

      </div>
      <div class="mt-6 text-center">
        <button id="submit-btn" onclick="simpanJadwal()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
          <i class="fas fa-plus-circle"></i> Simpan Jadwal
        </button>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-xl mb-8 border-t-4 border-blue-500">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Filter & Ekspor Data</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label>
          <select id="filterTahunAkademik" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Prodi</label>
          <select id="filterProdi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option value="">Semua Prodi</option>
            <option value="Industri">Industri</option>
            <option value="Sipil">Sipil</option>
            <option value="Arsitektur">Arsitektur</option>
            <option value="Elektro">Elektro</option>
            <option value="Informatika">Informatika</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Semester</label>
          <select id="filterSemester" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <option value="">Semua Semester</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Dosen</label>
          <select id="filterDosen" class="mt-1 block w-full"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
          <select id="filterMataKuliah" class="mt-1 block w-full"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Kelas</label>
          <select id="filterKelas" class="mt-1 block w-full"></select>
        </div>
      </div>
      <div class="text-right space-x-2">
        <button onclick="filterData()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
          <i class="fas fa-filter"></i> Terapkan Filter
        </button>
        <button onclick="exportExcel()" class="export-btn excel-btn bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg">
          <i class="fas fa-file-excel"></i> Ekspor Excel
        </button>
        <button onclick="exportPDF()" class="export-btn pdf-btn bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg">
          <i class="fas fa-file-pdf"></i> Ekspor PDF
        </button>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-xl overflow-x-auto">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">Data Jadwal Kuliah</h2>
      <table id="tabelJadwal" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahun Akademik</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prodi</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hari</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Mulai</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Akhir</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Kuliah</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKS</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dosen</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asisten</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ruangan</th>
            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr><td colspan="15" class="text-center py-4 text-gray-500">Memuat konten penjadwalan...</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden modal-overlay z-20">
    <div class="relative top-20 mx-auto p-5 border w-full modal-container shadow-lg rounded-md bg-white">
      
      <div class="flex justify-between items-center pb-3 border-b">
        <h3 class="text-2xl font-bold text-gray-900">Edit Jadwal Kuliah</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="mt-4">
        <input type="hidden" id="edit_id">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
            
            <div>
              <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label>
              <select id="edit_tahun_akademik" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Kode Mata Kuliah / Nama</label>
              <select id="edit_kode_matkul_search" class="mt-1 block w-full"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Prodi</label>
              <select id="edit_prodi" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <option value="Industri">Industri</option>
                <option value="Sipil">Sipil</option>
                <option value="Arsitektur">Arsitektur</option>
                <option value="Elektro">Elektro</option>
                <option value="Informatika">Informatika</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">SKS</label>
              <input type="number" id="edit_sks" readonly class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Hari</label>
              <select id="edit_hari" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Jam Mulai</label>
              <input type="time" id="edit_jam_mulai" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Jam Akhir</label>
              <input type="time" id="edit_jam_akhir" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Dosen Pengampu</label>
              <select id="edit_dosen" class="mt-1 block w-full"></select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Asisten (Opsional)</label>
              <select id="edit_asisten" class="mt-1 block w-full"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Semester</label>
              <select id="edit_semester" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Kelas</label>
              <select id="edit_kelas" class="mt-1 block w-full"></select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Ruangan</label>
              <select id="edit_ruangan" class="mt-1 block w-full"></select>
            </div>

          </div>
        </div>

      <div class="mt-6 text-right">
        <button onclick="updateJadwal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
          <i class="fas fa-save"></i> Perbarui
        </button>
        <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
          Batal
        </button>
      </div>

    </div>
  </div>


<script>
    // --- KONFIGURASI SUPABASE ---
    // GANTI DENGAN URL DAN KEY SUPABASE ANDA YANG AKTIF
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARIABEL GLOBAL ---
    let dataYangDitampilkan = [];
    let allMatakuliah = [];
    let globalUserId = null; 

    // TomSelect Variables
    let dosenSelect, asistenSelect, ruanganSelect, kelasSelect;
    let editDosenSelect, editAsistenSelect, editRuanganSelect, editKelasSelect;
    let filterMataKuliahSelect, filterDosenSelect, filterKelasSelect;
    let kodeMatkulSearchSelect, editKodeMatkulSearchSelect; 

    // --- FUNGSI BANTUAN TAMPILAN ---

    // Fungsi untuk mendapatkan warna baris berdasarkan Prodi
    function getProdiColors(prodi) {
        switch (prodi) {
            case 'Industri': return { row: 'row-Industri', header: '#ffcccc', text: '#800000' };
            case 'Sipil': return { row: 'row-Sipil', header: '#cceeff', text: '#000080' };
            case 'Arsitektur': return { row: 'row-Arsitektur', header: '#ccffcc', text: '#006400' };
            case 'Elektro': return { row: 'row-Elektro', header: '#ffebcc', text: '#8b4513' };
            case 'Informatika': return { row: 'row-Informatika', header: '#ffffcc', text: '#808000' };
            default: return { row: '', header: '#f3f4f6', text: '#000000' };
        }
    }
    
    // --- FUNGSI INIALISASI TOMSELECT (DENGAN PERBAIKAN DESTROY) ---

    const initializeTomSelects = (mode) => {
        const elementId = mode === 'add' ? 'kode_matkul_search' : 'edit_kode_matkul_search';
        
        // Tentukan variabel global yang sesuai
        const currentTomSelect = mode === 'add' ? kodeMatkulSearchSelect : editKodeMatkulSearchSelect;
        
        // Cek apakah instance TomSelect sudah ada sebelum destroy
        if (currentTomSelect && currentTomSelect.destroy) { 
            currentTomSelect.destroy(); 
        }

        const selectElement = document.getElementById(elementId);
        if (!selectElement) return;

        const dataOptions = allMatakuliah.map(mk => ({
            value: mk.kode_matkul,
            text: `${mk.kode_matkul} - ${mk.nama_matkul}`,
            nama_matkul: mk.nama_matkul,
            sks: mk.sks,
        }));
        
        const tomSelect = new TomSelect(`#${elementId}`, {
            valueField: 'value',
            labelField: 'text',
            searchField: ['value', 'text'],
            options: dataOptions,
            sortField: [{field: 'value', direction: 'asc'}],
            placeholder: "Cari Kode / Mata Kuliah",
            create: false,
            maxItems: 1,
            onChange: (value) => {
                const matkul = allMatakuliah.find(mk => mk.kode_matkul === value);
                if (matkul) {
                    // Update SKS berdasarkan Mata Kuliah
                    if (mode === 'add') {
                        document.getElementById('sks').value = matkul.sks;
                    } else if (mode === 'edit') {
                        document.getElementById('edit_sks').value = matkul.sks;
                    }
                }
            }
        });

        // Simpan instance baru ke variabel global
        if (mode === 'add') {
            kodeMatkulSearchSelect = tomSelect;
        } else {
            editKodeMatkulSearchSelect = tomSelect;
        }

        return tomSelect;
    }


    async function loadReferences() {
        if (!supabaseClient) {
            console.error("Supabase client not initialized.");
            return;
        }
        
        // 1. Ambil data Mata Kuliah
        const { data: mkData, error: mkError } = await supabaseClient
            .from('mata_kuliah')
            .select('kode_matkul, nama_matkul, sks');

        if (mkError) {
            console.error("Gagal memuat mata kuliah:", mkError);
        }
        allMatakuliah = mkData || [];

        // Inisialisasi Tom Select untuk tambah dan edit jadwal
        initializeTomSelects('add');
        initializeTomSelects('edit');

        // Tom Select untuk Filter Mata Kuliah
        const filterMatkulOptions = [{value: "", text: "Semua Mata Kuliah"}].concat(
            allMatakuliah.map(mk => ({
                value: mk.kode_matkul,
                text: `${mk.nama_matkul} (${mk.kode_matkul})`
            }))
        );
        
        if (filterMataKuliahSelect && filterMataKuliahSelect.destroy) filterMataKuliahSelect.destroy();

        filterMataKuliahSelect = new TomSelect("#filterMataKuliah", {
            options: filterMatkulOptions,
            valueField: 'value',
            labelField: 'text',
            searchField: ['value', 'text'],
            create: false,
            placeholder: "Filter Mata Kuliah",
            onInitialize: function() {
                this.setValue("");
            }
        });
        // --- PERBAIKAN: Listener untuk filter TomSelects
        filterMataKuliahSelect.on('change', filterData);
        // ------------------------------------------------


        // 2. Ambil data Dosen, Ruangan, Kelas
        for (const ref of references) {
            const { data, error } = await supabaseClient
                .from(ref.table)
                .select(ref.column)
                .order(ref.column, { ascending: true });

            if (error) {
                console.error(`Gagal memuat data ${ref.table}:`, error);
                continue;
            }

            const uniqueData = Array.from(new Set(data.map(item => item[ref.column]))).filter(Boolean);
            
            // Inisialisasi Tom Selects (Dosen, Asisten, Ruangan, Kelas)
            const options = uniqueData.map(d => ({value: d, text: d}));
            
            // Dosen & Asisten (Menggunakan data yang sama: tabel 'dosen')
            if (ref.elementId === 'dosen') {
                // Input Dosen (tambah & edit)
                if (dosenSelect && dosenSelect.destroy) dosenSelect.destroy();
                dosenSelect = new TomSelect("#dosen", { create: false, placeholder: references.find(r => r.elementId === 'dosen').defaultText, options: options.filter(o => o.value !== "") });
                
                if (editDosenSelect && editDosenSelect.destroy) editDosenSelect.destroy();
                editDosenSelect = new TomSelect("#edit_dosen", { create: false, placeholder: references.find(r => r.elementId === 'dosen').defaultText, options: options.filter(o => o.value !== "") });
                
                // Input Asisten (tambah & edit)
                if (asistenSelect && asistenSelect.destroy) asistenSelect.destroy();
                asistenSelect = new TomSelect("#asisten", { create: false, placeholder: references.find(r => r.elementId === 'asisten').defaultText, options: options.filter(o => o.value !== "") });
                
                if (editAsistenSelect && editAsistenSelect.destroy) editAsistenSelect.destroy();
                editAsistenSelect = new TomSelect("#edit_asisten", { create: false, placeholder: references.find(r => r.elementId === 'asisten').defaultText, options: options.filter(o => o.value !== "") });

                 // Filter Dosen
                 const filterDosenOptions = [{value: "", text: ref.filterDefaultText}].concat(options.filter(o => o.value !== ""));
                 if (filterDosenSelect && filterDosenSelect.destroy) filterDosenSelect.destroy();
                 filterDosenSelect = new TomSelect(`#${ref.filterElementId}`, { 
                    create: false, 
                    placeholder: ref.filterDefaultText,
                    options: filterDosenOptions,
                    onInitialize: function() { this.setValue(""); }
                });
                // --- PERBAIKAN: Listener untuk filter TomSelects
                filterDosenSelect.on('change', filterData);
                // ------------------------------------------------
            }

            // Ruangan
            if (ref.elementId === 'ruangan') {
                if (ruanganSelect && ruanganSelect.destroy) ruanganSelect.destroy();
                ruanganSelect = new TomSelect("#ruangan", { create: false, placeholder: ref.defaultText, options: options.filter(o => o.value !== "") });
                
                if (editRuanganSelect && editRuanganSelect.destroy) editRuanganSelect.destroy();
                editRuanganSelect = new TomSelect("#edit_ruangan", { create: false, placeholder: ref.defaultText, options: options.filter(o => o.value !== "") });
            }

            // Kelas
            if (ref.elementId === 'kelas') {
                // Input Kelas (tambah & edit)
                if (kelasSelect && kelasSelect.destroy) kelasSelect.destroy();
                kelasSelect = new TomSelect("#kelas", { create: false, placeholder: ref.defaultText, options: options.filter(o => o.value !== "") });
                
                if (editKelasSelect && editKelasSelect.destroy) editKelasSelect.destroy();
                editKelasSelect = new TomSelect("#edit_kelas", { create: false, placeholder: ref.defaultText, options: options.filter(o => o.value !== "") });

                // Filter Kelas
                const filterKelasOptions = [{value: "", text: ref.filterDefaultText}].concat(options.filter(o => o.value !== ""));
                if (filterKelasSelect && filterKelasSelect.destroy) filterKelasSelect.destroy();
                filterKelasSelect = new TomSelect(`#${ref.filterElementId}`, { 
                    create: false, 
                    placeholder: ref.filterDefaultText,
                    options: filterKelasOptions,
                    onInitialize: function() { this.setValue(""); }
                });
                // --- PERBAIKAN: Listener untuk filter TomSelects
                filterKelasSelect.on('change', filterData);
                // ------------------------------------------------
            }
        }

        // 3. Ambil data Tahun Akademik (untuk input dan filter)
        const { data: taData, error: taError } = await supabaseClient
            .from('tahun_akademik')
            .select('tahun_akademik')
            .order('tahun_akademik', { ascending: false });

        if (taError) {
            console.error("Gagal memuat tahun akademik:", taError);
            return;
        }

        const tahunAkademikOptions = Array.from(new Set(taData.map(item => item.tahun_akademik))).filter(Boolean).sort((a, b) => b.localeCompare(a));
        const taDefaultText = 'Pilih Tahun Akademik';
        const taFilterDefaultText = 'Semua Tahun Akademik';
        
        // Menggunakan fungsi populateSelect untuk dropdown biasa
        populateSelect('tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('edit_tahun_akademik', tahunAkademikOptions, taDefaultText);
        
        // Filter Tahun Akademik (Dropdown biasa)
        const filterTaElement = document.getElementById('filterTahunAkademik');
        if(filterTaElement) {
             filterTaElement.innerHTML = ''; // Kosongkan
             // Tambahkan default option
             const defaultOption = document.createElement('option');
             defaultOption.value = "";
             defaultOption.textContent = taFilterDefaultText;
             filterTaElement.appendChild(defaultOption);
             // Tambahkan opsi dari data
             tahunAkademikOptions.forEach(optionValue => {
                 const option = document.createElement('option');
                 option.value = optionValue;
                 option.textContent = optionValue;
                 filterTaElement.appendChild(option);
             });
             // Listener sudah ada di DOMContentLoaded
        }

        // Setelah semua referensi dimuat, panggil loadData
        await loadData();
    }


    // --- FUNGSI POPULATE SELECT (Dropdown Biasa) ---

    // Data referensi untuk pengulangan
    const references = [
        { table: 'dosen', column: 'nama', elementId: 'dosen', defaultText: 'Pilih Dosen', filterElementId: 'filterDosen', filterDefaultText: 'Semua Dosen' },
        { table: 'dosen', column: 'nama', elementId: 'asisten', defaultText: 'Pilih Asisten (Opsional)', filterElementId: 'filterAsisten', filterDefaultText: 'Semua Asisten' },
        { table: 'ruangan', column: 'nama', elementId: 'ruangan', defaultText: 'Pilih Ruangan', filterElementId: 'filterRuangan', filterDefaultText: 'Semua Ruangan' },
        { table: 'kelas', column: 'nama', elementId: 'kelas', defaultText: 'Pilih Kelas', filterElementId: 'filterKelas', filterDefaultText: 'Semua Kelas' },
    ];

    function populateSelect(selectId, options, defaultText, isFilter = false) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;

        // Kosongkan opsi yang ada
        selectElement.innerHTML = '';
        
        // Tambahkan default option
        const defaultOption = document.createElement('option');
        defaultOption.value = isFilter ? "" : "";
        defaultOption.textContent = defaultText;
        if (!isFilter) {
            defaultOption.disabled = true;
            defaultOption.selected = true;
        }
        selectElement.appendChild(defaultOption);

        // Tambahkan opsi dari data
        options.forEach(optionValue => {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            selectElement.appendChild(option);
        });
    }

    // --- FUNGSI UTAMA (CRUD & FETCH DATA) ---

    async function checkAuthAndLoad() {
        const { data: userData } = await supabaseClient.auth.getUser();
        const user = userData.user;

        if (!user) {
            window.location.href = "index.html"; 
            return;
        }
        globalUserId = user.id;

        await loadReferences(); 
    }

    async function loadData(filters = {}) {
        const tbody = document.querySelector('#tabelJadwal tbody');
        if (!tbody) return;
        
        tbody.innerHTML = `<tr><td colspan="15" class="text-center py-4 text-gray-500">Memuat konten penjadwalan...</td></tr>`;

        let query = supabaseClient.from('jadwal_kuliah').select('*').order('hari', { ascending: true }).order('jam_mulai', { ascending: true });

        // Terapkan filter
        if (filters.prodi) query = query.eq('prodi', filters.prodi);
        if (filters.semester) query = query.eq('semester', filters.semester);
        if (filters.kelas) query = query.eq('kelas', filters.kelas);
        if (filters.kode_matkul) query = query.eq('kode_matkul', filters.kode_matkul);
        if (filters.dosen) query = query.eq('dosen', filters.dosen);
        if (filters.tahun_akademik) query = query.eq('tahun_akademik', filters.tahun_akademik);

        const { data, error } = await query;
        
        tbody.innerHTML = ''; // Clear loading message

        if (error) {
            console.error("Gagal memuat data jadwal:", error);
            tbody.innerHTML = `<tr><td colspan="15" class="text-center py-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            dataYangDitampilkan = [];
            return;
        }

        dataYangDitampilkan = data; 
        
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="15" class="text-center py-4 text-gray-500">Tidak ada data jadwal yang ditemukan.</td></tr>`;
            return;
        }

        data.forEach((jadwal, index) => {
            const row = tbody.insertRow();
            const colors = getProdiColors(jadwal.prodi);
            row.className = colors.row; 

            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = jadwal.tahun_akademik || '-';
            row.insertCell().textContent = jadwal.kode_matkul || '-';
            row.insertCell().textContent = jadwal.prodi || '-';
            row.insertCell().textContent = jadwal.hari || '-';
            row.insertCell().textContent = jadwal.jam_mulai ? jadwal.jam_mulai.substring(0, 5) : '-';
            row.insertCell().textContent = jadwal.jam_akhir ? jadwal.jam_akhir.substring(0, 5) : '-';
            
            // Cari nama mata kuliah dari allMatakuliah
            const matkul = allMatakuliah.find(mk => mk.kode_matkul === jadwal.kode_matkul);
            row.insertCell().textContent = matkul ? matkul.nama_matkul : '-';
            
            row.insertCell().textContent = jadwal.sks || '-';
            row.insertCell().textContent = jadwal.dosen || '-';
            row.insertCell().textContent = jadwal.asisten || '-';
            row.insertCell().textContent = jadwal.semester || '-';
            row.insertCell().textContent = jadwal.kelas || '-';
            row.insertCell().textContent = jadwal.ruangan || '-';

            const actionCell = row.insertCell();
            actionCell.className = "text-center";
            actionCell.innerHTML = `
                <button onclick="editJadwal('${jadwal.id}')" class="bg-yellow-500 text-white icon-btn rounded-l" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteJadwal('${jadwal.id}')" class="bg-red-500 text-white icon-btn rounded-r" title="Hapus">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
        });
    }

    async function simpanJadwal() {
        // Ambil nilai dari TomSelects dan input/select biasa
        const jadwalBaru = {
            tahun_akademik: document.getElementById('tahun_akademik').value,
            // Cek instance sebelum getValue()
            kode_matkul: kodeMatkulSearchSelect ? kodeMatkulSearchSelect.getValue() : '',
            prodi: document.getElementById('prodi').value,
            hari: document.getElementById('hari').value,
            jam_mulai: document.getElementById('jam_mulai').value,
            jam_akhir: document.getElementById('jam_akhir').value,
            sks: parseInt(document.getElementById('sks').value) || 0,
            dosen: dosenSelect ? dosenSelect.getValue() : '',
            asisten: asistenSelect ? asistenSelect.getValue() : '',
            semester: document.getElementById('semester').value,
            kelas: kelasSelect ? kelasSelect.getValue() : '',
            ruangan: ruanganSelect ? ruanganSelect.getValue() : '',
        };
        
        // Validasi Sederhana
        if (!jadwalBaru.tahun_akademik || !jadwalBaru.kode_matkul || !jadwalBaru.prodi || !jadwalBaru.hari || !jadwalBaru.jam_mulai || !jadwalBaru.jam_akhir || !jadwalBaru.dosen || !jadwalBaru.semester || !jadwalBaru.kelas || !jadwalBaru.ruangan) {
            alert("❌ Harap lengkapi semua kolom wajib (kecuali Asisten).");
            return;
        }

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .insert([jadwalBaru]);

        if (error) {
            alert("❌ Gagal menyimpan jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil ditambahkan!");
            // Reset Form (kecuali Tahun Akademik dan Prodi untuk kemudahan input berulang)
            document.getElementById('prodi').value = "";
            document.getElementById('hari').value = "";
            document.getElementById('jam_mulai').value = "";
            document.getElementById('jam_akhir').value = "";
            document.getElementById('sks').value = "";
            if (kodeMatkulSearchSelect) kodeMatkulSearchSelect.clear();
            if (dosenSelect) dosenSelect.clear();
            if (asistenSelect) asistenSelect.clear();
            document.getElementById('semester').value = "";
            if (kelasSelect) kelasSelect.clear();
            if (ruanganSelect) ruanganSelect.clear();
            
            // Muat ulang data
            filterData();
        }
    }
    
    // --- FUNGSI FILTER DATA ---

    function filterData() {
        const filters = {
            prodi: document.getElementById('filterProdi').value,
            semester: document.getElementById('filterSemester').value,
            // TomSelect filters (memastikan instance tidak null sebelum getValue)
            kelas: filterKelasSelect ? filterKelasSelect.getValue() : '',
            kode_matkul: filterMataKuliahSelect ? filterMataKuliahSelect.getValue() : '',
            dosen: filterDosenSelect ? filterDosenSelect.getValue() : '',
            // Select biasa
            tahun_akademik: document.getElementById('filterTahunAkademik').value,
        };
        
        loadData(filters);
    }

    // --- FUNGSI EDIT & DELETE ---

    async function editJadwal(id) {
        const jadwal = dataYangDitampilkan.find(j => j.id == id);
        if (!jadwal) return alert("Jadwal tidak ditemukan.");

        // Set nilai form edit
        document.getElementById('edit_id').value = id;
        
        // Set nilai TomSelect (Gunakan cek untuk memastikan instance ada)
        if (editKodeMatkulSearchSelect) editKodeMatkulSearchSelect.setValue(jadwal.kode_matkul, true);
        if (editDosenSelect) editDosenSelect.setValue(jadwal.dosen || '', true); // Set ke '' jika null
        if (editAsistenSelect) editAsistenSelect.setValue(jadwal.asisten || '', true);
        if (editRuanganSelect) editRuanganSelect.setValue(jadwal.ruangan || '', true);
        if (editKelasSelect) editKelasSelect.setValue(jadwal.kelas || '', true);

        // Dropdown/Input biasa
        document.getElementById('edit_prodi').value = jadwal.prodi;
        document.getElementById('edit_hari').value = jadwal.hari;
        document.getElementById('edit_jam_mulai').value = jadwal.jam_mulai ? jadwal.jam_mulai.substring(0, 5) : '';
        document.getElementById('edit_jam_akhir').value = jadwal.jam_akhir ? jadwal.jam_akhir.substring(0, 5) : '';
        document.getElementById('edit_sks').value = jadwal.sks;
        document.getElementById('edit_semester').value = jadwal.semester;
        document.getElementById('edit_tahun_akademik').value = jadwal.tahun_akademik;

        document.getElementById('editModal').classList.remove('hidden');
    }
    
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    async function updateJadwal() {
        const id = document.getElementById('edit_id').value;
        const dataUpdate = {
            tahun_akademik: document.getElementById('edit_tahun_akademik').value,
            kode_matkul: editKodeMatkulSearchSelect ? editKodeMatkulSearchSelect.getValue() : '',
            prodi: document.getElementById('edit_prodi').value,
            hari: document.getElementById('edit_hari').value,
            jam_mulai: document.getElementById('edit_jam_mulai').value,
            jam_akhir: document.getElementById('edit_jam_akhir').value,
            sks: parseInt(document.getElementById('edit_sks').value) || 0,
            dosen: editDosenSelect ? editDosenSelect.getValue() : '',
            asisten: editAsistenSelect ? editAsistenSelect.getValue() : '',
            semester: document.getElementById('edit_semester').value,
            kelas: editKelasSelect ? editKelasSelect.getValue() : '',
            ruangan: editRuanganSelect ? editRuanganSelect.getValue() : '',
        };

        if (!dataUpdate.kode_matkul || !dataUpdate.prodi || !dataUpdate.hari || !dataUpdate.jam_mulai || !dataUpdate.dosen || !dataUpdate.semester || !dataUpdate.kelas || !dataUpdate.ruangan || !dataUpdate.tahun_akademik) {
            alert("❌ Harap lengkapi semua kolom wajib.");
            return;
        }

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .update(dataUpdate)
            .eq('id', id);

        if (error) {
            alert("❌ Gagal memperbarui jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil diperbarui!");
            closeModal();
            filterData(); // Muat ulang data setelah update
        }
    }

    async function deleteJadwal(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) return;

        const { error } = await supabaseClient
            .from('jadwal_kuliah')
            .delete()
            .eq('id', id);

        if (error) {
            alert("❌ Gagal menghapus jadwal: " + error.message);
            console.error(error);
        } else {
            alert("✅ Jadwal berhasil dihapus!");
            filterData(); // Muat ulang data setelah hapus
        }
    }
    
    // --- FUNGSI EKSPORT ---

    function exportExcel() {
        if (dataYangDitampilkan.length === 0) {
            alert("Tidak ada data untuk diekspor.");
            return;
        }

        const headers = ["No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Jam Mulai", "Jam Akhir", "Mata Kuliah", "SKS", "Dosen", "Asisten", "Semester", "Kelas", "Ruangan"];
        const data = dataYangDitampilkan.map((j, index) => {
            const matkul = allMatakuliah.find(mk => mk.kode_matkul === j.kode_matkul);
            return [
                index + 1,
                j.tahun_akademik || '-',
                j.kode_matkul || '-',
                j.prodi || '-',
                j.hari || '-',
                j.jam_mulai ? j.jam_mulai.substring(0, 5) : '-',
                j.jam_akhir ? j.jam_akhir.substring(0, 5) : '-',
                matkul ? matkul.nama_matkul : '-',
                j.sks || '-',
                j.dosen || '-',
                j.asisten || '-',
                j.semester || '-',
                j.kelas || '-',
                j.ruangan || '-',
            ];
        });

        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Jadwal_Kuliah");
        XLSX.writeFile(wb, "Jadwal_Kuliah.xlsx");
    }

    function exportPDF() {
        if (dataYangDitampilkan.length === 0) {
            alert("Tidak ada data untuk diekspor.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape', format: 'a4' }); 

        const headers = [["No", "Tahun Akademik", "Kode", "Prodi", "Hari", "Mulai", "Akhir", "Mata Kuliah", "SKS", "Dosen", "Asisten", "Smt", "Kls", "Rgn"]];
        const rows = dataYangDitampilkan.map((j, index) => {
             const matkul = allMatakuliah.find(mk => mk.kode_matkul === j.kode_matkul);
            return [
                index + 1,
                j.tahun_akademik || '-',
                j.kode_matkul || '-',
                j.prodi || '-',
                j.hari || '-',
                j.jam_mulai ? j.jam_mulai.substring(0, 5) : '-',
                j.jam_akhir ? j.jam_akhir.substring(0, 5) : '-',
                matkul ? matkul.nama_matkul : '-',
                j.sks || '-',
                j.dosen || '-',
                j.asisten || '-',
                j.semester || '-',
                j.kelas || '-',
                j.ruangan || '-',
            ];
        });

        const currentFilterProdi = document.getElementById('filterProdi').value;
        const prodiColor = getProdiColors(currentFilterProdi);
        const prodiDisplay = currentFilterProdi || "Semua Prodi";

        doc.setFontSize(14);
        doc.text("JADWAL KULIAH FAKULTAS TEKNIK", 148.5, 15, { align: 'center' }); // A4 Landscape width is 297mm
        doc.setFontSize(10);
        doc.text(`Filter Prodi: ${prodiDisplay}`, 148.5, 20, { align: 'center' });

        doc.autoTable({
            startY: 25,
            head: headers,
            body: rows,
            theme: 'grid',
            styles: { fontSize: 7, cellPadding: 1.5, halign: 'left' },
            margin: { left: 5, right: 5 }, 
            headStyles: { 
                fillColor: prodiColor.header, 
                textColor: prodiColor.text, 
                fontStyle: 'bold', 
                halign: 'center' 
            },
            columnStyles: {
                0: { halign: 'center', cellWidth: 7 }, 1: { halign: 'center', cellWidth: 15 }, 
                2: { halign: 'center', cellWidth: 10 }, 4: { halign: 'center', cellWidth: 12 }, 
                5: { halign: 'center', cellWidth: 10 }, 6: { halign: 'center', cellWidth: 10 }, 
                8: { halign: 'center', cellWidth: 8 }, 11: { halign: 'center', cellWidth: 8 }, 
                12: { halign: 'center', cellWidth: 10 }, 13: { halign: 'center', cellWidth: 10 }, 
                3: { halign: 'left', cellWidth: 20 }, 7: { halign: 'left', cellWidth: 40 }, 
                9: { halign: 'left', cellWidth: 30 }, 10: { halign: 'left', cellWidth: 30 }, 
            },
            didParseCell: function (data) {
                if (data.section === 'body' && data.column.index === 3) {
                    const cellProdi = data.row.raw[3]; 
                    const cellColors = getProdiColors(cellProdi);
                    data.cell.styles.fillColor = cellColors.header;
                }
            }
        });

        doc.save('Jadwal_Kuliah.pdf');
    }
    
    // --- FUNGSI LOGOUT ---
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // --- INISIALISASI ---
    document.addEventListener('DOMContentLoaded', () => {
        // Tambahkan event listener untuk filter select biasa
        document.getElementById('filterProdi').addEventListener('change', filterData);
        document.getElementById('filterSemester').addEventListener('change', filterData);
        document.getElementById('filterTahunAkademik').addEventListener('change', filterData);
        
        // Panggil checkAuthAndLoad untuk memulai semuanya
        checkAuthAndLoad();
    });
    
    // Catatan: Event listener untuk filter TomSelects (Mata Kuliah, Dosen, Kelas)
    // sekarang diikat secara langsung di dalam fungsi loadReferences setelah TomSelect dibuat.

</script>
</body>
</html>
