<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manajemen Penjadwalan - Fakultas Teknik</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  
  <style>
    .active-link { background-color: #1d4ed8; color: white; border-left: 4px solid #f97316; }
    .main-content { height: calc(100vh - 4rem); }
    /* Tambahan Style dari blok tengah */
    body {
        background-image: url('kosong.jpeg'); 
        background-size: cover; 
        background-repeat: no-repeat; 
        background-attachment: fixed; 
        background-color: #f3f4f6; 
    }
    .bg-white {
        background-color: rgba(255, 255, 255, 0.9); 
        backdrop-filter: blur(5px); 
    }
    .bg-gray-50 {
        background-color: rgba(249, 250, 251, 0.9); 
    }
    .row-Industri { background-color: #fcebeb; } 
    .row-Sipil { background-color: #ebf5fb; }     
    .row-Arsitektur { background-color: #eaf7ee; } 
    .row-Elektro { background-color: #faebd7; }    
    .row-Informatika { background-color: #fffbe6; } 
    .icon-btn {
        padding: 0.5rem 0.75rem; 
    }
    /* TomSelect fix styling dengan Tailwind */
    .ts-control {
        border-radius: 0.25rem !important;
        border: 1px solid #d1d5db !important;
        padding: 0.5rem !important;
        min-height: 2.5rem !important; 
    }
  </style>
</head>
<body class="bg-gray-100">

<nav class="bg-blue-800 shadow-md h-16 fixed top-0 left-0 right-0 z-10 flex items-center justify-between px-6">
  <div class="flex items-center space-x-3">
    <img src="logo.jpeg" alt="Logo" class="h-10 w-auto">
    <span class="text-white text-xl font-semibold">AKADEMIK FT</span>
  </div>
  <div class="flex items-center space-x-4">
    <span id="userNameNav" class="text-white text-sm">Halo, AkademikFT</span>
  </div>
</nav>

<div class="flex pt-16 main-content">
  <aside class="w-64 bg-gray-900 text-white flex flex-col fixed inset-y-0 left-0 pt-16 shadow-xl">
    <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
       <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
        <i class="fas fa-chart-bar w-5"></i><span>Dashboard</span></a>
      <a href="main.html" class="active-link flex items-center space-x-3 p-3 rounded-lg">
        <i class="fas fa-calendar-alt w-5"></i><span>Penjadwalan</span></a>
      <a href="mahasiswa.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
        <i class="fas fa-address-card w-5"></i><span>Data Mahasiswa</span></a>
      <a href="dosen.html" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
        <i class="fas fa-user-tie w-5"></i><span>Data Dosen</span></a>
      <a href="dashboard.html#matkul" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
        <i class="fas fa-book w-5"></i><span>Mata Kuliah</span></a>
      <a href="dashboard.html#pengaturan" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 text-gray-300">
        <i class="fas fa-cog w-5"></i><span>Pengaturan</span></a>
    </nav>
    <div class="p-4 text-xs text-gray-400 border-t border-gray-700 mt-auto">
      <p>&copy; 2025 Akademik FT</p>
      <p>Designed by Rifqi & Alfi</p>
       <p>ABD</p>
    </div>
  </aside>

  <main class="flex-grow p-8 ml-64 overflow-y-auto bg-gray-100">
    <div class="container mx-auto">

<div class="max-w-6xl mx-auto p-6 bg-white shadow-md mt-6 rounded-xl">
    <h1 class="text-2xl font-bold mb-4">Manajemen Jadwal Kuliah</h1>
    
    <div class="mb-6 border p-4 rounded bg-gray-50">
      <h2 class="font-semibold mb-2">Tambah Jadwal</h2>
      <div class="grid grid-cols-3 gap-2"> 
        
        <select id="kode_matkul_search" placeholder="Cari Kode / Mata Kuliah" class="border p-2 rounded col-span-1">
            <option value="">Cari Kode / Mata Kuliah</option> 
        </select>
        
        <select id="prodi" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Prodi</option>
          <option value="Industri">Industri</option>
          <option value="Sipil">Sipil</option>
          <option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option>
          <option value="Informatika">Informatika</option>
        </select>
        
        <select id="hari" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Hari</option>
           <option value="-">-</option>
          <option value="Senin">Senin</option>
          <option value="Selasa">Selasa</option>
          <option value="Rabu">Rabu</option>
          <option value="Kamis">Kamis</option>
          <option value="Jumat">Jumat</option>
           <option value="Sabtu">Sabtu</option>
        </select>

        <input id="jam_mulai" type="time" placeholder="Jam Mulai" class="border p-2 rounded">
        <input id="jam_akhir" type="time" placeholder="Jam Akhir" class="border p-2 rounded">
        
        <input id="sks" type="number" placeholder="SKS" class="border p-2 rounded">

        <select id="dosen" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Dosen</option>
        </select>

        <select id="asisten" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Asisten</option>
        </select>

        <select id="semester" class="border p-2 rounded">
          <option value="" disabled selected>Pilih Semester</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
        </select>

        <select id="kelas" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Kelas</option>
        </select>

        <select id="ruangan" class="border p-2 rounded">
            <option value="" disabled selected>Pilih Ruangan</option>
        </select>
        
        <select id="tahun_akademik" class="border p-2 rounded col-span-1">
            <option value="" disabled selected>Pilih Tahun Akademik</option>
        </select>
      </div>
      <button onclick="simpanJadwal()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
    </div>
    
    <div class="flex items-center mb-3 space-x-2 flex-wrap">
      <select id="filterProdi" class="border p-2 rounded min-w-min">
        <option value="">Semua Prodi</option>
         <option value="Industri">Industri</option>
          <option value="Sipil">Sipil</option>
          <option value="Arsitektur">Arsitektur</option>
          <option value="Elektro">Elektro</option>
          <option value="Informatika">Informatika</option>
      </select>
       <select id="filterSemester" class="border p-2 rounded min-w-min">
        <option value="">Semua Semester</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
      </select>
      
      <select id="filterKelas" class="border p-2 rounded min-w-min">
        <option value="">Semua Kelas</option>
      </select>
      
      <select id="filterMataKuliah" class="border p-2 rounded min-w-min">
        <option value="">Memuat Mata Kuliah...</option>
      </select>
      
      <select id="filterDosen" class="border p-2 rounded min-w-min">
        <option value="">Memuat Dosen...</option>
      </select>
      
       <select id="filterTahunAkademik" class="border p-2 rounded min-w-min">
        <option value="">Semua Tahun Akademik</option>
      </select>
      
      <button onclick="filterData()" class="bg-blue-500 text-white rounded icon-btn" title="Terapkan Filter (Pencarian)">
        <i class="fas fa-magnifying-glass"></i> 
      </button>
      <button onclick="exportExcel()" class="bg-green-500 text-white rounded icon-btn" title="Export ke Excel">
        <i class="fas fa-file-excel"></i>
      </button>
      <button onclick="exportPDF()" class="bg-red-500 text-white rounded icon-btn" title="Export ke PDF">
        <i class="fas fa-file-pdf"></i>
      </button>
      </div>
    <div class="overflow-x-auto">
      <table id="tabelJadwal" class="min-w-full border border-gray-400 text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="border px-2 py-1 text-center">No</th>
            <th class="border px-2 py-1 text-center">Tahun Akademik</th> <th class="border px-2 py-1 text-center">Kode</th>
            <th class="border px-2 py-1 text-left">Prodi</th>
            <th class="border px-2 py-1 text-center">Hari</th>
            <th class="border px-2 py-1 text-center">Jam Mulai</th>
            <th class="border px-2 py-1 text-center">Jam Akhir</th>
            <th class="border px-2 py-1 text-left">Mata Kuliah</th>
            <th class="border px-2 py-1 text-center">SKS</th>
            <th class="border px-2 py-1 text-left">Dosen</th>
            <th class="border px-2 py-1 text-left">Asisten</th>
            <th class="border px-2 py-1 text-center">Semester</th>
            <th class="border px-2 py-1 text-center">Kelas</th>
            <th class="border px-2 py-1 text-center">Ruangan</th>
            <th class="border px-2 py-1 text-center">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>


  <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
          <div class="p-6">
              <h2 class="text-xl font-bold mb-4">Edit Detail Jadwal</h2>
              <form id="editForm" onsubmit="return false;">
                  <input type="hidden" id="edit_id">
                  <div class="grid grid-cols-3 gap-3 mb-4">
                      
                      <select id="edit_kode_matkul_search" class="mt-1 block w-full border p-2 rounded">
                          <option value="" disabled selected>Cari Kode / Mata Kuliah</option>
                      </select>
                      
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Prodi</label>
                          <select id="edit_prodi" class="mt-1 block w-full border p-2 rounded">
                             <option value="Industri">Industri</option>
                             <option value="Sipil">Sipil</option>
                             <option value="Arsitektur">Arsitektur</option>
                             <option value="Elektro">Elektro</option>
                             <option value="Informatika">Informatika</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Hari</label>
                          <select id="edit_hari" class="mt-1 block w-full border p-2 rounded">
                              <option value="-">-</option><option value="Senin">Senin</option><option value="Selasa">Selasa</option><option value="Rabu">Rabu</option>
                              <option value="Kamis">Kamis</option><option value="Jumat">Jumat</option><option value="Sabtu">Sabtu</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Jam Mulai</label>
                          <input id="edit_jam_mulai" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Jam Akhir</label>
                          <input id="edit_jam_akhir" type="time" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">SKS</label>
                          <input id="edit_sks" type="number" class="mt-1 block w-full border p-2 rounded">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Dosen</label>
                          <select id="edit_dosen" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Asisten</label>
                          <select id="edit_asisten" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Semester</label>
                          <select id="edit_semester" class="mt-1 block w-full border p-2 rounded">
                              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                              <option value="7">7</option><option value="8">8</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Kelas</label>
                          <select id="edit_kelas" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700">Ruangan</label>
                          <select id="edit_ruangan" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                       <div>
                          <label class="block text-sm font-medium text-gray-700">Tahun Akademik</label> 
                          <select id="edit_tahun_akademik" class="mt-1 block w-full border p-2 rounded">
                              <option value="" disabled selected>Memuat...</option>
                          </select>
                      </div>
                  </div>

                  <div class="flex justify-end space-x-2 mt-4">
                      <button type="button" onclick="document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex');" class="bg-gray-500 text-white px-4 py-2 rounded">Batal</button>
                      <button type="button" onclick="updateJadwal()" class="bg-green-600 text-white px-4 py-2 rounded">Simpan Perubahan</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50">
  </div>
</div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.js"></script> 

<script>
    // --- Variabel Global TomSelect ---
    let tsMataKuliah;
    let tsEditMataKuliah;
    let tsFilterMataKuliah; 
    let tsFilterDosen; 
    let dosenOptions = [];   
    let asistenOptions = []; 
    
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        
        let baseClasses = "p-4 rounded-lg shadow-xl text-white transition-all duration-500 transform min-w-min";
        let icon = '';

        if (type === 'success') {
            baseClasses += " bg-green-500";
            icon = '✅';
        } else if (type === 'error') {
            baseClasses += " bg-red-600";
            icon = '❌';
        } else if (type === 'info') {
            baseClasses += " bg-blue-500";
            icon = 'ℹ️';
        } else if (type === 'warning') {
            baseClasses += " bg-yellow-500 text-gray-800";
            icon = '⚠️';
        }

        toast.className = baseClasses + " opacity-0 translate-y-2";
        toast.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
        
        container.appendChild(toast);

        // Show animation
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        // Auto-hide and remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                if(container.contains(toast)) {
                    container.removeChild(toast);
                }
            }, 500); 
        }, 3000); 
    }


    // --- Supabase setup ---
    const SUPABASE_URL = "https://bnslruddgegoeexbjwgr.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJuc2xydWRkZ2Vnb2VleGJqd2dyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4ODkyMTMsImV4cCI6MjA3NTQ2NTIxM30.V50LK0cosSOdZEpU96A5CM41vzapQJoB1MvJkPQE03o";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tabelBody = document.querySelector("#tabelJadwal tbody");
    let semuaData = []; 
    let dataYangDitampilkan = []; 
    let mataKuliahData = []; 

    // --- FUNGSI Memuat opsi pilihan (Disesuaikan untuk TomSelect) ---
    async function loadReferences() {
        // --- 1. Ambil dan Inisialisasi Mata Kuliah (TomSelect) ---
        const { data: mkData, error: mkError } = await supabaseClient
            .from('matakuliah')
            .select('kode, nama')
            .order('kode', { ascending: true }); 

        if (mkError) {
            console.error('Gagal memuat data Mata Kuliah:', mkError);
            showToast("Gagal memuat data Mata Kuliah", 'error'); 
        } else {
            mataKuliahData = mkData; 
            const tomSelectOptions = mkData.map(item => ({
                value: item.kode + ' | ' + item.nama, 
                text: item.kode + ' | ' + item.nama, 
                kode: item.kode,
                nama: item.nama
            }));

            // TomSelect untuk Form Tambah
            tsMataKuliah = new TomSelect('#kode_matkul_search', {
                valueField: 'value',
                labelField: 'text',
                searchField: ['kode', 'nama'], 
                options: tomSelectOptions,
                placeholder: 'Cari Kode atau Nama Mata Kuliah',
                render: {
                    option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`,
                    item: (data, escape) => `<div>${escape(data.text)}</div>`
                }
            });
            
             // TomSelect untuk Form Edit
            tsEditMataKuliah = new TomSelect('#edit_kode_matkul_search', {
                valueField: 'value',
                labelField: 'text',
                searchField: ['kode', 'nama'], 
                options: tomSelectOptions,
                placeholder: 'Cari Kode atau Nama Mata Kuliah',
                render: {
                    option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`,
                    item: (data, escape) => `<div>${escape(data.text)}</div>`
                }
            });
            
            // TomSelect untuk Filter Mata Kuliah
            const filterOptionsMk = [{ value: '', text: 'Semua Mata Kuliah', kode: '', nama: '' }, ...tomSelectOptions];
            
            tsFilterMataKuliah = new TomSelect('#filterMataKuliah', {
                valueField: 'value',
                labelField: 'text',
                searchField: ['kode', 'nama'], 
                options: filterOptionsMk,
                placeholder: 'Semua Mata Kuliah',
                render: {
                    option: (data, escape) => `<div><span class="font-bold">${escape(data.kode)}</span> | ${escape(data.nama)}</div>`,
                    item: (data, escape) => `<div>${escape(data.text)}</div>`
                },
                onInitialize: function() {
                    this.setValue(''); 
                }
            });
        }
        
        // --- 2. Ambil dan Inisialisasi Dosen, Asisten, Kelas, Ruangan, dll. ---
        const references = [
            // Dosen
            { table: 'dosen', elementId: 'dosen', editElementId: 'edit_dosen', column: 'nama', defaultText: 'Pilih Dosen', isFilter: true, filterElementId: 'filterDosen', filterDefaultText: 'Semua Dosen', isTomSelectFilter: true }, 
            // Asisten
            { table: 'asisten', elementId: 'asisten', editElementId: 'edit_asisten', column: 'nama', defaultText: 'Pilih Asisten' },
            // Kelas
            { table: 'kelas', elementId: 'kelas', editElementId: 'edit_kelas', column: 'nama', defaultText: 'Pilih Kelas', isFilter: true, filterElementId: 'filterKelas', filterDefaultText: 'Semua Kelas' },
            // Ruangan
            { table: 'ruangan', elementId: 'ruangan', editElementId: 'edit_ruangan', column: 'nama', defaultText: 'Pilih Ruangan' },
        ];
        
        const populateSelect = (elementId, dataArray, defaultText, isFilter = false) => {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return; 
            
            selectElement.innerHTML = `<option value="" ${isFilter ? '' : 'disabled selected'}>${defaultText}</option>`;
            
            dataArray.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });
        };

        for (const ref of references) {
            const { data, error } = await supabaseClient
                .from(ref.table)
                .select(ref.column)
                .order(ref.column, { ascending: true }); 

            if (error) {
                console.error(`Gagal memuat data ${ref.table}:`, error);
                continue;
            }

            const dataValues = data.map(item => item[ref.column]);
            
            // Simpan data dosen dan asisten secara global
            if (ref.table === 'dosen') dosenOptions = dataValues;
            if (ref.table === 'asisten') asistenOptions = dataValues;

            // Populasikan SELECT biasa untuk form tambah/edit
            populateSelect(ref.elementId, dataValues, ref.defaultText); 
            if (ref.editElementId) {
                populateSelect(ref.editElementId, dataValues, ref.defaultText);
            }

            // Populasikan dan inisialisasi TomSelect untuk filter Dosen
            if (ref.isFilter && ref.isTomSelectFilter) {
                const filterOptionsDosen = [{ value: '', text: 'Semua Dosen' }, ...dataValues.map(v => ({ value: v, text: v }))];
                
                tsFilterDosen = new TomSelect('#filterDosen', {
                    valueField: 'value',
                    labelField: 'text',
                    searchField: ['text'], 
                    options: filterOptionsDosen,
                    placeholder: 'Semua Dosen',
                    onInitialize: function() {
                        this.setValue(''); 
                    }
                });
            } else if (ref.isFilter) {
                // Untuk filter yang tetap menggunakan SELECT biasa (Prodi, Kelas, Semester)
                populateSelect(ref.filterElementId, dataValues, ref.filterDefaultText, true);
            }
        }
        
        // --- INISIALISASI TOM-SELECT UNTUK MODAL EDIT (Dosen & Asisten) ---
        new TomSelect("#edit_dosen", {
            create: true,
            sortField: { field: "text", direction: "asc" },
            options: dosenOptions.map(v => ({ value: v, text: v }))
        });

        new TomSelect("#edit_asisten", {
            create: true,
            sortField: { field: "text", direction: "asc" },
            options: asistenOptions.map(v => ({ value: v, text: v }))
        });

        // --- INISIALISASI TOM-SELECT UNTUK FORM TAMBAH (Dosen & Asisten) ---
        new TomSelect("#dosen", {
            create: true,
            sortField: { field: "text", direction: "asc" },
            options: dosenOptions.map(v => ({ value: v, text: v }))
        });

        new TomSelect("#asisten", {
            create: true,
            sortField: { field: "text", direction: "asc" },
            options: asistenOptions.map(v => ({ value: v, text: v }))
        });
        
        // --- 3. Isi Tahun Akademik ---
        const tahunAkademikOptions = [
            '2025/2026 Ganjil', '2024/2025 Genap', '2024/2025 Ganjil', 
            '2023/2024 Genap', '2023/2024 Ganjil', '2022/2023 Genap', '2022/2023 Ganjil'
        ].sort((a, b) => b.localeCompare(a)); 

        const taDefaultText = 'Pilih Tahun Akademik';
        const taFilterDefaultText = 'Semua Tahun Akademik';

        populateSelect('tahun_akademik', tahunAkademikOptions, taDefaultText); 
        populateSelect('edit_tahun_akademik', tahunAkademikOptions, taDefaultText);
        populateSelect('filterTahunAkademik', tahunAkademikOptions, taFilterDefaultText, true);
    }


    // --- Cek login user ---
    window.onload = async () => {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      if (!user) {
        alert("Silakan login dulu!"); 
        window.location.href = "index.html";
        return;
      }
      await loadReferences(); 
      loadData();
    };

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    // --- Ambil data jadwal & inisialisasi dataYangDitampilkan ---
    async function loadData() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;
      const { data, error } = await supabaseClient
        .from("jadwal")
        .select("*")
        .eq("user_id", user.id)
        .order("id", { ascending: true });

      if (error) {
        console.error(error);
        showToast("Gagal memuat data jadwal", 'error'); 
        return;
      }
      semuaData = data;
      tampilkanData(semuaData);
    }

    // --- Tampilkan Data ---
    function tampilkanData(data) {
      dataYangDitampilkan = data; 
      
      tabelBody.innerHTML = "";
      data.forEach((row, index) => {
        const prodiClass = row.prodi ? `row-${row.prodi.replace(/\s/g, '')}` : ''; 
        const tr = document.createElement("tr");
        tr.classList.add("border-b", prodiClass);
        tr.innerHTML = `
          <td class="border px-2 py-1 text-center">${index + 1}</td>
          <td class="border px-2 py-1 text-center">${row.tahun_akademik || "-"}</td> 
          <td class="border px-2 py-1 text-center">${row.kode_matkul || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.prodi || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.hari || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.jam_mulai || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.jam_akhir || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.mata_kuliah || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.sks || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.dosen || "-"}</td>
          <td class="border px-2 py-1 text-left">${row.asisten || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.semester || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.kelas || "-"}</td>
          <td class="border px-2 py-1 text-center">${row.ruangan || "-"}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick="editJadwal(${row.id})" class="bg-yellow-400 px-2 py-1 rounded text-gray-800">Edit</button>
            <button onclick="hapusJadwal(${row.id})" class="bg-red-500 text-white px-2 py-1 rounded ml-1">Hapus</button>
          </td>
        `;
        tabelBody.appendChild(tr);
      });
    }

    // --- Tambah Jadwal ---
    async function simpanJadwal() {
      const { data: userData } = await supabaseClient.auth.getUser();
      const user = userData.user;

      if (!user) {
        showToast("Kamu belum login!", 'error'); 
        window.location.href = "index.html";
        return;
      }
      
      // Ambil nilai dari TomSelect Mata Kuliah
      const mkValue = tsMataKuliah.getValue();
      
      if (!mkValue) {
          showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning');
          return;
      }
      
      const [kode, nama] = mkValue.split(' | ').map(s => s.trim());
      
      const prodi = document.getElementById("prodi").value;
      const hari = document.getElementById("hari").value;
      
      // AMBIL NILAI DARI TOMSELECT Dosen & Asisten
      const dosen = document.getElementById("dosen").tomselect.getValue(); 
      const asisten = document.getElementById("asisten").tomselect.getValue();
      
      const semester = document.getElementById("semester").value;
      const kelas = document.getElementById("kelas").value;
      const ruangan = document.getElementById("ruangan").value;
      const sks = document.getElementById("sks").value;
      const tahun_akademik = document.getElementById("tahun_akademik").value; 

      if (!prodi || !hari || !semester || !dosen || !kelas || !ruangan || !sks || !tahun_akademik) {
        showToast("Semua kolom wajib diisi!", 'warning'); 
        return;
      }

      const jadwal = {
        user_id: user.id, 
        kode_matkul: kode, 
        mata_kuliah: nama, 
        prodi: prodi,
        hari: hari,
        jam_mulai: document.getElementById("jam_mulai").value,
        jam_akhir: document.getElementById("jam_akhir").value,
        sks: parseInt(sks), 
        dosen: dosen,
        asisten: asisten || "-", // Asisten bisa kosong
        semester: parseInt(semester),
        kelas: kelas,
        ruangan: ruangan,
        tahun_akademik: tahun_akademik
      };

      // Cek apakah ada duplikasi jadwal
      const isConflict = semuaData.some(item => {
        // Logika sederhana: hari, ruangan, dan jam yang sama
        if (item.hari === jadwal.hari && item.ruangan === jadwal.ruangan) {
            // Cek jika jam berpotongan
            const start1 = jadwal.jam_mulai;
            const end1 = jadwal.jam_akhir;
            const start2 = item.jam_mulai;
            const end2 = item.jam_akhir;

            // Jika (Start1 < End2) AND (End1 > Start2) maka ada konflik
            if (start1 < end2 && end1 > start2) {
                return true; 
            }
        }
        return false;
      });

      if (isConflict) {
         showToast("Konflik Jadwal! Ruangan sudah terisi pada waktu yang sama.", 'error');
         return; 
      }
      
      const { data, error } = await supabaseClient
        .from("jadwal")
        .insert([jadwal]);

      if (error) {
        console.error("Gagal menyimpan jadwal:", error);
        showToast("Gagal menyimpan jadwal", 'error'); 
        return;
      }
      
      showToast("Jadwal berhasil ditambahkan!", 'success'); 
      
      // Kosongkan form
      tsMataKuliah.setValue('');
      document.getElementById("prodi").value = "";
      document.getElementById("hari").value = "";
      document.getElementById("jam_mulai").value = "";
      document.getElementById("jam_akhir").value = "";
      document.getElementById("sks").value = "";
      document.getElementById("dosen").tomselect.setValue("");
      document.getElementById("asisten").tomselect.setValue("");
      document.getElementById("semester").value = "";
      document.getElementById("kelas").value = "";
      document.getElementById("ruangan").value = "";
      document.getElementById("tahun_akademik").value = ""; 
      
      loadData(); // Muat ulang data untuk menampilkan yang baru
    }

    // --- Hapus Jadwal ---
    async function hapusJadwal(id) {
      if (!confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
        return;
      }
      
      const { error } = await supabaseClient
        .from("jadwal")
        .delete()
        .eq("id", id);

      if (error) {
        console.error("Gagal menghapus jadwal:", error);
        showToast("Gagal menghapus jadwal", 'error'); 
        return;
      }

      showToast("Jadwal berhasil dihapus!", 'success'); 
      loadData();
    }
    
    // --- Edit Jadwal (Mengisi Modal) ---
    async function editJadwal(id) {
      const dataToEdit = semuaData.find(d => d.id === id);
      if (!dataToEdit) return;

      document.getElementById("edit_id").value = id;
      
      // Mengisi TomSelect Mata Kuliah
      const mkValue = dataToEdit.kode_matkul + ' | ' + dataToEdit.mata_kuliah;
      tsEditMataKuliah.setValue(mkValue);
      
      document.getElementById("edit_prodi").value = dataToEdit.prodi;
      document.getElementById("edit_hari").value = dataToEdit.hari;
      document.getElementById("edit_jam_mulai").value = dataToEdit.jam_mulai;
      document.getElementById("edit_jam_akhir").value = dataToEdit.jam_akhir;
      document.getElementById("edit_sks").value = dataToEdit.sks;
      
      // Mengisi TomSelect Dosen & Asisten
      document.getElementById("edit_dosen").tomselect.setValue(dataToEdit.dosen || '');
      document.getElementById("edit_asisten").tomselect.setValue(dataToEdit.asisten || '');
      
      document.getElementById("edit_semester").value = dataToEdit.semester;
      document.getElementById("edit_kelas").value = dataToEdit.kelas;
      document.getElementById("edit_ruangan").value = dataToEdit.ruangan;
      document.getElementById("edit_tahun_akademik").value = dataToEdit.tahun_akademik; 

      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editModal').classList.add('flex');
    }

    // --- Update Jadwal (Simpan Perubahan dari Modal) ---
    async function updateJadwal() {
        const id = document.getElementById("edit_id").value;

        const mkValue = tsEditMataKuliah.getValue();
        if (!mkValue) {
            showToast("Pilih Kode/Mata Kuliah terlebih dahulu!", 'warning');
            return;
        }
        const [kode, nama] = mkValue.split(' | ').map(s => s.trim());
        
        const updatedJadwal = {
            kode_matkul: kode, 
            mata_kuliah: nama, 
            prodi: document.getElementById("edit_prodi").value,
            hari: document.getElementById("edit_hari").value,
            jam_mulai: document.getElementById("edit_jam_mulai").value,
            jam_akhir: document.getElementById("edit_jam_akhir").value,
            sks: parseInt(document.getElementById("edit_sks").value),
            dosen: document.getElementById("edit_dosen").tomselect.getValue(), 
            asisten: document.getElementById("edit_asisten").tomselect.getValue() || "-",
            semester: parseInt(document.getElementById("edit_semester").value),
            kelas: document.getElementById("edit_kelas").value,
            ruangan: document.getElementById("edit_ruangan").value,
            tahun_akademik: document.getElementById("edit_tahun_akademik").value
        };

        // Cek Konflik (dengan mengecualikan data yang sedang di-edit)
        const isConflict = semuaData.some(item => {
            if (item.id === parseInt(id)) return false; // Abaikan data saat ini
            
            if (item.hari === updatedJadwal.hari && item.ruangan === updatedJadwal.ruangan) {
                const start1 = updatedJadwal.jam_mulai;
                const end1 = updatedJadwal.jam_akhir;
                const start2 = item.jam_mulai;
                const end2 = item.jam_akhir;

                if (start1 < end2 && end1 > start2) {
                    return true; 
                }
            }
            return false;
        });

        if (isConflict) {
            showToast("Konflik Jadwal! Ruangan sudah terisi pada waktu yang sama.", 'error');
            return; 
        }

        const { error } = await supabaseClient
            .from('jadwal')
            .update(updatedJadwal)
            .eq('id', id);

        if (error) {
            console.error("Gagal mengupdate jadwal:", error);
            showToast("Gagal menyimpan perubahan", 'error'); 
            return;
        }

        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editModal').classList.remove('flex');
        showToast("Jadwal berhasil diperbarui!", 'success'); 
        loadData();
    }
    
    // --- Filter Data ---
    function filterData() {
        const prodi = document.getElementById('filterProdi').value;
        const semester = document.getElementById('filterSemester').value;
        const kelas = document.getElementById('filterKelas').value;
        const mkValue = tsFilterMataKuliah.getValue(); 
        const dosen = tsFilterDosen.getValue();
        const tahun_akademik = document.getElementById('filterTahunAkademik').value;

        const filtered = semuaData.filter(item => {
            let passes = true;
            
            if (prodi && item.prodi !== prodi) passes = false;
            if (semester && item.semester !== parseInt(semester)) passes = false;
            if (kelas && item.kelas !== kelas) passes = false;
            if (tahun_akademik && item.tahun_akademik !== tahun_akademik) passes = false;
            
            // Filter Mata Kuliah
            if (mkValue) {
                const [kode, nama] = mkValue.split(' | ').map(s => s.trim());
                if (item.kode_matkul !== kode) passes = false;
            }
            
            // Filter Dosen
            if (dosen && item.dosen !== dosen) passes = false;

            return passes;
        });

        tampilkanData(filtered);
        showToast(`Menampilkan ${filtered.length} hasil.`, 'info');
    }

    // --- Export ke Excel ---
    function exportExcel() {
        if (dataYangDitampilkan.length === 0) {
            showToast("Tidak ada data untuk diekspor!", 'warning');
            return;
        }
        
        // Buat data ekspor, hapus kolom 'user_id'
        const exportData = dataYangDitampilkan.map(({ user_id, ...rest }) => rest);

        // Ubah nama kolom (header)
        const headers = [
            "id", "Tahun Akademik", "Kode", "Prodi", "Hari", "Jam Mulai", "Jam Akhir", 
            "Mata Kuliah", "SKS", "Dosen", "Asisten", "Semester", "Kelas", "Ruangan"
        ];
        
        const dataForSheet = exportData.map(item => [
            item.id,
            item.tahun_akademik,
            item.kode_matkul,
            item.prodi,
            item.hari,
            item.jam_mulai,
            item.jam_akhir,
            item.mata_kuliah,
            item.sks,
            item.dosen,
            item.asisten,
            item.semester,
            item.kelas,
            item.ruangan
        ]);
        
        dataForSheet.unshift(headers); // Tambahkan header di baris pertama

        const ws = XLSX.utils.aoa_to_sheet(dataForSheet);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "JadwalKuliah");

        const fileName = `JadwalKuliah_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        showToast("Data berhasil diekspor ke Excel!", 'success');
    }
    
    // --- Export ke PDF ---
    function exportPDF() {
        if (dataYangDitampilkan.length === 0) {
            showToast("Tidak ada data untuk diekspor!", 'warning');
            return;
        }
        
        // Buat instance jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape'); 
        
        // Persiapan data
        const columns = [
             { header: 'No', dataKey: 'no' },
             { header: 'TA', dataKey: 'tahun_akademik' },
             { header: 'Kode', dataKey: 'kode_matkul' },
             { header: 'Prodi', dataKey: 'prodi' },
             { header: 'Hari', dataKey: 'hari' },
             { header: 'Mulai', dataKey: 'jam_mulai' },
             { header: 'Akhir', dataKey: 'jam_akhir' },
             { header: 'Mata Kuliah', dataKey: 'mata_kuliah' },
             { header: 'SKS', dataKey: 'sks' },
             { header: 'Dosen', dataKey: 'dosen' },
             { header: 'Sem', dataKey: 'semester' },
             { header: 'Kelas', dataKey: 'kelas' },
             { header: 'Ruangan', dataKey: 'ruangan' },
        ];
        
        const rows = dataYangDitampilkan.map((item, index) => ({
            no: index + 1,
            tahun_akademik: item.tahun_akademik,
            kode_matkul: item.kode_matkul,
            prodi: item.prodi,
            hari: item.hari,
            jam_mulai: item.jam_mulai,
            jam_akhir: item.jam_akhir,
            mata_kuliah: item.mata_kuliah,
            sks: item.sks,
            dosen: item.dosen,
            semester: item.semester,
            kelas: item.kelas,
            ruangan: item.ruangan
        }));

        // Judul
        doc.setFontSize(14);
        doc.text("Daftar Jadwal Kuliah", 148.5, 15, null, null, "center");
        
        // Gunakan autoTable
        doc.autoTable({
            startY: 20, 
            head: [columns.map(c => c.header)], 
            body: rows.map(r => columns.map(c => r[c.dataKey])),
            theme: 'striped',
            headStyles: { fillColor: [30, 144, 255] },
            styles: { fontSize: 8, cellPadding: 1.5 },
            columnStyles: {
                 0: { cellWidth: 8 }, // No
                 1: { cellWidth: 22 }, // TA
                 5: { cellWidth: 15 }, // Mulai
                 6: { cellWidth: 15 }, // Akhir
                 7: { cellWidth: 40 }, // Mata Kuliah
                 9: { cellWidth: 35 }, // Dosen
                 10: { cellWidth: 10 }, // Sem
            },
        });

        // Simpan file
        const fileName = `JadwalKuliah_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(fileName);
        showToast("Data berhasil diekspor ke PDF!", 'success');
    }
    
  </script>
</body>
</html>
